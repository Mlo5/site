<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ† - M L O 5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-dark:#020202;
      --yellow:#facc15;
      --white:#f9fafb;
      --muted:#9ca3af;
      --border-subtle:rgba(156,163,175,.35);
      --shadow:0 18px 45px rgba(0,0,0,.95), 0 0 0 1px rgba(0,0,0,.95);
      --grid-x:0px; --grid-y:0px;
      --vh: 1vh;
      --heart:#ef4444;
      --green:#22c55e;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg-dark);
      color:var(--white);
      min-height: calc(var(--vh, 1vh) * 100);
      position:relative;
      overflow:hidden;
      cursor:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><polygon points='2,2 2,22 8,16 14,26 18,24 12,14 20,14' fill='%23facc15' stroke='%23000000' stroke-width='1.5'/></svg>") 0 0, auto;
    }
    .bg-grid{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background-image:radial-gradient(circle, rgba(249,250,251,.55) 1px, transparent 1px);
      background-size:30px 30px;
      background-position:calc(50% + var(--grid-x)) calc(50% + var(--grid-y));
      opacity:.25; mix-blend-mode:screen;
    }
    .page{
      width:100%;
      max-width:1100px;
      padding:32px 16px 40px;
      margin:auto;
      position:relative;
      z-index:1;
      min-height:0;
    }
    .card{
      background:linear-gradient(145deg,#020202,#050505);
      border-radius:18px;
      padding:14px;
      border:1px solid var(--border-subtle);
      box-shadow:0 12px 30px rgba(0,0,0,.8),0 0 0 1px rgba(55,65,81,.6);
      position:relative;
      overflow:hidden;
      min-height:0;
    }
    .top-bar{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-bottom:14px; direction:ltr;
    }
    .top-chip{
      font-size:.9rem; color:var(--white);
      padding:6px 14px; border-radius:999px;
      border:1px solid rgba(250,204,21,.6);
      background:rgba(0,0,0,.6);
      box-shadow:0 8px 20px rgba(0,0,0,.8),0 0 0 1px rgba(15,23,42,.9);
      display:inline-flex; align-items:center; gap:8px;
      user-select:none; cursor:pointer;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(239,68,68,.9)}
    .dot.on{background:rgba(34,197,94,.95)}
    .title{
      font-family:"Poppins",system-ui,sans-serif;
      font-weight:800; letter-spacing:.12em;
      text-transform:uppercase; white-space:nowrap;
    }
    .title small{letter-spacing:0;font-weight:700;color:var(--muted)}
    .wrap{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:14px;
      height: calc(var(--vh, 1vh) * 100 - 32px - 40px - 14px - 44px);
      min-height:0;
    }
    @media (max-width: 980px){
      body{overflow:hidden}
      .page{padding:16px 12px 18px}
      .wrap{grid-template-columns:1fr; height:calc(var(--vh, 1vh) * 100 - 90px)}
    }

    .panel-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    .panel-head .h{display:flex;flex-direction:column;gap:2px}
    .panel-head .h b{color:var(--yellow);font-size:1rem}
    .panel-head .h span{color:var(--muted);font-size:.85rem;line-height:1.6}
    .badge{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.55);
      padding:6px 10px;
      font-size:.85rem;
      background:rgba(0,0,0,.45);
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }

    .composer{
      display:flex; flex-direction:column; gap:10px;
    }
    textarea, input, select{
      width:100%;
      border-radius:18px;
      border:1px solid rgba(250,204,21,.55);
      background:#000;
      color:var(--white);
      padding:12px 12px;
      outline:none;
      font-size:1rem;
      resize:none;
    }
    textarea{min-height:130px; line-height:1.7}
    .rowBtns{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start;
    }
    .btn{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      padding:10px 14px;
      cursor:pointer;
      font-weight:900;
      user-select:none;
      height:42px;
      display:inline-flex;align-items:center;justify-content:center;
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .posts{
      display:flex; flex-direction:column; gap:12px;
      overflow:auto; min-height:0; flex:1; padding-right:4px;
      scrollbar-width:none; -ms-overflow-style:none;
      -webkit-overflow-scrolling: touch;
    }
    .posts::-webkit-scrollbar{width:0;height:0}

    .post{
      border-radius:18px;
      border:1px solid var(--border-subtle);
      background:rgba(0,0,0,.55);
      box-shadow:0 10px 22px rgba(0,0,0,.6);
      padding:12px;
      position:relative;
    }
    .postHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
      color:var(--muted);
      font-size:.9rem;
      direction:ltr;
    }
    .postHead .who{
      display:inline-flex; align-items:center; gap:8px;
      direction:rtl;
      font-weight:900;
      color:var(--white);
    }
    .postHead .who span.name{
      color:var(--yellow);
      max-width:220px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
      display:inline-block;
    }

    /* âœ… Ø³ØªØ§ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø«Ù„ Ø§Ù„Ø´Ø§Øª */
    .adminNameWrap{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#000;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(250,204,21,.35);
    }
    .adminNameText{
      color:#fff !important;
      font-weight:900;
      font-size:1.05rem;
      white-space:nowrap;
    }
    .adminSkull{
      display:inline-block;
      animation: skullBlink 1.2s infinite;
    }
    @keyframes skullBlink{
      0%{opacity:1}
      50%{opacity:.2}
      100%{opacity:1}
    }

    .postBody{
      line-height:1.9;
      white-space:pre-wrap;
      word-break:break-word;
      color:var(--white);
      margin-bottom:10px;
    }
    .postActions{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .miniBtn{
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.45);
      color:var(--yellow);
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      font-weight:900;
      user-select:none;
      display:inline-flex;align-items:center;gap:8px;
      height:38px;
    }
    .miniBtn.liked{
      border-color:rgba(34,197,94,.85);
      color:rgba(34,197,94,.95);
    }

    /* âœ… Ù„Ø§ÙŠÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¨Ù‚Ù„Ø¨ Ø£Ø­Ù…Ø± */
    .miniBtn.hearted{
      border-color:rgba(239,68,68,.85);
      color:rgba(239,68,68,.95);
    }

    .countPill{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      padding:6px 10px;
      font-size:.85rem;
      background:rgba(0,0,0,.35);
      color:var(--muted);
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
      height:38px;
    }

    .commentsWrap{
      margin-top:10px;
      border-top:1px dashed rgba(250,204,21,.25);
      padding-top:10px;
      display:none;
      gap:10px;
      flex-direction:column;
    }
    .commentRow{
      border:1px solid rgba(156,163,175,.28);
      background:rgba(0,0,0,.35);
      border-radius:16px;
      padding:10px;
      line-height:1.7;
    }
    .commentMeta{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size:.85rem;
      color:var(--muted);
      margin-bottom:6px;
      direction:ltr;
    }
    .commentMeta .who{direction:rtl; font-weight:900; color:var(--white); display:flex; align-items:center; gap:8px; min-width:0}
    .commentMeta .who .name{color:var(--yellow); max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .commentText{white-space:pre-wrap; word-break:break-word}

    .replyQuote{
      border:1px solid rgba(250,204,21,.25);
      background:rgba(0,0,0,.45);
      border-radius:14px;
      padding:8px 10px;
      margin-bottom:8px;
    }
    .replyQuote b{color:var(--yellow);font-size:.85rem}
    .replyQuote div{color:var(--muted);font-size:.85rem;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .replyPreview{
      border:1px solid rgba(250,204,21,.35);
      border-radius:14px;
      background:rgba(0,0,0,.45);
      padding:8px 10px;
      display:none;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .replyPreview b{color:var(--yellow);font-size:.9rem}
    .replyPreview span{color:var(--muted);font-size:.85rem;line-height:1.5}
    .replyCancel{
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      border-radius:999px;
      width:34px;height:34px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      user-select:none;
      flex:0 0 auto;
    }

    /* Modal (Ø²ÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©) */
    #modal{
      position:fixed; inset:0; z-index:999;
      background:rgba(0,0,0,.75);
      display:none; align-items:center; justify-content:center;
      padding:16px;
    }
    #modalBox{
      width:min(860px,96vw);
      border-radius:18px;
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.92);
      box-shadow:0 18px 45px rgba(0,0,0,.95),0 0 0 1px rgba(17,24,39,.9);
      padding:14px;
      backdrop-filter:blur(10px);
      position:relative;
    }
    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 900px){ .modalGrid{grid-template-columns:1fr} }

    .modalCard{
      border:1px solid rgba(250,204,21,.35);
      border-radius:16px;
      background:rgba(0,0,0,.45);
      padding:12px;
      position:relative;
    }
    .modalCard h3{margin-bottom:8px;color:var(--yellow);text-align:center;font-weight:900}
    .modalCard p{color:var(--muted);text-align:center;font-size:.9rem;margin-bottom:12px;line-height:1.7}

    .choiceRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
    .choiceBtn{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      padding:10px 14px;
      cursor:pointer;
      font-weight:900;
      flex:1;
      min-width:180px;
      height:44px;
    }

    .modalRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .modalRow.one{grid-template-columns:1fr}
    .modalBtn{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      padding:10px 14px;
      cursor:pointer;
      font-weight:900;
      height:44px;
    }
    .hintErr{margin-top:8px;color:rgba(239,68,68,.95);font-size:.85rem;text-align:center;display:none}

    .homeBackBtn{
      position:absolute;
      top:10px;
      left:10px;
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      width:40px;height:40px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      user-select:none;
    }
    .backListBtn{
      position:absolute;
      top:10px;
      left:58px;
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      width:40px;height:40px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      user-select:none;
    }
  </style>
</head>

<body>
  <div class="bg-grid"></div>

  <main class="page">
    <div class="top-bar">
      <div class="top-chip" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„">
        <span class="dot" id="connDot"></span>
        <span id="connText">ØºÙŠØ± Ù…ØªØµÙ„</span>
      </div>

      <div class="title">M L O 5 <small>â€¢ Followers Forum</small></div>

      <button class="top-chip" id="exitBtn" type="button" title="Ø®Ø±ÙˆØ¬">â†© Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="wrap">
      <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: Ø§Ù„Ø¨ÙˆØ³ØªØ§Øª -->
      <section class="card" style="display:flex;flex-direction:column;min-height:0;">
        <div class="panel-head">
          <div class="h">
            <b>Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†</b>
            <span>Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒâ€¦ Ø®Ù„Ù‘ÙŠ Ø§Ù„Ø´Ø¨Ø§Ø¨ <span style="color:#facc15;font-weight:900">ØªØ³ØªÙØ§Ø¯</span></span>
          </div>
          <div class="badge" id="meBadge">Ø£Ù†Øª: â€”</div>
        </div>

        <div class="posts" id="postsList"></div>
      </section>

      <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ: Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØ³Øª -->
      <aside class="card" style="display:flex;flex-direction:column;gap:12px;min-height:0;">
        <div class="panel-head">
          <div class="h">
            <b>Ø§Ù†Ø´Ø± Ø¨ÙˆØ³Øª</b>
            <span>Ø¨Ø¯ÙˆÙ† ØµÙˆØ± (Ù…Ø¬Ø§Ù†Ù‹Ø§)</span>
            <span style="margin-top:6px;color:var(--muted)">( Ù…ÙØ§ ÙŠÙÙ„Ù’ÙÙØ¸Ù Ù…ÙÙ†Ù’ Ù‚ÙÙˆÙ’Ù„Ù Ø¥ÙÙ„Ø§ Ù„ÙØ¯ÙÙŠÙ’Ù‡Ù Ø±ÙÙ‚ÙÙŠØ¨ÙŒ Ø¹ÙØªÙÙŠØ¯ÙŒ )</span>
          </div>
          <div class="badge" id="postsCount">0 Ø¨ÙˆØ³Øª</div>
        </div>

        <div class="composer">
          <textarea id="postText" placeholder="Ø§ÙƒØªØ¨ Ù…Ù†Ø´ÙˆØ±Ùƒ Ù‡Ù†Ø§..." maxlength="1500" disabled></textarea>

          <div class="rowBtns">
            <button class="btn" id="publishBtn" type="button" disabled>ğŸš€ Ù†Ø´Ø±</button>
            <button class="btn" id="refreshBtn" type="button">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
          </div>

          <div class="hintErr" id="postErr"></div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Modal Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø²ÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©) -->
  <div id="modal">
    <div id="modalBox">
      <div class="modalGrid">
        <div class="modalCard">
          <button class="homeBackBtn" id="homeBtn" type="button" title="Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‡ÙˆÙ…">ğŸ </button>
          <button class="backListBtn" id="backListBtn" type="button" title="Ø±Ø¬ÙˆØ¹">â†©</button>

          <h3>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¯Ù‰</h3>
          <p>Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø¯Ø®ÙˆÙ„ ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ø§Ø³Ù…Ùƒâ€¦ Ø¹Ø´Ø§Ù† Ø£ÙŠ Ø¨ÙˆØ³Øª ÙŠÙ†Ø²Ù„ Ø¨Ø§Ø³Ù…Ùƒ.</p>

          <div class="choiceRow">
            <button class="choiceBtn" id="chooseLogin" type="button">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
            <button class="choiceBtn" id="chooseGuest" type="button">ğŸ‘¤ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ</button>
          </div>

          <div id="formBox" style="display:none;">
            <div class="modalRow one">
              <input id="nameInput" placeholder="Ø§Ø³Ù…Ùƒ (3+)" />
            </div>

            <div class="modalRow">
              <select id="genderInput">
                <option value="">Ø§Ù„Ø¬Ù†Ø³</option>
                <option value="male">Ø°ÙƒØ± â™‚ï¸</option>
                <option value="female">Ø£Ù†Ø«Ù‰ â™€ï¸</option>
              </select>
              <input id="ageInput" type="number" min="10" max="99" placeholder="Ø§Ù„Ø¹Ù…Ø± (10+)" />
            </div>

            <button id="enterBtn" class="modalBtn" type="button">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¯Ù‰</button>
          </div>

          <div class="hintErr" id="modalErr"></div>
        </div>

        <div class="modalCard">
          <h3>Ù…Ù„Ø§Ø­Ø¸Ø©</h3>
          <p>Ø§Ù„Ù…Ù†ØªØ¯Ù‰ ÙŠØ´ØªØºÙ„ Ø¹Ù„Ù‰ Ù†ÙØ³ Firebase ØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ÙŠØ®Ø±Ø¨ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.</p>
          <div class="badge" style="justify-content:center">ğŸ”¥ Ù†ÙØ³ Ø§Ù„Ø³ØªØ§ÙŠÙ„â€¦ Ù†ÙØ³ Ø§Ù„Ù‡ÙˆÙŠØ©</div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    query, orderBy, onSnapshot, doc, updateDoc,
    arrayUnion, arrayRemove
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBnxruqFdBHEHTSVXl-QK848lsGvwBBH9U",
    authDomain: "mlo5-users.firebaseapp.com",
    databaseURL: "https://mlo5-users-default-rtdb.firebaseio.com",
    projectId: "mlo5-users",
    appId: "1:142086858806:web:64c50f3a8d6250a2049097"
  };

  // âœ… Ù†ÙØ³ UID ØªØ¨Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø§Ù„Ø´Ø§Øª
  const ADMIN_UIDS = ["VFjSs6kH2jcFJnddE7SXIpipzDi2"];

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const rtdb = getDatabase(app);

  // UI
  const connDot = document.getElementById("connDot");
  const connText = document.getElementById("connText");
  const exitBtn = document.getElementById("exitBtn");
  const homeBtn = document.getElementById("homeBtn");
  const backListBtn = document.getElementById("backListBtn");

  const meBadge = document.getElementById("meBadge");
  const postsCount = document.getElementById("postsCount");
  const postsList = document.getElementById("postsList");

  const postText = document.getElementById("postText");
  const publishBtn = document.getElementById("publishBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const postErr = document.getElementById("postErr");

  const modal = document.getElementById("modal");
  const modalErr = document.getElementById("modalErr");
  const formBox = document.getElementById("formBox");
  const chooseLogin = document.getElementById("chooseLogin");
  const chooseGuest = document.getElementById("chooseGuest");
  const enterBtn = document.getElementById("enterBtn");
  const nameInput = document.getElementById("nameInput");
  const genderInput = document.getElementById("genderInput");
  const ageInput = document.getElementById("ageInput");

  function setVh(){
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty("--vh", `${vh}px`);
  }
  setVh();
  window.addEventListener("resize", setVh);
  window.addEventListener("orientationchange", setVh);

  const root = document.documentElement;
  document.addEventListener("mousemove", (e)=>{
    const xRatio = e.clientX / window.innerWidth - 0.5;
    const yRatio = e.clientY / window.innerHeight - 0.5;
    const maxShift = 40;
    root.style.setProperty("--grid-x", (xRatio * maxShift).toFixed(1) + "px");
    root.style.setProperty("--grid-y", (yRatio * maxShift).toFixed(1) + "px");
  });

  function setErr(el, msg){
    el.style.display = msg ? "block" : "none";
    el.textContent = msg || "";
  }
  function collapseSpaces(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function escapeHtml(s=""){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }
  function formatTime(tsMs){
    if (!tsMs || Number.isNaN(tsMs)) return "";
    const d = new Date(tsMs);
    let h = d.getHours();
    const m = String(d.getMinutes()).padStart(2,"0");
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if (h === 0) h = 12;
    return `${h}:${m} ${ampm}`;
  }

  const BAD_WORDS = ["fuck","shit","bitch","asshole","ÙƒØ³","Ø²Ø¨","Ø´Ø±Ù…ÙˆØ·","Ù‚Ø­Ø¨Ù‡","Ù…Ù†ÙŠÙƒ","Ø®ÙˆÙ„","Ø·ÙŠØ²"];
  function isProfane(text){
    const t = String(text||"").toLowerCase();
    return BAD_WORDS.some(w => t.includes(w));
  }

  // âœ… Ø³ØªØ§ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø«Ù„ Ø§Ù„Ø´Ø§Øª
  function adminNameHtml(){
    return `
      <span class="adminNameWrap">
        <span class="adminNameText">ğ•„ğ•ƒğ•†ğŸ ãƒ…</span>
        <span class="adminSkull">ğŸ’€</span>
      </span>
    `;
  }
  function nameHtmlFor(uid, name){
    const isAdminUser = ADMIN_UIDS.includes(uid);
    return isAdminUser ? adminNameHtml() : `<span class="name">${escapeHtml(name || "Ù…Ø³ØªØ®Ø¯Ù…")}</span>`;
  }

  // Session
  let user = null;
  let profile = null;

  const profKey = (uid) => `followersProfile_${uid}`;

  function showForm(){ formBox.style.display = "block"; }
  function hideForm(){ formBox.style.display = "none"; }

  function watchConnection(){
    const connRef = ref(rtdb, ".info/connected");
    onValue(connRef, (snap)=>{
      const connected = snap.val() === true;
      connDot.classList.toggle("on", connected);
      connText.textContent = connected ? "Ù…ØªØµÙ„" : "ØºÙŠØ± Ù…ØªØµÙ„";
    });
  }

  // Auth flow
  chooseLogin.addEventListener("click", ()=>{
    setErr(modalErr,"");
    if (!user || user.isAnonymous){
      location.href = "login.html";
      return;
    }
    showForm();
  });

  chooseGuest.addEventListener("click", async ()=>{
    setErr(modalErr,"");
    try{
      if (!user) await signInAnonymously(auth);
      showForm();
    }catch(err){
      console.error(err);
      setErr(modalErr, "âŒ ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.");
    }
  });

  backListBtn.addEventListener("click", ()=>{
    setErr(modalErr,"");
    hideForm();
  });

  homeBtn.addEventListener("click", ()=>{
    location.href = "index.html";
  });

  enterBtn.addEventListener("click", async ()=>{
    setErr(modalErr,"");
    const rawName = collapseSpaces(nameInput.value);
    const g = genderInput.value;
    const age = Number(ageInput.value);

    if (!rawName || rawName.length < 3){ setErr(modalErr, "Ø§Ù„Ø§Ø³Ù… Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; }
    if (!g){ setErr(modalErr, "Ø§Ø®ØªØ§Ø± Ø§Ù„Ø¬Ù†Ø³."); return; }
    if (!Number.isFinite(age) || age < 10){ setErr(modalErr, "Ø§Ù„Ø¹Ù…Ø± Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 10 Ø£Ùˆ Ø£ÙƒØ«Ø±."); return; }
    if (!user){ setErr(modalErr, "Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹."); return; }

    profile = { name: rawName, gender: g, age };

    if (!user.isAnonymous){
      localStorage.setItem(profKey(user.uid), JSON.stringify(profile));
    }

    await enterForum();
  });

  async function enterForum(){
    modal.style.display = "none";

    const meIsAdmin = user && ADMIN_UIDS.includes(user.uid);
    meBadge.innerHTML = `Ø£Ù†Øª: ${meIsAdmin ? adminNameHtml() : escapeHtml(profile?.name || "â€”")}`;

    postText.disabled = false;
    publishBtn.disabled = false;

    startPostsListener();
  }

  // âœ… collections (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø±ÙˆÙ„Ø²)
  const POSTS_COL = "forumPosts";

  let unsubPosts = null;
  const commentUnsubs = new Map();

  // Ù„ÙƒÙ„ Ø¨ÙˆØ³Øª: Ù‡Ø¯Ù Ø§Ù„Ø±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const replyTargets = new Map();

  function clearCommentsListeners(){
    for (const [,u] of commentUnsubs) try{ u(); }catch{}
    commentUnsubs.clear();
  }

  function startPostsListener(){
    if (unsubPosts) try{unsubPosts();}catch{}
    clearCommentsListeners();

    const q = query(collection(db, POSTS_COL), orderBy("createdAtMs","desc"));
    unsubPosts = onSnapshot(q, (snap)=>{
      postsList.innerHTML = "";
      postsCount.textContent = `${snap.size} Ø¨ÙˆØ³Øª`;

      const docs = [];
      snap.forEach(d=> docs.push({id:d.id, ...d.data()}));

      docs.forEach(p=>{
        postsList.appendChild(renderPost(p));
      });
    }, (err)=>{
      console.error(err);
      setErr(postErr, "âŒ ØµØ§Ø± Ø®Ø·Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª.");
    });
  }

  function renderPost(p){
    const post = document.createElement("div");
    post.className = "post";
    post.dataset.pid = p.id;

    const t = Number(p.createdAt?.toMillis ? p.createdAt.toMillis() : p.createdAtMs || 0);
    const time = formatTime(t);

    const likesArr = Array.isArray(p.likes) ? p.likes : [];
    const likedByMe = !!user && likesArr.includes(user.uid);
    const likesCount = likesArr.length;

    const whoHtml = nameHtmlFor(p.uid, p.name);

    post.innerHTML = `
      <div class="postHead">
        <div class="who">ğŸ‘¤ ${whoHtml}</div>
        <div>${escapeHtml(time)}</div>
      </div>

      <div class="postBody">${escapeHtml(p.text || "")}</div>

      <div class="postActions">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="miniBtn likeBtn ${likedByMe ? "liked":""}" type="button">ğŸ‘ <span class="likeText">${likedByMe ? "Ù…Ø¹Ø¬Ø¨" : "Ø£Ø¹Ø¬Ø¨Ù†ÙŠ"}</span></button>
          <button class="miniBtn cToggleBtn" type="button">ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚Ø§Øª</button>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <div class="countPill">ğŸ‘ <b class="likesCount" style="color:var(--white)">${likesCount}</b></div>
          <div class="countPill">ğŸ’¬ <b class="commentsCount" style="color:var(--white)">0</b></div>
        </div>
      </div>

      <div class="commentsWrap">
        <div class="replyPreview">
          <div style="min-width:0">
            <b class="rpName">Ø±Ø¯ Ø¹Ù„Ù‰:</b>
            <div><span class="rpText"></span></div>
          </div>
          <button class="replyCancel" type="button" title="Ø¥Ù„ØºØ§Ø¡">âœ•</button>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <input class="cInput" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚..." maxlength="400" />
          <button class="miniBtn cSendBtn" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>

        <div class="hintErr cErr"></div>
        <div class="cList" style="display:flex;flex-direction:column;gap:10px"></div>
      </div>
    `;

    // Like post
    const likeBtn = post.querySelector(".likeBtn");
    const likeText = post.querySelector(".likeText");
    const likesCountEl = post.querySelector(".likesCount");

    likeBtn.addEventListener("click", async ()=>{
      if (!user || !profile) return;
      try{
        const refDoc = doc(db, POSTS_COL, p.id);
        const nowLiked = likeBtn.classList.contains("liked");
        if (nowLiked){
          await updateDoc(refDoc, { likes: arrayRemove(user.uid) });
          likeBtn.classList.remove("liked");
          likeText.textContent = "Ø£Ø¹Ø¬Ø¨Ù†ÙŠ";
          likesCountEl.textContent = String(Math.max(0, Number(likesCountEl.textContent||0) - 1));
        }else{
          await updateDoc(refDoc, { likes: arrayUnion(user.uid) });
          likeBtn.classList.add("liked");
          likeText.textContent = "Ù…Ø¹Ø¬Ø¨";
          likesCountEl.textContent = String(Number(likesCountEl.textContent||0) + 1);
        }
      }catch(err){
        console.error(err);
      }
    });

    // Comments toggle
    const cWrap = post.querySelector(".commentsWrap");
    const cToggleBtn = post.querySelector(".cToggleBtn");
    const cList = post.querySelector(".cList");
    const cCountEl = post.querySelector(".commentsCount");
    const cInput = post.querySelector(".cInput");
    const cSendBtn = post.querySelector(".cSendBtn");
    const cErr = post.querySelector(".cErr");

    // reply preview elements (per post)
    const rp = post.querySelector(".replyPreview");
    const rpName = post.querySelector(".rpName");
    const rpText = post.querySelector(".rpText");
    const rpCancel = post.querySelector(".replyCancel");

    function setReplyTarget(rt){
      if (rt){
        replyTargets.set(p.id, rt);
        rpName.textContent = `Ø±Ø¯ Ø¹Ù„Ù‰: ${rt.name || "Ù…Ø³ØªØ®Ø¯Ù…"}`;
        rpText.textContent = String(rt.text || "").slice(0,160);
        rp.style.display = "flex";
      } else {
        replyTargets.delete(p.id);
        rp.style.display = "none";
      }
    }

    rpCancel.addEventListener("click", ()=> setReplyTarget(null));

    let commentsOpen = false;
    cToggleBtn.addEventListener("click", ()=>{
      commentsOpen = !commentsOpen;
      cWrap.style.display = commentsOpen ? "flex" : "none";
      if (commentsOpen){
        cInput.focus();
        ensureCommentsListener(p.id, cList, cCountEl, setReplyTarget);
      }
    });

    // Send comment (with replyTo + likes)
    cSendBtn.addEventListener("click", async ()=>{
      setErr(cErr,"");
      if (!user || !profile) return;

      const text = collapseSpaces(cInput.value);
      if (!text) return;

      if (isProfane(text)){
        setErr(cErr, "âŒ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù…Ø±ÙÙˆØ¶ (ÙƒÙ„Ø§Ù… ØºÙŠØ± Ù„Ø§Ø¦Ù‚).");
        return;
      }

      const rt = replyTargets.get(p.id) || null;
      const replyTo = rt ? { uid: rt.uid, name: rt.name, text: String(rt.text||"").slice(0,160), id: rt.id } : null;

      cInput.value = "";
      setReplyTarget(null);

      try{
        const cCol = collection(db, POSTS_COL, p.id, "comments");
        await addDoc(cCol, {
          text,
          uid: user.uid,
          name: profile.name,
          gender: profile.gender,
          age: profile.age,
          likes: [],
          replyTo,
          createdAt: serverTimestamp(),
          createdAtMs: Date.now()
        });
      }catch(err){
        console.error(err);
        setErr(cErr, "âŒ ØµØ§Ø± Ø®Ø·Ø£ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚.");
      }
    });

    return post;
  }

  function ensureCommentsListener(postId, listEl, countEl, setReplyTargetFn){
    if (commentUnsubs.has(postId)) return;

    const q = query(collection(db, POSTS_COL, postId, "comments"), orderBy("createdAtMs","asc"));
    const unsub = onSnapshot(q, (snap)=>{
      listEl.innerHTML = "";
      countEl.textContent = String(snap.size);

      snap.forEach(d=>{
        const c = d.data() || {};
        const cid = d.id;

        const t = Number(c.createdAt?.toMillis ? c.createdAt.toMillis() : c.createdAtMs || 0);

        const likesArr = Array.isArray(c.likes) ? c.likes : [];
        const likedByMe = !!user && likesArr.includes(user.uid);
        const likesCount = likesArr.length;

        const whoHtml = nameHtmlFor(c.uid, c.name);

        const replyBlock = c.replyTo && c.replyTo.name && c.replyTo.text
          ? `
            <div class="replyQuote">
              <b>Ø±Ø¯ Ø¹Ù„Ù‰: ${escapeHtml(c.replyTo.name)}</b>
              <div>${escapeHtml(c.replyTo.text)}</div>
            </div>
          ` : "";

        const row = document.createElement("div");
        row.className = "commentRow";
        row.innerHTML = `
          ${replyBlock}
          <div class="commentMeta">
            <div class="who">ğŸ‘¤ ${whoHtml}</div>
            <div>${escapeHtml(formatTime(t))}</div>
          </div>

          <div class="commentText">${escapeHtml(c.text || "")}</div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:10px">
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="miniBtn heartBtn ${likedByMe ? "hearted":""}" type="button">â¤ï¸ <span class="hText">${likedByMe ? "Ø§Ø­Ø¨Ø¨ØªÙ‡" : "Ø§Ø­Ø¨Ø¨ØªÙ‡"}</span></button>
              <button class="miniBtn replyBtn" type="button">â†© Ø±Ø¯</button>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
              <div class="countPill" title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚">â¤ï¸ <b class="hCount" style="color:var(--white)">${likesCount}</b></div>
            </div>
          </div>
        `;

        // Heart (like comment)
        const heartBtn = row.querySelector(".heartBtn");
        const hCountEl = row.querySelector(".hCount");

        heartBtn.addEventListener("click", async ()=>{
          if (!user || !profile) return;
          try{
            const cRef = doc(db, POSTS_COL, postId, "comments", cid);
            const nowLiked = heartBtn.classList.contains("hearted");
            if (nowLiked){
              await updateDoc(cRef, { likes: arrayRemove(user.uid) });
              heartBtn.classList.remove("hearted");
              hCountEl.textContent = String(Math.max(0, Number(hCountEl.textContent||0) - 1));
            } else {
              await updateDoc(cRef, { likes: arrayUnion(user.uid) });
              heartBtn.classList.add("hearted");
              hCountEl.textContent = String(Number(hCountEl.textContent||0) + 1);
            }
          }catch(err){
            console.error(err);
          }
        });

        // Reply
        const replyBtn = row.querySelector(".replyBtn");
        replyBtn.addEventListener("click", ()=>{
          setReplyTargetFn({
            id: cid,
            uid: c.uid,
            name: c.name || "Ù…Ø³ØªØ®Ø¯Ù…",
            text: String(c.text||"").slice(0,160)
          });
          // focus input
          const postEl = document.querySelector(`.post[data-pid="${postId}"]`);
          const input = postEl?.querySelector(".cInput");
          input?.focus();
        });

        listEl.appendChild(row);
      });
    });

    commentUnsubs.set(postId, unsub);
  }

  // Publish new post
  publishBtn.addEventListener("click", async ()=>{
    setErr(postErr,"");
    if (!user || !profile) return;

    const text = collapseSpaces(postText.value);
    if (!text){ setErr(postErr, "Ø§ÙƒØªØ¨ Ø´ÙŠØ¡ Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø´Ø±."); return; }

    if (isProfane(text)){
      setErr(postErr, "âŒ Ø§Ù„Ø¨ÙˆØ³Øª Ù…Ø±ÙÙˆØ¶ (ÙƒÙ„Ø§Ù… ØºÙŠØ± Ù„Ø§Ø¦Ù‚).");
      return;
    }

    publishBtn.disabled = true;

    try{
      await addDoc(collection(db, POSTS_COL), {
        text,
        uid: user.uid,
        name: profile.name,
        gender: profile.gender,
        age: profile.age,
        likes: [],
        createdAt: serverTimestamp(),
        createdAtMs: Date.now()
      });
      postText.value = "";
    }catch(err){
      console.error(err);
      setErr(postErr, "âŒ ØµØ§Ø± Ø®Ø·Ø£ Ø¨Ø§Ù„Ù†Ø´Ø±.");
    }finally{
      publishBtn.disabled = false;
    }
  });

  refreshBtn.addEventListener("click", ()=>{
    startPostsListener();
  });

  exitBtn.addEventListener("click", ()=>{
    location.href = "index.html";
  });

  onAuthStateChanged(auth, async (u)=>{
    user = u || null;
    watchConnection();

    if (user && !user.isAnonymous){
      const saved = localStorage.getItem(profKey(user.uid));
      if (saved){
        try{
          const p = JSON.parse(saved);
          nameInput.value = p.name || "";
          genderInput.value = p.gender || "";
          ageInput.value = p.age || "";
        }catch{}
      }
    }

    hideForm();
    setErr(modalErr,"");
    modal.style.display = "flex";
  });
</script>
</body>
</html>
