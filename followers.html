rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    function isAdmin() {
      return signedIn() && request.auth.uid in [
        "VFjSs6kH2jcFJnddE7SXIpipzDi2"
      ];
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    // يسمح فقط بتحديث اللايكات بدون العبث بباقي الحقول
    function onlyLikesChanged() {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly(["likes"]);
    }

    // =========================
    // ✅ Global Chat
    // =========================
    match /globalMessages/{id} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if false;
      allow delete: if isAdmin();
    }

    match /globalMeta/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // =========================
    // ✅ Forum (Followers)
    // =========================
    match /forumPosts/{postId} {
      allow read: if signedIn();

      // إنشاء بوست
      allow create: if signedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.text is string
        && request.resource.data.text.size() >= 1
        && request.resource.data.text.size() <= 1500;

      // تحديث:
      // - أي مستخدم مسجل يقدر يعمل Like/Unlike فقط
      // - صاحب البوست أو الأدمن يقدر يعدّل أي شيء (لو مستقبلاً عملت Edit)
      allow update: if signedIn() && (
        onlyLikesChanged() ||
        isOwner(resource.data.uid) ||
        isAdmin()
      );

      // ✅ حذف بوست:
      // - الأدمن
      // - أو صاحب البوست نفسه
      allow delete: if isAdmin() || isOwner(resource.data.uid);

      // ✅ Comments Subcollection
      match /comments/{commentId} {
        allow read: if signedIn();

        allow create: if signedIn()
          && request.resource.data.uid == request.auth.uid
          && request.resource.data.text is string
          && request.resource.data.text.size() >= 1
          && request.resource.data.text.size() <= 400;

        allow update: if false;

        // ✅ حذف تعليق:
        // - الأدمن
        // - أو صاحب التعليق نفسه
        // - أو صاحب البوست (عشان يحذف تعليقات الناس على بوسته)
        allow delete: if isAdmin()
          || isOwner(resource.data.uid)
          || isOwner(get(/databases/$(database)/documents/forumPosts/$(postId)).data.uid);
      }
    }
  }
}
