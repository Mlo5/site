<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<title>Room</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet"/>
<style>
body{margin:0;background:#020202;color:#fff;font-family:Tajawal}
.wrap{max-width:1000px;margin:auto;padding:16px}
.chat{height:60vh;border:1px solid #333;padding:10px;overflow:auto}
.msg{margin-bottom:10px}
.system{color:#9ca3af;text-align:center}
input{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#000;color:#fff}
button{padding:10px 14px;border-radius:999px;background:#facc15;border:none;font-weight:900}
</style>
</head>

<body>
<div class="wrap">
<h3 id="title"></h3>
<div class="chat" id="chat"></div>
<input id="text" placeholder="اكتب رسالة..."/>
<button id="send">إرسال</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore,collection,addDoc,onSnapshot,serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyBnxruqFdBHEHTSVXl-QK848lsGvwBBH9U",
  authDomain:"mlo5-users.firebaseapp.com",
  projectId:"mlo5-users"
});
const auth = getAuth(app);
const db = getFirestore(app);

const room = new URLSearchParams(location.search).get("room");
if(!room) location.href="chatrooms.html";
title.textContent = room.toUpperCase();

const me = JSON.parse(sessionStorage.getItem("mlo5-chat")||"null");
if(!me) location.href="chatrooms.html";

const msgs = collection(db,"chatRooms",room,"messages");

onAuthStateChanged(auth,u=>{
  if(!u) location.href="login.html";
  addDoc(msgs,{type:"system",text:`${me.name} دخل الغرفة`,createdAt:serverTimestamp()});
});

onSnapshot(msgs,snap=>{
  chat.innerHTML="";
  snap.forEach(d=>{
    const m=d.data();
    const div=document.createElement("div");
    div.className="msg";
    div.textContent = m.type==="system"?m.text:`${m.name}: ${m.text}`;
    if(m.type==="system") div.className="system";
    chat.appendChild(div);
  });
  chat.scrollTop=chat.scrollHeight;
});

send.onclick = async ()=>{
  if(!text.value.trim())return;
  await addDoc(msgs,{
    type:"user",
    name:me.name,
    text:text.value,
    createdAt:serverTimestamp()
  });
  text.value="";
};
</script>
</body>
</html>
