<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø© - M L O 5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />
  <!-- âœ… Favicon -->
  <link rel="icon" href="./favicon.png?v=2" type="image/png" sizes="32x32" />
  <link rel="icon" href="./favicon.png?v=2" type="image/png" sizes="16x16" />
  <link rel="apple-touch-icon" href="./favicon.png?v=2" />
  <meta name="theme-color" content="#020202" />

  <style>
    :root{
      --bg-dark:#020202;
      --yellow:#facc15;
      --white:#f9fafb;
      --muted:#9ca3af;
      --border-subtle:rgba(156,163,175,.35);
      --grid-x:0px; --grid-y:0px;
      --vh: 1vh;

      /* âœ… Colors for ranks */
      --legend:#ef4444;
      --vip:#2563eb;
      --root:#f97316;
      --girl:#ec4899;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg-dark);
      color:var(--white);
      min-height: calc(var(--vh, 1vh) * 100);
      display:flex;
      justify-content:center;
      align-items:stretch;
      position:relative;
      cursor:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><polygon points='2,2 2,22 8,16 14,26 18,24 12,14 20,14' fill='%23facc15' stroke='%23000000' stroke-width='1.5'/></svg>") 0 0, auto;
      overflow:hidden;
    }

    /* âœ… Global background layer (shows for ALL users; admin can change it) */
    #siteBgLayer{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
      display:block;
      background-size:cover;
      background-position:center;
      opacity:.55;
      filter:saturate(1.1) contrast(1.05);
      mix-blend-mode:screen;
    }
    #siteBgLayer::after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,.50), rgba(0,0,0,.70));
      mix-blend-mode:multiply;
    }

    .bg-grid{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background-image:radial-gradient(circle, rgba(249,250,251,.55) 1px, transparent 1px);
      background-size:30px 30px;
      background-position:calc(50% + var(--grid-x)) calc(50% + var(--grid-y));
      opacity:.25; mix-blend-mode:screen;
    }

    .page{
      width:100%;
      max-width:1100px;
      padding:32px 16px 40px;
      margin:auto;
      position:relative;
      z-index:1;
      min-height:0;
    }
    .card{
      background:linear-gradient(145deg,#020202,#050505);
      border-radius:18px;
      padding:14px;
      border:1px solid var(--border-subtle);
      box-shadow:0 12px 30px rgba(0,0,0,.8),0 0 0 1px rgba(55,65,81,.6);
      position:relative;
      overflow:hidden;
      min-height:0;
    }
    .top-bar{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-bottom:14px; direction:ltr;
    }
    .top-chip{
      font-size:.9rem; color:var(--white);
      padding:6px 14px; border-radius:999px;
      border:1px solid rgba(250,204,21,.6);
      background:rgba(0,0,0,.6);
      box-shadow:0 8px 20px rgba(0,0,0,.8),0 0 0 1px rgba(15,23,42,.9);
      display:inline-flex; align-items:center; gap:8px;
      user-select:none; cursor:pointer;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(239,68,68,.9)}
    .dot.on{background:rgba(34,197,94,.95)}
    .title{
      font-family:"Poppins",system-ui,sans-serif;
      font-weight:800; letter-spacing:.12em;
      text-transform:uppercase; white-space:nowrap;
    }
    .title small{letter-spacing:0;font-weight:700;color:var(--muted)}

    .wrap{
      display:grid;
      grid-template-columns:320px 1fr;
      gap:14px;
      height:calc(100vh - 32px - 40px - 14px - 44px);
      min-height:70vh;
      min-height:0;
    }

    .panel-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    .panel-head .h{display:flex;flex-direction:column;gap:2px}
    .panel-head .h b{color:var(--yellow);font-size:1rem}
    .panel-head .h span{color:var(--muted);font-size:.85rem}

    .badge{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.55);
      padding:6px 10px;
      font-size:.85rem;
      background:rgba(0,0,0,.45);
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }

    .badgeBtn{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.55);
      padding:6px 10px;
      font-size:.85rem;
      background:rgba(0,0,0,.45);
      color:var(--yellow);
      display:none;
      align-items:center; gap:8px;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
    }

    .onlineCard{display:flex;flex-direction:column;height:100%}
    #onlineList{
      display:flex;flex-direction:column;gap:10px;overflow:auto;min-height:0;flex:1;padding-right:4px;
      scrollbar-width:none; -ms-overflow-style:none;
    }
    #onlineList::-webkit-scrollbar{ width:0; height:0; }

    /* âœ… user row base */
    .userRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px;border-radius:16px;border:1px solid var(--border-subtle);
      background:rgba(0,0,0,.55);
      box-shadow:0 10px 22px rgba(0,0,0,.6);
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }

    /* âœ… Admin in online list: BLACK background (as requested) */
    .userRow.admin{
      background:rgba(0,0,0,.80);
      border-color:rgba(250,204,21,.28);
      box-shadow:0 0 0 1px rgba(0,0,0,.85), 0 10px 22px rgba(0,0,0,.6);
    }

    /* âœ… Rank backgrounds apply to the WHOLE ROW (not only name) */
    .userRow.rank-legend{
      background:linear-gradient(135deg, rgba(239,68,68,.38), rgba(0,0,0,.75));
      background-image:url("legend.gif");
      background-size:cover;
      background-position:center;
      border-color:rgba(239,68,68,.35);
    }
    .userRow.rank-vip{
      background:linear-gradient(135deg, rgba(37,99,235,.38), rgba(0,0,0,.75));
      background-image:url("vip.gif");
      background-size:cover;
      background-position:center;
      border-color:rgba(37,99,235,.35);
    }
    .userRow.rank-root{
      background:linear-gradient(135deg, rgba(249,115,22,.38), rgba(0,0,0,.75));
      background-image:url("root.gif");
      background-size:cover;
      background-position:center;
      border-color:rgba(249,115,22,.35);
    }
    .userRow.rank-girl{
      background:linear-gradient(135deg, rgba(236,72,153,.38), rgba(0,0,0,.75));
      background-image:url("girl.gif");
      background-size:cover;
      background-position:center;
      border-color:rgba(236,72,153,.38);
    }
    /* subtle overlay to keep text readable on GIFs */
    .userRow.rank-legend::after,
    .userRow.rank-vip::after,
    .userRow.rank-root::after,
    .userRow.rank-girl::after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.65));
      pointer-events:none;
    }
    .userRow > *{ position:relative; z-index:1; }

    .userMeta{display:flex;flex-direction:column;gap:3px;min-width:0}
    .userMeta b{
      font-size:1.05rem;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:190px;
      display:flex; align-items:center; gap:8px;
    }
    .userMeta span{font-size:.8rem;color:var(--muted);display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap}

    .miniPill{
      border-radius:999px;border:1px solid rgba(148,163,184,.7);
      padding:3px 8px;font-size:.75rem;background:rgba(0,0,0,.4);
      color:var(--yellow);white-space:nowrap;
      display:inline-flex; align-items:center; gap:6px;
    }

    /* âœ… device icon small next to status (online list only) */
    .devIcon{
      font-size:.85rem;
      opacity:.9;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,.25));
    }

    /* âœ… Rank icon: emoji ONLY (no border/circle) */
    .rankIcon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:auto;height:auto;
      border:none;
      background:transparent;
      border-radius:0;
      padding:0;
      font-size:1.05rem;
      animation: rankBlink 1.2s infinite;
      flex:0 0 auto;
      filter: drop-shadow(0 0 10px rgba(250,204,21,.10));
    }
    @keyframes rankBlink{
      0%{opacity:1}
      50%{opacity:.25}
      100%{opacity:1}
    }

    /* âœ… Mute indicator: emoji ONLY (no border/circle) */
    .mutedEmoji{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:1rem;
      animation: rankBlink 1.2s infinite;
      filter: drop-shadow(0 0 12px rgba(239,68,68,.18));
    }

    /* âœ…â¬‡ï¸ ØµØºÙ‘Ø± Ø´ÙˆÙŠØ© Ø§Ø´Ø§Ø±Ø© Ø§Ù„ØªØ¬Ø§Ù‡Ù„ + Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø· */
    .ignoreBtn, .moreBtn{
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.45);
      color:var(--yellow);
      border-radius:999px;
      padding:5px 9px;
      cursor:pointer;
      font-size:.85rem;
      user-select:none;
      min-width:38px;
      height:32px;
      display:inline-flex;align-items:center;justify-content:center;
    }
    .ignoreBtn.ignored{border-color:rgba(239,68,68,.85);color:rgba(239,68,68,.95)}
    .ignoreBtn:disabled{opacity:.5;cursor:not-allowed}
    .moreBtn{opacity:.95}

    .actionsRow{display:flex;align-items:center;gap:8px}

    .statusWrap{display:flex;align-items:center;gap:8px;justify-content:flex-end;direction:rtl}
    select,input{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.55);
      background:#000;
      color:var(--white);
      padding:8px 12px;
      outline:none;
      font-size:.9rem;
    }

    .chatCard{display:flex;flex-direction:column;height:100%;min-height:0;position:relative}
    .chatSplit{
      flex:1; min-height:0;
      display:grid;
      grid-template-columns:1fr 0fr;
      gap:12px;
    }
    .chatCol{min-height:0;display:flex;flex-direction:column}

    #messages{
      display:flex;flex-direction:column;gap:10px;overflow:auto;
      min-height:0;flex:1;padding-right:4px;padding-bottom:6px;
      scrollbar-width:none; -ms-overflow-style:none;
      -webkit-overflow-scrolling: touch;
    }
    #messages::-webkit-scrollbar{ width:0; height:0; }

    .msgRow{
      width:100%;
      display:flex;
      direction:rtl;
      justify-content:flex-start;
    }
    .msgRow.me{ justify-content:flex-end; }

    .msg{
      max-width:78%;
      border-radius:18px;
      border:1px solid var(--border-subtle);
      background:rgba(0,0,0,.55);
      box-shadow:0 10px 22px rgba(0,0,0,.6);
      padding:10px 12px 44px;
      line-height:1.5;
      word-break:break-word;
      position:relative;
    }
    .msg.me{
      border-color:rgba(250,204,21,.75);
      box-shadow:0 14px 32px rgba(0,0,0,.75),0 0 0 1px rgba(250,204,21,.35);
    }

    .msgHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:6px;color:var(--muted);font-size:.85rem
    }
    .nameTag{
      font-weight:900;display:inline-flex;align-items:center;gap:8px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px
    }
    .nameTag.rankBig{font-size:1.05rem}
    .msgTimeUnder{margin-top:6px;font-size:.78rem;color:rgba(156,163,175,.92);text-align:left;direction:ltr}

    .system{
      align-self:center;
      color:rgba(156,163,175,.95);
      font-size:.9rem;
      padding:6px 10px;
      border-radius:999px;
      border:1px dashed rgba(250,204,21,.55);
      background:rgba(0,0,0,.55);
      max-width:100%;
      text-align:center;
    }
    /* âœ… animated system message "Ø¯Ø®Ù„ ÙƒØ¨ÙŠØ±Ù‡Ù…" */
    .systemBigBoss{
      animation: bigBossBlink 1.05s infinite;
      border-style:solid;
      border-color:rgba(250,204,21,.75);
      color:#fff;
      background:rgba(0,0,0,.75);
      box-shadow:0 10px 30px rgba(0,0,0,.65);
      letter-spacing:.02em;
    }
    @keyframes bigBossBlink{
      0%{opacity:1; transform:translateY(0)}
      50%{opacity:.35; transform:translateY(-1px)}
      100%{opacity:1; transform:translateY(0)}
    }

    .replyBtn{
      position:absolute;
      bottom:8px;
      right:10px;
      border-radius:999px;
      border:1px solid rgba(250,204,21,.45);
      background:rgba(0,0,0,.55);
      color:var(--yellow);
      cursor:pointer;
      font-size:.8rem;
      padding:6px 10px;
      height:34px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }

    .replyPreview{
      border:1px solid rgba(250,204,21,.35);
      border-radius:14px;
      background:rgba(0,0,0,.45);
      padding:8px 10px;
      margin:0 0 10px;
      display:none;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .replyPreview b{color:var(--yellow);font-size:.9rem}
    .replyPreview span{color:var(--muted);font-size:.85rem;line-height:1.5}
    .replyCancel{
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      border-radius:999px;
      width:34px;height:34px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      user-select:none;
      flex:0 0 auto;
    }

    .replyQuote{
      border:1px solid rgba(250,204,21,.25);
      background:rgba(0,0,0,.45);
      border-radius:14px;
      padding:8px 10px;
      margin-bottom:8px;
    }
    .replyQuote b{color:var(--yellow);font-size:.85rem}
    .replyQuote div{color:var(--muted);font-size:.85rem;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .composer{display:flex;align-items:center;gap:10px;margin-top:12px;direction:rtl}
    #msgInput{flex:1;border-radius:999px}

    .sendBtn,.emojiBtn,.adminClearBtn{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      padding:9px 14px;
      cursor:pointer;
      font-weight:800;
      height:40px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .emojiBtn{width:40px;padding:0}
    .adminClearBtn{width:40px;padding:0;display:none}

    .emojiPicker{
      position:absolute;
      bottom:62px;
      right:14px;
      width:280px;
      max-width:calc(100% - 28px);
      border-radius:18px;
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.92);
      box-shadow:0 18px 45px rgba(0,0,0,.95);
      padding:10px;
      display:none;
      z-index:50;
      backdrop-filter:blur(10px);
    }
    .emojiGrid{
      display:grid;grid-template-columns:repeat(8,1fr);gap:6px;max-height:200px;overflow:auto;padding-right:4px;
      scrollbar-width:none; -ms-overflow-style:none;
    }
    .emojiGrid::-webkit-scrollbar{ width:0; height:0; }
    .emojiItem{border:1px solid rgba(148,163,184,.35);background:rgba(0,0,0,.55);border-radius:12px;padding:6px 0;text-align:center;cursor:pointer;user-select:none}

    .menu{
      position:fixed; z-index:9999;
      background:rgba(0,0,0,.92);
      border:1px solid rgba(250,204,21,.55);
      border-radius:14px;
      padding:8px;
      min-width:220px;
      display:none;
      box-shadow:0 18px 40px rgba(0,0,0,.9);
    }
    .menu button{
      width:100%;
      border:none;
      background:transparent;
      color:var(--white);
      text-align:right;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
    }
    .menu button:hover{background:rgba(250,204,21,.12); color:var(--yellow)}
    .menu .sep{height:1px;background:rgba(250,204,21,.25);margin:6px 0;border-radius:999px}

    .guestPill{
      border:1px solid rgba(250,204,21,.35);
      background:rgba(0,0,0,.45);
      border-radius:999px;
      padding:2px 8px;
      font-size:.78rem;
      color:var(--yellow);
      white-space:nowrap;
    }

    #modal{
      position:fixed; inset:0; z-index:999;
      background:rgba(0,0,0,.75);
      display:none; align-items:center; justify-content:center;
      padding:16px;
    }
    #modalBox{
      width:min(860px,96vw);
      border-radius:18px;
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.92);
      box-shadow:0 18px 45px rgba(0,0,0,.95),0 0 0 1px rgba(17,24,39,.9);
      padding:14px;
      backdrop-filter:blur(10px);
      position:relative;
    }
    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 900px){ .modalGrid{grid-template-columns:1fr} }

    .modalCard{
      border:1px solid rgba(250,204,21,.35);
      border-radius:16px;
      background:rgba(0,0,0,.45);
      padding:12px;
      position:relative;
    }
    .modalCard h3{margin-bottom:8px;color:var(--yellow);text-align:center;font-weight:900}
    .modalCard p{color:var(--muted);text-align:center;font-size:.9rem;margin-bottom:12px;line-height:1.7}

    .homeBackBtn{
      position:absolute;
      top:10px;
      left:10px;
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      width:40px;height:40px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      user-select:none;
    }
    .backListBtn{
      position:absolute;
      top:10px;
      left:58px;
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      width:40px;height:40px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      user-select:none;
    }

    .choiceRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
    .choiceBtn{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      padding:10px 14px;
      cursor:pointer;
      font-weight:900;
      flex:1;
      min-width:180px;
    }

    .modalRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .modalRow.one{grid-template-columns:1fr}
    .modalBtn{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      padding:10px 14px;
      cursor:pointer;
      font-weight:900;
    }
    .hintErr{margin-top:8px;color:rgba(239,68,68,.95);font-size:.85rem;text-align:center;display:none}

    .nameWrap{display:flex;gap:10px;align-items:center}
    .nameWrap input{flex:1}

    .colorRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .colorBox{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid rgba(250,204,21,.35);
      border-radius:999px;
      padding:6px 10px;
      background:rgba(0,0,0,.45);
      color:var(--white);
      font-size:.85rem;
    }
    .colorBox input{width:44px;height:28px;padding:0;border-radius:10px;border:1px solid rgba(250,204,21,.55); background:#000}

    @media (max-width:900px){
      body{overflow:hidden}
      .page{padding:16px 12px 18px}
      .wrap{
        grid-template-columns:1fr;
        height:calc(var(--vh, 1vh) * 100 - 90px);
        min-height:0;
      }
      .badgeBtn{display:inline-flex;}
      .msg{
        max-width:88%;
        padding:8px 10px 34px;
        border-radius:14px;
        font-size:.9rem;
      }
      .msgHead{font-size:.75rem;margin-bottom:4px}
      .msgTimeUnder{font-size:.7rem}
      .replyBtn{
        height:30px;
        padding:4px 8px;
        font-size:.7rem;
        bottom:6px;
        right:8px;
      }
      .sendBtn,.emojiBtn{ display:none !important; }
    }

    #appModal{
      position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.75);
      display:none; align-items:center; justify-content:center;
      padding:16px;
    }
    #appModalBox{
      width:min(520px,96vw);
      border-radius:18px;
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.92);
      box-shadow:0 18px 45px rgba(0,0,0,.95),0 0 0 1px rgba(17,24,39,.9);
      padding:14px;
      backdrop-filter:blur(10px);
    }
    .appModalTitle{
      color:var(--yellow);
      font-weight:900;
      text-align:center;
      margin-bottom:8px;
    }
    .appModalText{
      color:var(--white);
      text-align:center;
      line-height:1.8;
      margin-bottom:12px;
      white-space:pre-wrap;
    }
    .appModalActions{
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    }

    #modalBox .modalCard,
    #modalBox .choiceBtn,
    #modalBox .modalBtn,
    #modalBox input,
    #modalBox select,
    #modalBox .colorBox{
      transition: box-shadow .18s ease, transform .18s ease, border-color .18s ease;
    }
    #modalBox .choiceBtn:hover,
    #modalBox .modalBtn:hover,
    #modalBox .colorBox:hover{
      box-shadow: 0 0 0 1px rgba(250,204,21,.25), 0 0 22px rgba(250,204,21,.18), 0 16px 40px rgba(0,0,0,.85);
      transform: translateY(-1px);
      border-color: rgba(250,204,21,.85);
    }
    #modalBox input:hover,
    #modalBox select:hover{
      box-shadow: 0 0 0 1px rgba(250,204,21,.18), 0 0 18px rgba(250,204,21,.14);
      border-color: rgba(250,204,21,.75);
    }
    #modalBox .modalCard:hover{
      box-shadow: 0 0 0 1px rgba(250,204,21,.14), 0 0 26px rgba(250,204,21,.10), 0 18px 45px rgba(0,0,0,.95);
    }

    .adminRoomDots{
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.45);
      color:var(--yellow);
      border-radius:999px;
      padding:5px 9px;
      cursor:pointer;
      font-size:.85rem;
      user-select:none;
      height:32px;
      min-width:38px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }

    #onlineOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      z-index:1190;
      display:none;
    }
    @media (max-width:900px){
      .onlineCard{
        position:fixed;
        top:74px;
        bottom:16px;
        right:-380px;
        width:min(360px, 88vw);
        z-index:1200;
        transition:right .22s ease;
      }
      .onlineCard.drawer-open{ right:12px; }
      #onlineOverlay.show{ display:block; }
    }

    .chatEmojiImg{
      width:26px;height:26px;
      vertical-align:middle;
      border-radius:8px;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
    }

    .dhikrToast{
      position:fixed;
      z-index:5000;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(250,204,21,.25);
      background:rgba(0,0,0,.28);
      color:#fff;
      font-weight:900;
      opacity:0;
      pointer-events:none;
      backdrop-filter: blur(6px);
      animation: dhikrInOut 4.2s ease forwards;
      text-shadow: 0 4px 18px rgba(0,0,0,.6);
    }
    @keyframes dhikrInOut{
      0%{opacity:0; transform:translateY(6px) scale(.98)}
      15%{opacity:.65; transform:translateY(0) scale(1)}
      70%{opacity:.65; transform:translateY(0) scale(1)}
      100%{opacity:0; transform:translateY(-6px) scale(.98)}
    }
  </style>
</head>

<body>
  <!-- âœ… global background layer -->
  <div id="siteBgLayer"></div>

  <div class="bg-grid"></div>
  <div id="onlineOverlay"></div>

  <main class="page">
    <div class="top-bar">
      <div class="top-chip" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„">
        <span class="dot" id="connDot"></span>
        <span id="connText">ØºÙŠØ± Ù…ØªØµÙ„</span>
      </div>

      <div class="title">M L O 5 <small>â€¢ Global Chat</small></div>

      <div style="display:flex;gap:10px;align-items:center">
        <!-- âœ… Ø²Ø± Ø§Ù„Ø³Ø¬Ù„ ÙŠØ¸Ù‡Ø± Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø· -->
        <button class="top-chip" id="logBtn" type="button" title="Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©" style="display:none;">ğŸ“œ Ø³Ø¬Ù„</button>

        <!-- âœ… Ø²Ø± Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·) - Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø³Ø¬Ù„ -->
        <button class="top-chip" id="bgBtn" type="button" title="Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹" style="display:none;">ğŸ–¼ï¸ Ø®Ù„ÙÙŠØ©</button>

        <!-- âœ… Ø²Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ø¨ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„ÙƒÙ„ -->
        <button class="top-chip" id="colorBtn" type="button" title="Ø£Ù„ÙˆØ§Ù†">ğŸ¨ Ø£Ù„ÙˆØ§Ù†</button>

        <!-- âœ… Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø¬Ù†Ø¨ Ø®Ø±ÙˆØ¬ (Ù„Ù„Ø¬Ù…ÙŠØ¹) -->
        <button class="top-chip" id="downloadBtn" type="button" title="ØªØ­Ù…ÙŠÙ„ Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„</button>

        <button class="top-chip" id="exitBtn" type="button" title="Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø´Ø§Øª">â†© Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="wrap">
      <section class="card onlineCard" id="onlineCard">
        <div class="panel-head">
          <div class="h">
            <b>Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø§Ù„Ø¢Ù†</b>
            <span>Ø§Ù„Ø¹Ø¯Ø¯: <b id="onlineCount">0</b></span>
          </div>

          <div class="statusWrap">
            <span class="badge" id="meBadge">Ø£Ù†Øª</span>
            <select id="statusSelect" title="ØºÙŠÙ‘Ø± Ø­Ø§Ù„ØªÙƒ">
              <option value="online">ğŸŸ¢ Ù…ØªØµÙ„</option>
              <option value="busy">â›” Ù…Ø´ØºÙˆÙ„</option>
              <option value="work">ğŸ’¼ Ø¨Ø§Ù„Ø¹Ù…Ù„</option>
              <option value="car">ğŸš— Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø©</option>
              <option value="food">ğŸ” Ø·Ø¹Ø§Ù…</option>
              <option value="out">ğŸŒ™ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</option>
            </select>
          </div>
        </div>

        <div id="onlineList"></div>
      </section>

      <section class="card chatCard">
        <div class="panel-head">
          <div class="h">
            <b>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</b>
            <span id="chatHint">Ø¯Ø±Ø¯Ø´ ÙˆØ®Ù„ÙŠ Ø§Ù„Ø´Ø¨Ø§Ø¨ <span style="color:#facc15">ØªØ³ØªÙØ§Ø¯</span></span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <button class="badgeBtn" id="openOnlineBtn" type="button" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ†">ğŸ‘¥ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ†</button>
            <div class="badge" id="ignoreCount">ØªØ¬Ø§Ù‡Ù„: 0</div>
          </div>
        </div>

        <div class="chatSplit" id="chatSplit">
          <div class="chatCol">
            <div id="messages"></div>

            <div class="replyPreview" id="replyPreview">
              <div style="min-width:0">
                <b id="replyPreviewName">Ø±Ø¯ Ø¹Ù„Ù‰:</b>
                <div><span id="replyPreviewText"></span></div>
              </div>
              <button class="replyCancel" id="replyCancelBtn" type="button" title="Ø¥Ù„ØºØ§Ø¡">âœ•</button>
            </div>

            <form id="chatForm" class="composer">
              <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" disabled enterkeyhint="send" />
              <button class="adminClearBtn" id="adminClearBtn" type="button" title="Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹">ğŸ§¹</button>
              <button class="emojiBtn" id="emojiBtn" type="button" title="Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">ğŸ˜Š</button>
              <button class="sendBtn" id="sendBtn" type="submit" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
            </form>
          </div>
        </div>

        <div class="emojiPicker" id="emojiPicker" aria-hidden="true">
          <div class="emojiGrid" id="emojiGrid"></div>
        </div>
      </section>
    </div>
  </main>

  <div id="modal">
    <div id="modalBox">
      <div class="modalGrid">
        <div class="modalCard">
          <button class="homeBackBtn" id="homeBtn" type="button" title="Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‡ÙˆÙ…">ğŸ </button>
          <button class="backListBtn" id="backListBtn" type="button" title="Ø±Ø¬ÙˆØ¹">â†©</button>

          <h3>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Øª</h3>
          <p>( Ù…ÙØ§ ÙŠÙÙ„Ù’ÙÙØ¸Ù Ù…ÙÙ†Ù’ Ù‚ÙÙˆÙ’Ù„Ù Ø¥ÙÙ„Ø§ Ù„ÙØ¯ÙÙŠÙ’Ù‡Ù Ø±ÙÙ‚ÙÙŠØ¨ÙŒ Ø¹ÙØªÙÙŠØ¯ÙŒ )</p>

          <div class="choiceRow">
            <button class="choiceBtn" id="chooseLogin" type="button">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
            <button class="choiceBtn" id="chooseGuest" type="button">ğŸ‘¤ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ</button>
          </div>

          <div id="formBox" style="display:none;">
            <div class="modalRow one">
              <div class="nameWrap">
                <input id="nameInput" placeholder="Ø§Ø³Ù…Ùƒ (3+)" />
              </div>
            </div>

            <div class="modalRow">
              <select id="genderInput">
                <option value="">Ø§Ù„Ø¬Ù†Ø³</option>
                <option value="male">Ø°ÙƒØ±</option>
                <option value="female">Ø£Ù†Ø«Ù‰</option>
              </select>
              <input id="ageInput" type="number" min="10" max="99" placeholder="Ø§Ù„Ø¹Ù…Ø± (10+)" />
            </div>

            <!-- âœ… NEW: manual country select -->
            <div class="modalRow one">
              <select id="countryInput" title="Ø§Ù„Ø¯ÙˆÙ„Ø©">
                <option value="">Ø§Ù„Ø¯ÙˆÙ„Ø©</option>
                <option value="JO">ğŸ‡¯ğŸ‡´ Ø§Ù„Ø£Ø±Ø¯Ù†</option>
                <option value="SA">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</option>
                <option value="AE">ğŸ‡¦ğŸ‡ª Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª</option>
                <option value="KW">ğŸ‡°ğŸ‡¼ Ø§Ù„ÙƒÙˆÙŠØª</option>
                <option value="QA">ğŸ‡¶ğŸ‡¦ Ù‚Ø·Ø±</option>
                <option value="BH">ğŸ‡§ğŸ‡­ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†</option>
                <option value="OM">ğŸ‡´ğŸ‡² Ø¹ÙÙ…Ø§Ù†</option>
                <option value="EG">ğŸ‡ªğŸ‡¬ Ù…ØµØ±</option>
                <option value="IQ">ğŸ‡®ğŸ‡¶ Ø§Ù„Ø¹Ø±Ø§Ù‚</option>
                <option value="PS">ğŸ‡µğŸ‡¸ ÙÙ„Ø³Ø·ÙŠÙ†</option>
                <option value="LB">ğŸ‡±ğŸ‡§ Ù„Ø¨Ù†Ø§Ù†</option>
                <option value="SY">ğŸ‡¸ğŸ‡¾ Ø³ÙˆØ±ÙŠØ§</option>
                <option value="MA">ğŸ‡²ğŸ‡¦ Ø§Ù„Ù…ØºØ±Ø¨</option>
                <option value="DZ">ğŸ‡©ğŸ‡¿ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±</option>
                <option value="TN">ğŸ‡¹ğŸ‡³ ØªÙˆÙ†Ø³</option>
                <option value="LY">ğŸ‡±ğŸ‡¾ Ù„ÙŠØ¨ÙŠØ§</option>
                <option value="SD">ğŸ‡¸ğŸ‡© Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</option>
                <option value="YE">ğŸ‡¾ğŸ‡ª Ø§Ù„ÙŠÙ…Ù†</option>
                <option value="TR">ğŸ‡¹ğŸ‡· ØªØ±ÙƒÙŠØ§</option>
                <option value="US">ğŸ‡ºğŸ‡¸ USA</option>
                <option value="GB">ğŸ‡¬ğŸ‡§ UK</option>
                <option value="DE">ğŸ‡©ğŸ‡ª Ø£Ù„Ù…Ø§Ù†ÙŠØ§</option>
                <option value="FR">ğŸ‡«ğŸ‡· ÙØ±Ù†Ø³Ø§</option>
                <option value="CA">ğŸ‡¨ğŸ‡¦ ÙƒÙ†Ø¯Ø§</option>
              </select>
            </div>

            <div class="colorRow">
              <div class="colorBox">
                <span>Ù„ÙˆÙ† Ø§Ù„Ø§Ø³Ù…</span>
                <input id="nameColor" type="color" value="#facc15" />
              </div>
              <div class="colorBox">
                <span>Ù„ÙˆÙ† Ø§Ù„Ù†Øµ</span>
                <input id="textColor" type="color" value="#f9fafb" />
              </div>
            </div>

            <button id="enterBtn" class="modalBtn" type="button">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø´Ø§Øª</button>
          </div>

          <div class="hintErr" id="modalErr"></div>
        </div>

        <div class="modalCard">
          <h3>ADMIN</h3>

          <div class="modalRow one">
            <input id="adminUser" placeholder="Username" autocomplete="off" />
          </div>
          <div class="modalRow one">
            <input id="adminPass" placeholder="Password" type="password" autocomplete="off" />
          </div>

          <button id="adminLoginBtn" class="modalBtn" type="button">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</button>
          <div class="hintErr" id="adminErr"></div>

          <div class="adminNote">
            Ø£Ø´ÙŠØ§Ø¡ Ø´ÙˆÙŠ Ø®Ø§ØµØ© Ø­Ø¨ÙˆØ¨ÙŠ âœ¨ğŸ¥±.<br>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="appModal">
    <div id="appModalBox">
      <div class="appModalTitle" id="appModalTitle">ØªÙ†Ø¨ÙŠÙ‡</div>
      <div class="appModalText" id="appModalText">â€”</div>
      <div class="appModalActions" id="appModalActions"></div>
    </div>
  </div>

  <div class="menu" id="ctxMenu">
    <div id="modActions" style="display:none;">
      <button id="ctxKickBtn">ğŸšª Ø·Ø±Ø¯</button>
      <button id="ctxMuteBtn">ğŸ”‡ ÙƒØªÙ…</button>
      <button id="ctxUnmuteBtn">ğŸ”Š Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ…</button>
      <button id="ctxBanBtn">â›” Ø­Ø¸Ø±</button>
      <button id="ctxUnbanBtn">âœ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</button>
      <div class="sep"></div>
    </div>

    <div id="rankActions" style="display:none;">
      <button id="ctxRankLegend">âš¡ Legendary</button>
      <button id="ctxRankVip">ğŸ’ VIP</button>
      <button id="ctxRankRoot">ğŸ›¡ï¸ ROOT</button>
      <button id="ctxRankGirl">ğŸ€ GIRL</button>
      <button id="ctxRankNone">ğŸ§½ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±ØªØ¨Ø©</button>
    </div>
  </div>

  <div class="menu" id="roomMenu">
    <button id="roomLockBtn">ğŸ”’ Ù‚ÙÙ„ Ø§Ù„Ø±ÙˆÙ…</button>
    <button id="roomUnlockBtn">ğŸ”“ ÙØªØ­ Ø§Ù„Ø±ÙˆÙ…</button>

    <div class="sep"></div>
    <button id="selfMuteBtn">ğŸ”‡ ÙƒØªÙ… Ù†ÙØ³ÙŠ</button>
    <button id="selfUnmuteBtn">ğŸ”Š ÙÙƒ ÙƒØªÙ… Ù†ÙØ³ÙŠ</button>

    <!-- âœ… global backgrounds (admin only, triggered from top bg button) -->
    <div class="sep"></div>
    <button id="bg1Btn">ğŸ–¼ï¸ Ø®Ù„ÙÙŠØ© 1</button>
    <button id="bg2Btn">ğŸ–¼ï¸ Ø®Ù„ÙÙŠØ© 2</button>
    <button id="bg3Btn">ğŸ–¼ï¸ Ø®Ù„ÙÙŠØ© 3</button>
    <button id="bg0Btn">ğŸ§½ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    query, where, orderBy, onSnapshot, doc, setDoc,
    getDocs, limit, limitToLast
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getDatabase, ref, set, onDisconnect, onValue, remove, update } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBnxruqFdBHEHTSVXl-QK848lsGvwBBH9U",
    authDomain: "mlo5-users.firebaseapp.com",
    databaseURL: "https://mlo5-users-default-rtdb.firebaseio.com",
    projectId: "mlo5-users",
    appId: "1:142086858806:web:64c50f3a8d6250a2049097"
  };

  const ADMIN_UIDS = ["VFjSs6kH2jcFJnddE7SXIpipzDi2"];
  const ADMIN_USERNAME = "MLO5";
  const ADMIN_PASSWORD = "APRIL3049";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const rtdb = getDatabase(app);

  /* âœ…âœ…âœ… FIX (Mobile-only): Server Time Offset + nowMs() (Desktop unaffected) */
  const __MOBILE_DEVICE =
    window.matchMedia("(pointer: coarse)").matches ||
    /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  let serverOffsetMs = 0;
  onValue(ref(rtdb, ".info/serverTimeOffset"), (snap)=>{
    serverOffsetMs = Number(snap.val() || 0);
  });
  function nowMs(){
    return Date.now() + (__MOBILE_DEVICE ? serverOffsetMs : 0);
  }
  /* âœ…âœ…âœ… END FIX */

  const connDot = document.getElementById("connDot");
  const connText = document.getElementById("connText");
  const exitBtn = document.getElementById("exitBtn");
  const logBtn = document.getElementById("logBtn");
  const bgBtn  = document.getElementById("bgBtn");
  const colorBtn = document.getElementById("colorBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  const onlineList = document.getElementById("onlineList");
  const onlineCount = document.getElementById("onlineCount");
  const meBadge = document.getElementById("meBadge");
  const statusSelect = document.getElementById("statusSelect");
  const ignoreCount = document.getElementById("ignoreCount");

  const messagesDiv = document.getElementById("messages");
  const chatForm = document.getElementById("chatForm");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  const adminClearBtn = document.getElementById("adminClearBtn");
  const emojiBtn = document.getElementById("emojiBtn");

  const replyPreview = document.getElementById("replyPreview");
  const replyPreviewName = document.getElementById("replyPreviewName");
  const replyPreviewText = document.getElementById("replyPreviewText");
  const replyCancelBtn = document.getElementById("replyCancelBtn");

  const emojiPicker = document.getElementById("emojiPicker");
  const emojiGrid = document.getElementById("emojiGrid");

  const modal = document.getElementById("modal");
  const modalErr = document.getElementById("modalErr");
  const formBox = document.getElementById("formBox");
  const chooseLogin = document.getElementById("chooseLogin");
  const chooseGuest = document.getElementById("chooseGuest");

  const homeBtn = document.getElementById("homeBtn");
  const backListBtn = document.getElementById("backListBtn");

  const nameInput = document.getElementById("nameInput");
  const genderInput = document.getElementById("genderInput");
  const ageInput = document.getElementById("ageInput");
  const countryInput = document.getElementById("countryInput");
  const nameColorInput = document.getElementById("nameColor");
  const textColorInput = document.getElementById("textColor");
  const enterBtn = document.getElementById("enterBtn");

  const adminUser = document.getElementById("adminUser");
  const adminPass = document.getElementById("adminPass");
  const adminLoginBtn = document.getElementById("adminLoginBtn");
  const adminErr = document.getElementById("adminErr");

  const ctxMenu = document.getElementById("ctxMenu");
  const modActions = document.getElementById("modActions");
  const rankActions = document.getElementById("rankActions");

  const ctxKickBtn = document.getElementById("ctxKickBtn");
  const ctxMuteBtn = document.getElementById("ctxMuteBtn");
  const ctxUnmuteBtn = document.getElementById("ctxUnmuteBtn");
  const ctxBanBtn = document.getElementById("ctxBanBtn");
  const ctxUnbanBtn = document.getElementById("ctxUnbanBtn");

  const ctxRankLegend = document.getElementById("ctxRankLegend");
  const ctxRankVip    = document.getElementById("ctxRankVip");
  const ctxRankRoot   = document.getElementById("ctxRankRoot");
  const ctxRankGirl   = document.getElementById("ctxRankGirl");
  const ctxRankNone   = document.getElementById("ctxRankNone");

  const roomMenu = document.getElementById("roomMenu");
  const roomLockBtn = document.getElementById("roomLockBtn");
  const roomUnlockBtn = document.getElementById("roomUnlockBtn");

  const selfMuteBtn = document.getElementById("selfMuteBtn");
  const selfUnmuteBtn = document.getElementById("selfUnmuteBtn");

  const bg1Btn = document.getElementById("bg1Btn");
  const bg2Btn = document.getElementById("bg2Btn");
  const bg3Btn = document.getElementById("bg3Btn");
  const bg0Btn = document.getElementById("bg0Btn");

  const siteBgLayer = document.getElementById("siteBgLayer");
  const chatHint = document.getElementById("chatHint");

  const appModal = document.getElementById("appModal");
  const appModalTitle = document.getElementById("appModalTitle");
  const appModalText = document.getElementById("appModalText");
  const appModalActions = document.getElementById("appModalActions");

  const toastSound = new Audio("toast.mp3");
  toastSound.preload = "auto";
  toastSound.volume = 1.0;

  let user = null;
  let profile = null;
  let joinAtMs = null;
  let initialLoaded = false;
  let lastSoundAt = 0;

  const adminSessionKey = (uid) => `adminSession_${uid}`;
  let isAdmin = false;
  let isGuest = false;

  const ignoreKey = (uid) => `chatIgnoreWindows_${uid}`;
  const profKey   = (uid) => `chatProfile_${uid}`;
  const statusKey = (uid) => `chatStatus_${uid}`;

  let ignoreWindows = {};
  let replyTarget = null;
  let roomLocked = false;

  const BAD_WORDS = ["fuck","shit","bitch","asshole","ÙƒØ³","Ø²Ø¨","Ø´Ø±Ù…ÙˆØ·","Ù‚Ø­Ø¨Ù‡","Ù…Ù†ÙŠÙƒ","Ø®ÙˆÙ„","Ø·ÙŠØ²"];
  const EMOJIS = "ğŸ˜€ğŸ˜…ğŸ˜‚ğŸ¤£ğŸ˜ŠğŸ˜ğŸ˜˜ğŸ˜ğŸ¤©ğŸ¥³ğŸ˜¡ğŸ˜­ğŸ˜±ğŸ‘ğŸ‘ğŸ’“ğŸ™ğŸ”¥ğŸ’›â­ğŸ’›ğŸ®ğŸ’€".split("");

  /* âœ… RANKS */
  const RANKS = {
    none:  { label:"Ø¨Ø¯ÙˆÙ†",     emoji:"",   rowClass:"" },
    legend:{ label:"Legendary",emoji:"âš¡",  rowClass:"rank-legend" },
    vip:   { label:"VIP",      emoji:"ğŸ’",  rowClass:"rank-vip" },
    root:  { label:"ROOT",     emoji:"ğŸ›¡ï¸",  rowClass:"rank-root" },
    girl:  { label:"GIRL",     emoji:"ğŸ€",  rowClass:"rank-girl" }
  };
  let ranksMap = {}; // uid -> rank

  function rankOf(uid){ return ranksMap?.[uid] || "none"; }
  function rankEmoji(r){ return (RANKS[r] || RANKS.none).emoji || ""; }

  // âœ… ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø±ØªØ¨ (ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø­: Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
  function myRank(){ return rankOf(user?.uid); }
  function hasAnyRank(uid){ return rankOf(uid) && rankOf(uid) !== "none"; }
  function canWriteWhenLocked(){ return isAdmin || hasAnyRank(user?.uid); }
  function canClear(){ return isAdmin; } // âœ… Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
  function canKick(){
    const r = myRank();
    return isAdmin || r === "root" || r === "vip" || r === "girl";
  }
  function canMute(){
    const r = myRank();
    return isAdmin || r === "root" || r === "vip" || r === "legend" || r === "girl";
  }
  function canBan(){
    const r = myRank();
    return isAdmin || r === "root";
  }

  function rankIconHtml(r){
    if (!r || r === "none") return "";
    return `<span class="rankIcon" title="${escapeHtml(RANKS[r]?.label||"")}">${escapeHtml(rankEmoji(r))}</span>`;
  }

  /* âœ… Country code -> flag emoji */
  function countryCodeToFlagEmoji(cc){
    const c = String(cc||"").toUpperCase();
    if (c.length !== 2) return "ğŸ³ï¸";
    return String.fromCodePoint(...[...c].map(ch => 127397 + ch.charCodeAt()));
  }

  /* âœ… Ø¥ØµÙ„Ø§Ø­ vh Ø¨Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  function setVh(){
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty("--vh", `${vh}px`);
  }
  setVh();
  window.addEventListener("resize", setVh);
  window.addEventListener("orientationchange", setVh);

  /* âœ… Drawer Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† (Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙÙ‚Ø·) */
  const onlineCard = document.getElementById("onlineCard");
  const openOnlineBtn = document.getElementById("openOnlineBtn");
  const onlineOverlay = document.getElementById("onlineOverlay");

  function isMobileView(){ return window.matchMedia("(max-width: 900px)").matches; }
  function openOnlineDrawer(){
    if (!isMobileView()) return;
    onlineCard.classList.add("drawer-open");
    onlineOverlay.classList.add("show");
  }
  function closeOnlineDrawer(){
    onlineCard.classList.remove("drawer-open");
    onlineOverlay.classList.remove("show");
  }
  if (openOnlineBtn){
    openOnlineBtn.addEventListener("click", ()=>{
      if (onlineCard.classList.contains("drawer-open")) closeOnlineDrawer();
      else openOnlineDrawer();
    });
  }
  if (onlineOverlay){
    onlineOverlay.addEventListener("click", closeOnlineDrawer);
  }

  const root = document.documentElement;
  document.addEventListener("mousemove", (e)=>{
    const xRatio = e.clientX / window.innerWidth - 0.5;
    const yRatio = e.clientY / window.innerHeight - 0.5;
    const maxShift = 40;
    root.style.setProperty("--grid-x", (xRatio * maxShift).toFixed(1) + "px");
    root.style.setProperty("--grid-y", (yRatio * maxShift).toFixed(1) + "px");
  });

  function setErr(el, msg){
    el.style.display = msg ? "block" : "none";
    el.textContent = msg || "";
  }
  function collapseSpaces(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function escapeHtml(s=""){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }
  function formatTime(tsMs){
    if (!tsMs || Number.isNaN(tsMs)) return "";
    const d = new Date(tsMs);
    let h = d.getHours();
    const m = String(d.getMinutes()).padStart(2,"0");
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if (h === 0) h = 12;
    return `${h}:${m} ${ampm}`;
  }
  function statusLabel(s){
    switch(s){
      case "online": return "ğŸŸ¢ Ù…ØªØµÙ„";
      case "busy": return "â›” Ù…Ø´ØºÙˆÙ„";
      case "work": return "ğŸ’¼ Ø¨Ø§Ù„Ø¹Ù…Ù„";
      case "car": return "ğŸš— Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø©";
      case "food": return "ğŸ” Ø·Ø¹Ø§Ù…";
      case "out": return "ğŸŒ™ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬";
      default: return "ğŸŸ¢ Ù…ØªØµÙ„";
    }
  }
  function isProfane(text){
    const t = String(text||"").toLowerCase();
    return BAD_WORDS.some(w => t.includes(w));
  }
  function randHexColor(){
    const n = Math.floor(Math.random()*0xFFFFFF);
    return "#" + n.toString(16).padStart(6,"0");
  }

  function showAppModal({title="ØªÙ†Ø¨ÙŠÙ‡", text="â€”", actions=[{label:"Ø­Ø³Ù†Ø§Ù‹", onClick:()=>hideAppModal()}]}={}){
    appModalTitle.textContent = title;
    appModalText.textContent = text;
    appModalActions.innerHTML = "";
    actions.forEach(a=>{
      const b = document.createElement("button");
      b.className = "modalBtn";
      b.type = "button";
      b.textContent = a.label || "Ø­Ø³Ù†Ø§Ù‹";
      b.addEventListener("click", ()=>{
        try{ a.onClick && a.onClick(); }catch{}
      });
      appModalActions.appendChild(b);
    });
    appModal.style.display = "flex";
  }
  function hideAppModal(){ appModal.style.display = "none"; }
  appModal.addEventListener("click",(e)=>{ if (e.target === appModal) hideAppModal(); });

  /* âœ… color + download open new tabs */
  colorBtn.addEventListener("click", ()=> window.open("color.html", "_blank"));
  downloadBtn.addEventListener("click", ()=> window.open("downloadpc.html", "_blank"));

  /* âœ… Emoji picker */
  let activeEmojiTarget = null;
  function buildEmojiGrid(){
    emojiGrid.innerHTML = "";
    EMOJIS.forEach(em=>{
      const b = document.createElement("div");
      b.className = "emojiItem";
      b.textContent = em;
      b.addEventListener("click", ()=>{
        if (activeEmojiTarget) insertAtCursor(activeEmojiTarget, em);
        hideEmoji();
      });
      emojiGrid.appendChild(b);
    });
  }
  buildEmojiGrid();

  function showEmojiFor(inputEl){
    activeEmojiTarget = inputEl;
    emojiPicker.style.display = "block";
    emojiPicker.setAttribute("aria-hidden","false");
  }
  function hideEmoji(){
    emojiPicker.style.display = "none";
    emojiPicker.setAttribute("aria-hidden","true");
    activeEmojiTarget = null;
  }
  function insertAtCursor(input, text){
    const start = input.selectionStart ?? input.value.length;
    const end   = input.selectionEnd ?? input.value.length;
    input.value = input.value.slice(0,start) + text + input.value.slice(end);
    const pos = start + text.length;
    input.setSelectionRange(pos,pos);
    input.focus();
  }

  document.addEventListener("click",(e)=>{
    if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) hideEmoji();
    if (!ctxMenu.contains(e.target)) hideCtxMenu();
    if (!roomMenu.contains(e.target) && e.target !== bgBtn && !e.target.closest?.(".adminRoomDots")) hideRoomMenu();
  });

  emojiBtn.addEventListener("click",(e)=>{ e.preventDefault(); showEmojiFor(msgInput); });

  /* âœ… Ignore */
  function loadIgnoreWindows(){
    try{ ignoreWindows = JSON.parse(localStorage.getItem(ignoreKey(user.uid)) || "{}"); }
    catch{ ignoreWindows = {}; }
    refreshIgnoreCount();
  }
  function saveIgnoreWindows(){
    localStorage.setItem(ignoreKey(user.uid), JSON.stringify(ignoreWindows));
    refreshIgnoreCount();
  }
  function refreshIgnoreCount(){
    let count=0;
    for (const k in ignoreWindows){
      const arr = ignoreWindows[k] || [];
      if (arr.some(w => w.end == null)) count++;
    }
    ignoreCount.textContent = `ØªØ¬Ø§Ù‡Ù„: ${count}`;
  }
  function isCurrentlyIgnored(uid){
    const arr = ignoreWindows[uid] || [];
    return arr.some(w => w.end == null);
  }
  function isInIgnoreWindow(uid, t){
    const arr = ignoreWindows[uid] || [];
    for (const w of arr){
      const start = w.start ?? 0;
      const end = (w.end == null) ? Infinity : w.end;
      if (t >= start && t <= end) return true;
    }
    return false;
  }
  function toggleIgnore(uid){
    if (ADMIN_UIDS.includes(uid)) return;
    ignoreWindows[uid] = ignoreWindows[uid] || [];
    const arr = ignoreWindows[uid];
    const activeIdx = arr.findIndex(w => w.end == null);
    const now = nowMs();
    if (activeIdx >= 0) arr[activeIdx].end = now;
    else arr.push({start: now, end: null});
    saveIgnoreWindows();
  }

  /* âœ… Context menu */
  let ctxUser = null;
  function showCtxMenu(x,y){
    ctxMenu.style.left = x + "px";
    ctxMenu.style.top  = y + "px";
    ctxMenu.style.display = "block";
  }
  function hideCtxMenu(){
    ctxMenu.style.display = "none";
    ctxUser = null;
  }

  function showRoomMenu(x,y){
    roomMenu.style.left = x + "px";
    roomMenu.style.top  = y + "px";
    roomMenu.style.display = "block";

    const showAdmin = !!isAdmin;
    selfMuteBtn.style.display   = showAdmin ? "block" : "none";
    selfUnmuteBtn.style.display = showAdmin ? "block" : "none";
    bg1Btn.style.display = showAdmin ? "block" : "none";
    bg2Btn.style.display = showAdmin ? "block" : "none";
    bg3Btn.style.display = showAdmin ? "block" : "none";
    bg0Btn.style.display = showAdmin ? "block" : "none";
  }
  function hideRoomMenu(){ roomMenu.style.display = "none"; }

  bgBtn.addEventListener("click",(e)=>{
    e.preventDefault();
    if (!isAdmin) return;
    const r = bgBtn.getBoundingClientRect();
    showRoomMenu(Math.round(r.left), Math.round(r.bottom + 8));
  });

  async function writeSystemText(text, type="system", actor={}){
    await addDoc(collection(db, "globalMessages"), {
      system:true, type, text,
      actorUid: actor.uid || null,
      actorName: actor.name || null,
      createdAt: serverTimestamp(),
      createdAtMs: nowMs()
    });
  }

  async function writePrivateSystem(text, toUids=[], type="private"){
    await addDoc(collection(db, "globalMessages"), {
      system:true, type,
      text,
      private:true,
      to: Array.from(new Set(toUids)).filter(Boolean),
      createdAt: serverTimestamp(),
      createdAtMs: nowMs()
    });
  }

  async function writeActionLog(action, details=""){
    try{
      await addDoc(collection(db, "globalLogs"), {
        action,
        details,
        byUid: user?.uid || null,
        byName: profile?.name || "â€”",
        byRank: isAdmin ? "admin" : (myRank() || "none"),
        atMs: nowMs(),
        createdAt: serverTimestamp()
      });
    }catch{}
  }

  function showLogsModal(lines){
    showAppModal({
      title:"ğŸ“œ Ø³Ø¬Ù„",
      text: lines.join("\n") || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹.",
      actions:[{label:"Ø¥ØºÙ„Ø§Ù‚", onClick:()=>hideAppModal()}]
    });
  }

  logBtn.addEventListener("click", async ()=>{
    if (!isAdmin) return;
    try{
      const ql = query(collection(db, "globalLogs"), orderBy("atMs","desc"), limit(80));
      const snap = await getDocs(ql);
      const lines = [];
      snap.forEach(d=>{
        const x = d.data()||{};
        const t = formatTime(Number(x.atMs||0));
        const who = x.byName || "â€”";
        const rk = x.byRank || "â€”";
        lines.push(`${t} â€¢ ${who} (${rk}) â€¢ ${x.action}${x.details ? " â€” " + x.details : ""}`);
      });
      showLogsModal(lines.reverse());
    }catch(err){
      showLogsModal(["ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ (ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Firestore Rules Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© globalLogs)."]);
    }
  });

  /* âœ… Moderation */
  async function adminKick(targetUid, targetName){
    await update(ref(rtdb, `moderation/${targetUid}`), { kickedAt: nowMs(), reason:"kick", by:user.uid });
    await writeSystemText(`ğŸšª ØªÙ… Ø·Ø±Ø¯ ${targetName} Ø¨ÙˆØ§Ø³Ø·Ø© ${profile?.name||"â€”"}`, "kick", {uid:user.uid,name:profile?.name});
    await writeActionLog("kick", targetName);
  }
  async function adminBan(targetUid, targetName){
    await update(ref(rtdb, `moderation/${targetUid}`), { banned:true, bannedAt: nowMs(), reason:"ban", by:user.uid });
    await writeSystemText(`â›” ØªÙ… Ø­Ø¸Ø± ${targetName} Ø¨ÙˆØ§Ø³Ø·Ø© ${profile?.name||"â€”"}`, "ban", {uid:user.uid,name:profile?.name});
    await writeActionLog("ban", targetName);
  }
  async function adminUnban(targetUid, targetName){
    await update(ref(rtdb, `moderation/${targetUid}`), { banned:false, unbannedAt: nowMs(), reason:"unban", by:user.uid });
    await writeSystemText(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± ${targetName} Ø¨ÙˆØ§Ø³Ø·Ø© ${profile?.name||"â€”"}`, "unban", {uid:user.uid,name:profile?.name});
    await writeActionLog("unban", targetName);
  }
  async function adminMute(targetUid, targetName){
    await update(ref(rtdb, `moderation/${targetUid}`), { muted:true, mutedUntil:0, reason:"mute", by:user.uid, mutedAt: nowMs() });
    await update(ref(rtdb, `onlineUsers/${targetUid}`), { muted:true });
    await writeSystemText(`ğŸ”‡ ØªÙ… ÙƒØªÙ… ${targetName} Ø¨ÙˆØ§Ø³Ø·Ø© ${profile?.name||"â€”"}`, "mute", {uid:user.uid,name:profile?.name});
    await writeActionLog("mute", targetName);
  }
  async function adminUnmute(targetUid, targetName){
    await update(ref(rtdb, `moderation/${targetUid}`), { muted:false, mutedUntil:0, reason:"unmute", by:user.uid, unmutedAt: nowMs() });
    await update(ref(rtdb, `onlineUsers/${targetUid}`), { muted:false });
    await writeSystemText(`ğŸ”Š ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… ${targetName} Ø¨ÙˆØ§Ø³Ø·Ø© ${profile?.name||"â€”"}`, "unmute", {uid:user.uid,name:profile?.name});
    await writeActionLog("unmute", targetName);
  }

  async function setRank(targetUid, targetName, rank){
    if (!isAdmin) return;
    if (!targetUid || targetUid === user.uid) return;

    const r = (rank && RANKS[rank]) ? rank : "none";
    await set(ref(rtdb, `ranks/${targetUid}`), {
      rank: r,
      by: user.uid,
      byName: profile?.name || "Admin",
      at: nowMs()
    });

    try{ await update(ref(rtdb, `onlineUsers/${targetUid}`), { rank: r }); }catch{}

    const msg = (r === "none")
      ? `ğŸ§½ ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±ØªØ¨Ø© Ø¹Ù† ${targetName}`
      : `ğŸ·ï¸ ØªÙ… Ø¥Ø¹Ø·Ø§Ø¡ ${targetName} Ø±ØªØ¨Ø© ${rankEmoji(r)}`;

    await writePrivateSystem(msg, [user.uid, targetUid], "rank");
    await writeActionLog("rank", `${targetName} -> ${r}`);

    ranksMap[targetUid] = r;
  }

  /* âœ… Clear for ALL including admin (cutoff for everyone) */
  async function adminClearForAll(){
    if (!isAdmin) return;

    const clearedAtMs = nowMs();
    await setDoc(doc(db, "globalMeta", "clear"), {
      clearedAtMs,
      byUid:user.uid,
      byName: profile?.name || "â€”",
      createdAt: serverTimestamp()
    }, { merge:true });

    await writeSystemText(`ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù†Øµ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†`, "clear", {uid:user.uid,name:profile?.name});
    await writeActionLog("clear", "");
  }
  adminClearBtn.addEventListener("click",(e)=>{ e.preventDefault(); adminClearForAll(); });

  async function updatePresenceStatus(statusVal, first=false){
    const onlineRef = ref(rtdb, "onlineUsers/" + user.uid);
    const device = window.matchMedia("(pointer: coarse)").matches ? "mobile" : "pc";

    const payload = {
      uid: user.uid,
      name: profile.name,
      gender: profile.gender, // kept, but not shown in online list
      age: profile.age,
      country: profile.country || "",
      nameColor: profile.nameColor,
      textColor: profile.textColor,
      status: statusVal || "online",
      statusText: statusLabel(statusVal || "online"),
      device,
      isAdmin,
      isGuest,
      muted:false,
      rank: rankOf(user.uid)
    };
    await set(onlineRef, payload);
    if (first) onDisconnect(onlineRef).remove();
  }

  async function writeJoinLeave(type){
    const text =
      type === "join" ? `${profile.name} Ø¯Ø®Ù„ Ø§Ù„Ø´Ø§Øª` :
      type === "leave" ? `${profile.name} Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø´Ø§Øª` : "";
    return addDoc(collection(db, "globalMessages"), {
      system:true, type, text,
      actorUid:user.uid, actorName:profile.name,
      createdAt: serverTimestamp(), createdAtMs: nowMs()
    });
  }

  function watchConnection(){
    const connRef = ref(rtdb, ".info/connected");
    onValue(connRef, (snap)=>{
      const connected = snap.val() === true;
      connDot.classList.toggle("on", connected);
      connText.textContent = connected ? "Ù…ØªØµÙ„" : "ØºÙŠØ± Ù…ØªØµÙ„";
    });
  }

  function startModerationListener(){
    onValue(ref(rtdb, `moderation/${user.uid}`), async (snap)=>{
      const m = snap.val();
      if (!m) return;

      if (m.banned === true){
        showAppModal({
          title:"â›” ØªÙ… Ø­Ø¸Ø±Ùƒ",
          text:"ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ù„Ø´Ø§Øª.\nØ³ÙŠØªÙ… Ø¥Ø®Ø±Ø§Ø¬Ùƒ Ø§Ù„Ø¢Ù†.",
          actions:[{label:"Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‡ÙˆÙ…", onClick:()=>forceExitToHome()}]
        });
        setTimeout(forceExitToHome, 1200);
        return;
      }

      if (m.kickedAt && nowMs() - m.kickedAt < 15000){
        showAppModal({
          title:"ğŸšª ØªÙ… Ø·Ø±Ø¯Ùƒ",
          text:"ØªÙ… Ø·Ø±Ø¯Ùƒ Ù…Ù† Ø§Ù„Ø´Ø§Øª.\nØ³ÙŠØªÙ… Ø¥Ø®Ø±Ø§Ø¬Ùƒ Ø§Ù„Ø¢Ù†.",
          actions:[{label:"Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‡ÙˆÙ…", onClick:()=>forceExitToHome()}]
        });
        setTimeout(forceExitToHome, 1200);
        return;
      }

      const until = m.mutedUntil || 0;
      const muted = (m.muted === true) || (nowMs() < until);

      if (roomLocked && !canWriteWhenLocked()){
        msgInput.disabled = true;
        sendBtn.disabled = true;
        msgInput.placeholder = "ğŸš« Ø§Ù„Ø±ÙˆÙ… Ù…Ù‚ÙÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†";
      } else {
        if (isAdmin){
          msgInput.disabled = false;
          sendBtn.disabled = false;
          msgInput.placeholder = "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...";
        } else {
          msgInput.disabled = muted;
          sendBtn.disabled = muted;
          msgInput.placeholder = muted ? "ØªÙ… ÙƒØªÙ…Ùƒ" : "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...";
        }
      }

      try{ await update(ref(rtdb, `onlineUsers/${user.uid}`), { muted: !!muted }); }catch{}
    });
  }

  function forceExitToHome(){
    try{ remove(ref(rtdb, "onlineUsers/" + user.uid)); }catch{}
    location.href = "index.html";
  }

  let globalClearedAtMs = 0;
  function startClearMetaListener(){
    onSnapshot(doc(db, "globalMeta", "clear"), (snap)=>{
      if (!snap.exists()) return;
      const d = snap.data() || {};
      globalClearedAtMs = Number(d.clearedAtMs || 0);
    });
  }

  function startRoomLockListener(){
    onValue(ref(rtdb, "roomState/locked"), (snap)=>{
      roomLocked = snap.val() === true;
      chatHint.innerHTML = roomLocked ? "ğŸš« Ø§Ù„Ø±ÙˆÙ… Ù…Ù‚ÙÙ„" : 'Ø¯Ø±Ø¯Ø´ ÙˆØ®Ù„ÙŠ Ø§Ù„Ø´Ø¨Ø§Ø¨ <span style="color:#facc15">ØªØ³ØªÙØ§Ø¯</span>';

      if (roomLocked && !canWriteWhenLocked()){
        msgInput.disabled = true;
        sendBtn.disabled = true;
        msgInput.placeholder = "ğŸš« Ø§Ù„Ø±ÙˆÙ… Ù…Ù‚ÙÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†";
      } else {
        if (msgInput.placeholder === "ğŸš« Ø§Ù„Ø±ÙˆÙ… Ù…Ù‚ÙÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†"){
          msgInput.disabled = false;
          sendBtn.disabled = false;
          msgInput.placeholder = "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...";
        }
      }
    });
  }

  async function setRoomLocked(next){
    if (!isAdmin) return;
    await set(ref(rtdb, "roomState/locked"), !!next);
    await writeSystemText(next ? `ğŸ”’ ${profile?.name||"â€”"} Ù‚ÙÙ„ Ø§Ù„Ø±ÙˆÙ…` : `ğŸ”“ ${profile?.name||"â€”"} ÙØªØ­ Ø§Ù„Ø±ÙˆÙ…`, next ? "lock" : "unlock", {uid:user.uid,name:profile?.name});
    await writeActionLog(next ? "lock" : "unlock", "");
  }

  roomLockBtn.addEventListener("click", async ()=>{
    hideRoomMenu();
    await setRoomLocked(true);
  });
  roomUnlockBtn.addEventListener("click", async ()=>{
    hideRoomMenu();
    await setRoomLocked(false);
  });

  selfMuteBtn.addEventListener("click", async ()=>{
    hideRoomMenu();
    if (!isAdmin || !user) return;
    await update(ref(rtdb, `moderation/${user.uid}`), { muted:true, mutedUntil:0, reason:"selfMute", by:user.uid, mutedAt: nowMs() });
    await update(ref(rtdb, `onlineUsers/${user.uid}`), { muted:true });
    await writeSystemText(`ğŸ”‡ Ø§Ù„Ø£Ø¯Ù…Ù† ÙƒØªÙ… Ù†ÙØ³Ù‡`, "selfMute", {uid:user.uid,name:profile?.name});
    await writeActionLog("selfMute", "");
  });
  selfUnmuteBtn.addEventListener("click", async ()=>{
    hideRoomMenu();
    if (!isAdmin || !user) return;
    await update(ref(rtdb, `moderation/${user.uid}`), { muted:false, mutedUntil:0, reason:"selfUnmute", by:user.uid, unmutedAt: nowMs() });
    await update(ref(rtdb, `onlineUsers/${user.uid}`), { muted:false });
    await writeSystemText(`ğŸ”Š Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙƒ ÙƒØªÙ… Ù†ÙØ³Ù‡`, "selfUnmute", {uid:user.uid,name:profile?.name});
    await writeActionLog("selfUnmute", "");
  });

  /* âœ… Global background (admin sets; all users see) */
  const BG_DOC = doc(db, "globalSettings", "ui");
  function bgUrlFromChoice(n){
    const nn = Number(n||0);
    if (nn === 1) return 'url("back1.gif")';
    if (nn === 2) return 'url("back2.gif")';
    if (nn === 3) return 'url("back3.gif")';
    return "none";
  }
  function applySiteBg(choice){
    const css = bgUrlFromChoice(choice);
    siteBgLayer.style.backgroundImage = css === "none" ? "" : css;
    siteBgLayer.style.display = css === "none" ? "none" : "block";
  }
  function startGlobalBgListener(){
    onSnapshot(BG_DOC, (snap)=>{
      if (!snap.exists()) { applySiteBg(0); return; }
      const d = snap.data() || {};
      applySiteBg(Number(d.bgChoice || 0));
    }, ()=>{ /* ignore */ });
  }
  async function setGlobalBg(choice){
    if (!isAdmin) return;
    await setDoc(BG_DOC, {
      bgChoice: Number(choice||0),
      updatedAt: serverTimestamp(),
      updatedBy: user?.uid || null
    }, { merge:true });
    await writeActionLog("bg", `bgChoice=${Number(choice||0)}`);
  }
  bg1Btn.addEventListener("click", async ()=>{ hideRoomMenu(); await setGlobalBg(1); });
  bg2Btn.addEventListener("click", async ()=>{ hideRoomMenu(); await setGlobalBg(2); });
  bg3Btn.addEventListener("click", async ()=>{ hideRoomMenu(); await setGlobalBg(3); });
  bg0Btn.addEventListener("click", async ()=>{ hideRoomMenu(); await setGlobalBg(0); });

  /* âœ… Watch ranks in RTDB */
  function startRanksListener(){
    onValue(ref(rtdb, "ranks"), (snap)=>{
      const v = snap.val() || {};
      const map = {};
      Object.keys(v).forEach(uid=>{
        const r = v[uid]?.rank || "none";
        map[uid] = (RANKS[r] ? r : "none");
      });
      ranksMap = map;

      if (user && profile){
        try{ update(ref(rtdb, `onlineUsers/${user.uid}`), { rank: rankOf(user.uid) }); }catch{}
      }

      adminClearBtn.style.display = isAdmin ? "inline-flex" : "none"; // âœ… admin only
    });
  }

  function startOnlineListener(){
    onValue(ref(rtdb, "onlineUsers"), (snap)=>{
      const users = snap.val() || {};
      const arr = Object.values(users);

      onlineCount.textContent = String(arr.length);
      onlineList.innerHTML = "";

      arr.sort((a,b)=>{
        const aAdmin = (a.isAdmin === true) || ADMIN_UIDS.includes(a.uid);
        const bAdmin = (b.isAdmin === true) || ADMIN_UIDS.includes(b.uid);
        if (aAdmin !== bAdmin) return aAdmin ? -1 : 1;
        return (a.name||"").localeCompare(b.name||"");
      }).forEach((u)=>{
        const isRowAdmin = (u.isAdmin === true) || ADMIN_UIDS.includes(u.uid);
        const row = document.createElement("div");

        // âœ… apply rank row class (whole row bg)
        const ru = isRowAdmin ? "none" : (u.rank || rankOf(u.uid));
        const rankRowClass = (ru && ru !== "none") ? (RANKS[ru]?.rowClass || "") : "";
        row.className = "userRow" + (isRowAdmin ? " admin" : "") + (rankRowClass ? (" " + rankRowClass) : "");

        const left = document.createElement("div");
        left.className = "userMeta";

        const guestHtml = u.isGuest ? `<span class="guestPill">[Ø¶ÙŠÙ]</span>` : "";

        // âœ… mute indicator emoji only
        const mutedBadge = (u.muted === true) ? `<span class="mutedEmoji" title="Ù…ÙƒØªÙˆÙ…">ğŸ”‡</span>` : "";

        // âœ… country flag (replaces gender icon in online list)
        const flag = countryCodeToFlagEmoji(u.country || "");

        const nameHtml = `
          ${(!isRowAdmin && ru && ru !== "none") ? rankIconHtml(ru) : ""}
          <span style="color:${escapeHtml(u.nameColor||"#facc15")};font-weight:900">${escapeHtml(u.name || "Ù…Ø³ØªØ®Ø¯Ù…")}</span>
          ${guestHtml}
        `;

        const devIcon = (u.device === "mobile") ? "ğŸ“±" : "ğŸ–¥ï¸";

        left.innerHTML = `
          <b><span title="Ø§Ù„Ø¯ÙˆÙ„Ø©">${flag}</span> ${nameHtml} ${mutedBadge}</b>
          <span>
            <span class="miniPill">
              <span class="devIcon" title="Ø§Ù„Ø¬Ù‡Ø§Ø²">${devIcon}</span>
              <span>${escapeHtml(u.statusText || statusLabel(u.status || "online"))}</span>
            </span>
            ${u.uid === user.uid ? `<span class="miniPill" style="color:${escapeHtml(profile?.nameColor||"#facc15")};border-color:rgba(250,204,21,.55)">Ø£Ù†Øª</span>` : ""}
          </span>
        `;
        row.appendChild(left);

        const actions = document.createElement("div");
        actions.className = "actionsRow";

        // âœ… admin dots still for lock/selfmute menu (NOT backgrounds anymore)
        if (isRowAdmin && isAdmin){
          const dots = document.createElement("button");
          dots.type = "button";
          dots.className = "adminRoomDots";
          dots.textContent = "â‹®";
          dots.title = "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù†";
          dots.addEventListener("click",(e)=>{
            e.stopPropagation();
            roomLockBtn.style.display = roomLocked ? "none" : "block";
            roomUnlockBtn.style.display = roomLocked ? "block" : "none";
            // background options will be shown only when triggered via top bg button, but keeping menu safe
            showRoomMenu(e.clientX, e.clientY);
          });
          actions.appendChild(dots);
        }

        if (u.uid !== user.uid){
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "ignoreBtn";

          const targetIsAdmin = isRowAdmin;
          const ignored = isCurrentlyIgnored(u.uid);

          btn.textContent = ignored ? "ğŸš«" : "â›”";
          btn.classList.toggle("ignored", ignored);
          btn.disabled = targetIsAdmin;
          btn.title = targetIsAdmin ? "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø¯Ù…Ù†" : (ignored ? "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¬Ø§Ù‡Ù„" : "ØªØ¬Ø§Ù‡Ù„");

          btn.addEventListener("click",(e)=>{
            e.stopPropagation();
            if (targetIsAdmin) return;
            toggleIgnore(u.uid);
            const nowIgnored = isCurrentlyIgnored(u.uid);
            btn.textContent = nowIgnored ? "ğŸš«" : "â›”";
            btn.classList.toggle("ignored", nowIgnored);
          });

          actions.appendChild(btn);

          const canSeeDots = isAdmin || canMute() || canKick() || canBan();
          if (canSeeDots){
            const more = document.createElement("button");
            more.type = "button";
            more.className = "moreBtn";
            more.textContent = "â‹®";
            more.title = "Ø®ÙŠØ§Ø±Ø§Øª";

            more.addEventListener("click",(e)=>{
              e.stopPropagation();
              ctxUser = { uid: u.uid, name: u.name, isAdmin: isRowAdmin, isGuest: u.isGuest === true };

              const targetIsAdmin2 = ctxUser.isAdmin === true;
              const showMod = !targetIsAdmin2 && ctxUser.uid !== user.uid;

              const allowKick = showMod && canKick();
              const allowMute = showMod && canMute();
              const allowBan  = showMod && canBan();

              modActions.style.display = (showMod && (allowKick || allowMute || allowBan)) ? "block" : "none";
              ctxKickBtn.style.display = allowKick ? "block" : "none";
              ctxMuteBtn.style.display = allowMute ? "block" : "none";
              ctxUnmuteBtn.style.display = allowMute ? "block" : "none";
              ctxBanBtn.style.display = allowBan ? "block" : "none";
              ctxUnbanBtn.style.display = allowBan ? "block" : "none";

              rankActions.style.display = (isAdmin && showMod) ? "block" : "none";
              showCtxMenu(e.clientX, e.clientY);
            });

            actions.appendChild(more);
          }
        }

        row.appendChild(actions);
        onlineList.appendChild(row);
      });
    });
  }

  function renderMsgTextToHtml(text){
    let esc = escapeHtml(text || "");
    esc = esc.replace(/:!!10/g, '__EMOJI10__');
    esc = esc.replace(/:!!9/g,  '__EMOJI9__');
    esc = esc.replace(/:!!8/g,  '__EMOJI8__');
    esc = esc.replace(/:!!7/g,  '__EMOJI7__');
    esc = esc.replace(/:!!6/g,  '__EMOJI6__');
    esc = esc.replace(/:!!5/g,  '__EMOJI5__');
    esc = esc.replace(/:!!4/g,  '__EMOJI4__');
    esc = esc.replace(/:!!3/g,  '__EMOJI3__');
    esc = esc.replace(/:!!2/g,  '__EMOJI2__');
    esc = esc.replace(/:!!/g,   '__EMOJI1__');

    for (let i=1;i<=10;i++){
      esc = esc.replaceAll(`__EMOJI${i}__`, `<img class="chatEmojiImg" src="emoji${i}.gif" alt="emoji${i}">`);
    }
    return esc;
  }

  function startGlobalMessagesListener(){
    initialLoaded = false;

    const q = __MOBILE_DEVICE
      ? query(collection(db, "globalMessages"), orderBy("createdAt", "asc"), limitToLast(600))
      : query(collection(db, "globalMessages"), where("createdAtMs", ">=", joinAtMs), orderBy("createdAtMs", "asc"));

    onSnapshot(q, (snap)=>{
      messagesDiv.innerHTML = "";
      const isFirst = !initialLoaded;

      // âœ… clear cutoff applies to EVERYONE (including admin now)
      const cutoff = Math.max(joinAtMs || 0, globalClearedAtMs || 0);

      const items = [];
      snap.forEach((docx)=>{
        const m = docx.data();
        const tServer = m.createdAt?.toMillis ? m.createdAt.toMillis() : 0;
        const t = Number(tServer || m.createdAtMs || 0);
        items.push({ id: docx.id, m, t });
      });

      items.sort((a,b)=>{
        if (a.t !== b.t) return a.t - b.t;
        return a.id.localeCompare(b.id);
      });

      for (const it of items){
        const m = it.m;
        const t = it.t;

        if (t < cutoff) continue;

        if (m.system && m.private === true){
          const to = Array.isArray(m.to) ? m.to : [];
          if (!user || !to.includes(user.uid)) continue;
        }

        if (!m.system && m.uid && isInIgnoreWindow(m.uid, t)) continue;

        if (m.system){
          const div = document.createElement("div");
          const isBigBoss = (m.type === "bigBoss");
          div.className = "system" + (isBigBoss ? " systemBigBoss" : "");
          div.textContent = m.text || "";
          messagesDiv.appendChild(div);

          if (!isFirst && (m.type==="join" || m.type==="leave") && m.actorUid && m.actorUid !== user.uid){
            const now = nowMs();
            if (now - lastSoundAt > 800){
              lastSoundAt = now;
              toastSound.currentTime = 0;
              toastSound.play().catch(()=>{});
            }
          }
        } else {
          const row = document.createElement("div");
          row.className = "msgRow" + (m.uid === user.uid ? " me" : "");

          const div = document.createElement("div");
          div.className = "msg" + (m.uid === user.uid ? " me" : "");
          div.dataset.mid = it.id;

          const guestHtml = m.isGuest ? `<span class="guestPill">[Ø¶ÙŠÙ]</span>` : "";

          const isMsgAdmin = (m.isAdmin === true) || (m.uid && ADMIN_UIDS.includes(m.uid));
          const r = (m.rank && RANKS[m.rank]) ? m.rank : rankOf(m.uid);
          const rankIcon = (!isMsgAdmin && r && r !== "none") ? rankIconHtml(r) : "";
          const nameSizeClass = (!isMsgAdmin && r && r !== "none") ? "rankBig" : "";

          const nameHtml = isMsgAdmin
            ? `<span style="color:#facc15;font-weight:900">ğ•„ğ•ƒğ•†ğŸ ãƒ…</span> ${guestHtml}`
            : `${rankIcon}<span style="color:${escapeHtml(m.nameColor || "#facc15")};font-weight:900;font-size:${(r&&r!=="none") ? "1.15rem" : "1rem"}">${escapeHtml(m.name||"Ù…Ø³ØªØ®Ø¯Ù…")}</span> ${guestHtml}`;

          const replyBlock = m.replyTo && m.replyTo.name && m.replyTo.text
            ? `<div class="replyQuote"><b>Ø±Ø¯ Ø¹Ù„Ù‰: ${escapeHtml(m.replyTo.name)}</b><div>${escapeHtml(m.replyTo.text)}</div></div>`
            : "";

          div.innerHTML = `
            <div class="msgHead"><div class="nameTag ${nameSizeClass}">${nameHtml}</div></div>
            ${replyBlock}
            <div style="color:${escapeHtml(m.textColor || "#f9fafb")}">${renderMsgTextToHtml(m.text||"")}</div>
            <div class="msgTimeUnder">${escapeHtml(formatTime(t))}</div>
            <button class="replyBtn" type="button" title="Ø±Ø¯">â†© Ø±Ø¯</button>
          `;

          div.querySelector(".replyBtn").addEventListener("click", ()=>{
            replyTarget = {
              id: it.id,
              uid: m.uid,
              name: m.name || "Ù…Ø³ØªØ®Ø¯Ù…",
              text: String(m.text||"").slice(0,160)
            };
            replyPreviewName.textContent = `Ø±Ø¯ Ø¹Ù„Ù‰: ${replyTarget.name}`;
            replyPreviewText.textContent = replyTarget.text;
            replyPreview.style.display = "flex";
            msgInput.focus();
          });

          row.appendChild(div);
          messagesDiv.appendChild(row);
        }
      }

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      initialLoaded = true;
    });
  }

  replyCancelBtn.addEventListener("click", ()=>{
    replyTarget = null;
    replyPreview.style.display = "none";
  });

  ctxKickBtn.addEventListener("click", async ()=>{
    if (!ctxUser || ctxUser.isAdmin) return;
    if (!canKick()) return;
    await adminKick(ctxUser.uid, ctxUser.name || "Ù…Ø³ØªØ®Ø¯Ù…");
    hideCtxMenu();
  });
  ctxMuteBtn.addEventListener("click", async ()=>{
    if (!ctxUser || ctxUser.isAdmin) return;
    if (!canMute()) return;
    await adminMute(ctxUser.uid, ctxUser.name || "Ù…Ø³ØªØ®Ø¯Ù…");
    hideCtxMenu();
  });
  ctxUnmuteBtn.addEventListener("click", async ()=>{
    if (!ctxUser || ctxUser.isAdmin) return;
    if (!canMute()) return;
    await adminUnmute(ctxUser.uid, ctxUser.name || "Ù…Ø³ØªØ®Ø¯Ù…");
    hideCtxMenu();
  });
  ctxBanBtn.addEventListener("click", async ()=>{
    if (!ctxUser || ctxUser.isAdmin) return;
    if (!canBan()) return;
    await adminBan(ctxUser.uid, ctxUser.name || "Ù…Ø³ØªØ®Ø¯Ù…");
    hideCtxMenu();
  });
  ctxUnbanBtn.addEventListener("click", async ()=>{
    if (!ctxUser || ctxUser.isAdmin) return;
    if (!canBan()) return;
    await adminUnban(ctxUser.uid, ctxUser.name || "Ù…Ø³ØªØ®Ø¯Ù…");
    hideCtxMenu();
  });

  ctxRankLegend.addEventListener("click", async ()=>{ if (!isAdmin || !ctxUser || ctxUser.isAdmin) return; await setRank(ctxUser.uid, ctxUser.name || "Ù…Ø³ØªØ®Ø¯Ù…", "legend"); hideCtxMenu(); });
  ctxRankVip.addEventListener("click", async ()=>{ if (!isAdmin || !ctxUser || ctxUser.isAdmin) return; await setRank(ctxUser.uid, ctxUser.name || "Ù…Ø³ØªØ®Ø¯Ù…", "vip"); hideCtxMenu(); });
  ctxRankRoot.addEventListener("click", async ()=>{ if (!isAdmin || !ctxUser || ctxUser.isAdmin) return; await setRank(ctxUser.uid, ctxUser.name || "Ù…Ø³ØªØ®Ø¯Ù…", "root"); hideCtxMenu(); });
  ctxRankGirl.addEventListener("click", async ()=>{ if (!isAdmin || !ctxUser || ctxUser.isAdmin) return; await setRank(ctxUser.uid, ctxUser.name || "Ù…Ø³ØªØ®Ø¯Ù…", "girl"); hideCtxMenu(); });
  ctxRankNone.addEventListener("click", async ()=>{ if (!isAdmin || !ctxUser || ctxUser.isAdmin) return; await setRank(ctxUser.uid, ctxUser.name || "Ù…Ø³ØªØ®Ø¯Ù…", "none"); hideCtxMenu(); });

  // âœ…âœ…âœ… (Mobile-only) Ø¥Ø±Ø³Ø§Ù„ Ù…Ù† Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø¨Ø¯ÙˆÙ† Ø²Ø± (Enter + Ø¯Ø¨Ù„-Ø³Ø¨ÙŠØ³)
  let __lastSpaceSendAt = 0;
  msgInput.addEventListener("keydown",(e)=>{
    if (!__MOBILE_DEVICE) return;

    if (e.key === "Enter"){
      e.preventDefault();
      if (!msgInput.disabled) chatForm.requestSubmit();
      return;
    }

    if (e.key === " "){
      const v = msgInput.value || "";
      const now = Date.now();
      const fast = (now - __lastSpaceSendAt) < 320;
      __lastSpaceSendAt = now;

      if (fast && collapseSpaces(v).length > 0){
        e.preventDefault();
        if (!msgInput.disabled) chatForm.requestSubmit();
      }
    }
  });

  chatForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if (!user || !profile) return;

    const text = collapseSpaces(msgInput.value);
    if (!text) return;

    if (roomLocked && !canWriteWhenLocked()){
      showAppModal({ title:"ğŸš« Ø§Ù„Ø±ÙˆÙ… Ù…Ù‚ÙÙ„", text:"Ø§Ù„Ø£Ø¯Ù…Ù† Ù‚ÙÙ„ Ø§Ù„Ø±ÙˆÙ…ØŒ Ù…Ø§ Ø¨ØªÙ‚Ø¯Ø± ØªÙƒØªØ¨ Ø§Ù„Ø¢Ù†.", actions:[{label:"Ø­Ø³Ù†Ø§Ù‹", onClick:()=>hideAppModal()}] });
      return;
    }

    if (msgInput.disabled) return;

    if (!isAdmin && isProfane(text)){
      showAppModal({ title:"âŒ Ø±Ø³Ø§Ù„Ø© Ù…Ø±ÙÙˆØ¶Ø©", text:"Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø±ÙÙˆØ¶Ø© (ÙƒÙ„Ø§Ù… ØºÙŠØ± Ù„Ø§Ø¦Ù‚).", actions:[{label:"Ø­Ø³Ù†Ø§Ù‹", onClick:()=>hideAppModal()}] });
      return;
    }

    const replyTo = replyTarget ? { uid: replyTarget.uid, name: replyTarget.name, text: replyTarget.text, id: replyTarget.id } : null;

    msgInput.value = "";
    replyTarget = null;
    replyPreview.style.display = "none";

    await addDoc(collection(db, "globalMessages"), {
      system:false, text,
      uid:user.uid,
      name:profile.name,
      gender:profile.gender,
      age:profile.age,
      country: profile.country || "",
      nameColor:profile.nameColor,
      textColor:profile.textColor,
      isAdmin, isGuest,
      replyTo,
      rank: rankOf(user.uid),
      createdAt: serverTimestamp(),
      createdAtMs: nowMs()
    });
  });

  function cleanupGuestLocal(){
    try{
      if (user?.isAnonymous){
        localStorage.removeItem(profKey(user.uid));
        localStorage.removeItem(statusKey(user.uid));
        localStorage.removeItem(ignoreKey(user.uid));
        localStorage.removeItem(adminSessionKey(user.uid));
      }
    }catch{}
  }

  exitBtn.addEventListener("click", async ()=>{
    try{
      if (user && profile){
        await writeJoinLeave("leave");
        await remove(ref(rtdb, "onlineUsers/" + user.uid));
      }
    }catch{}
    cleanupGuestLocal();
    location.href = "index.html";
  });

  statusSelect.addEventListener("change", async ()=>{
    if (!user || !profile) return;
    const s = statusSelect.value || "online";
    localStorage.setItem(statusKey(user.uid), s);
    await updatePresenceStatus(s);
  });

  adminLoginBtn.addEventListener("click", ()=>{
    setErr(adminErr, "");
    if (!user) return;
    const uidAllowed = ADMIN_UIDS.includes(user.uid);
    if (!uidAllowed){
      setErr(adminErr, "Ù‡Ø°Ù‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨.");
      return;
    }
    const u = (adminUser.value || "").trim();
    const p = (adminPass.value || "").trim();
    if (u !== ADMIN_USERNAME || p !== ADMIN_PASSWORD){
      setErr(adminErr, "Ø¨ÙŠØ§Ù†Ø§Øª ADMIN ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
      return;
    }
    localStorage.setItem(adminSessionKey(user.uid), "1");
    setErr(adminErr, "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†.");
    isAdmin = true;

    logBtn.style.display = "inline-flex";
    bgBtn.style.display  = "inline-flex";
    adminClearBtn.style.display = "inline-flex";

    // âœ… big boss message
    try{ writeSystemText("âœ¨ Ø¯Ø®Ù„ ÙƒØ¨ÙŠØ±Ù‡Ù… âœ¨", "bigBoss", {uid:user.uid,name:profile?.name}); }catch{}
  });

  function showForm(){ formBox.style.display = "block"; }

  homeBtn.addEventListener("click", ()=>{
    cleanupGuestLocal();
    location.href = "index.html";
  });

  backListBtn.addEventListener("click", ()=>{
    setErr(modalErr,"");
    formBox.style.display = "none";
  });

  chooseLogin.addEventListener("click", ()=>{
    setErr(modalErr,"");
    if (!user){ location.href = "login.html"; return; }
    if (user.isAnonymous){ location.href = "login.html"; return; }
    isGuest = false;
    showForm();
  });

  chooseGuest.addEventListener("click", async ()=>{
    setErr(modalErr,"");
    if (user && !user.isAnonymous){
      setErr(modalErr, "Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„â€”Ø§Ø³ØªØ®Ø¯Ù… Ø®ÙŠØ§Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„.");
      return;
    }
    try{
      if (!user){
        await signInAnonymously(auth);
      }
      isGuest = true;
      showForm();
    }catch(err){
      setErr(modalErr, "âŒ ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.");
      console.error(err);
    }
  });

  enterBtn.addEventListener("click", async ()=>{
    setErr(modalErr, "");

    const rawName = collapseSpaces(nameInput.value);
    const g = genderInput.value;
    const age = Number(ageInput.value);
    const country = (countryInput.value || "").trim().toUpperCase();

    if (!rawName || rawName.length < 3){ setErr(modalErr, "Ø§Ù„Ø§Ø³Ù… Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; }
    if (!g){ setErr(modalErr, "Ø§Ø®ØªØ§Ø± Ø§Ù„Ø¬Ù†Ø³."); return; }
    if (!Number.isFinite(age) || age < 10){ setErr(modalErr, "Ø§Ù„Ø¹Ù…Ø± Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 10 Ø£Ùˆ Ø£ÙƒØ«Ø±."); return; }
    if (!country || country.length !== 2){ setErr(modalErr, "Ø§Ø®ØªØ§Ø± Ø§Ù„Ø¯ÙˆÙ„Ø©."); return; }
    if (!user){ setErr(modalErr, "Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹."); return; }

    profile = {
      name: rawName,
      gender: g,
      age,
      country,
      nameColor: nameColorInput.value || "#facc15",
      textColor: textColorInput.value || "#f9fafb"
    };

    if (!user.isAnonymous){
      localStorage.setItem(profKey(user.uid), JSON.stringify(profile));
    }

    const savedStatus = localStorage.getItem(statusKey(user.uid)) || "online";
    statusSelect.value = savedStatus;

    try{
      await enterChat(savedStatus);
    }catch(err){
      console.error(err);
      setErr(modalErr, "âŒ ØµØ§Ø± Ø®Ø·Ø£ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø´Ø§Øª. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.");
    }
  });

  async function enterChat(statusVal){
    isGuest = !!user?.isAnonymous;
    isAdmin = ADMIN_UIDS.includes(user.uid) && (localStorage.getItem(adminSessionKey(user.uid)) === "1") && !isGuest;

    logBtn.style.display = isAdmin ? "inline-flex" : "none";
    bgBtn.style.display  = isAdmin ? "inline-flex" : "none";
    adminClearBtn.style.display = isAdmin ? "inline-flex" : "none";

    msgInput.disabled = false;
    sendBtn.disabled = false;

    joinAtMs = nowMs();

    await updatePresenceStatus(statusVal, true);
    await writeJoinLeave("join");

    modal.style.display = "none";

    loadIgnoreWindows();
    startGlobalBgListener();        // âœ… background visible for all
    startRanksListener();
    startClearMetaListener();
    startRoomLockListener();
    startOnlineListener();
    startGlobalMessagesListener();
    startModerationListener();

    if (roomLocked && !canWriteWhenLocked()){
      msgInput.disabled = true;
      sendBtn.disabled = true;
      msgInput.placeholder = "ğŸš« Ø§Ù„Ø±ÙˆÙ… Ù…Ù‚ÙÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†";
    }

    startDhikrLoop();
    closeOnlineDrawer();
  }

  onAuthStateChanged(auth, async (u)=>{
    user = u || null;
    meBadge.textContent = "Ø£Ù†Øª";
    watchConnection();

    let loadedSaved = false;
    if (user && !user.isAnonymous){
      const savedProfile = localStorage.getItem(profKey(user.uid));
      if (savedProfile){
        try{
          const p = JSON.parse(savedProfile);
          nameInput.value = p.name || "";
          genderInput.value = p.gender || "";
          ageInput.value = p.age || "";
          countryInput.value = p.country || "JO";
          nameColorInput.value = p.nameColor || randHexColor();
          textColorInput.value = p.textColor || randHexColor();
          loadedSaved = true;
        }catch{}
      }
    }
    if (!loadedSaved){
      nameColorInput.value = randHexColor();
      textColorInput.value = randHexColor();
      countryInput.value = "JO";
    }

    formBox.style.display = "none";
    setErr(modalErr, "");
    setErr(adminErr, "");
    modal.style.display = "flex";
  });

  window.addEventListener("beforeunload", ()=>{
    try{
      if (user && profile){
        writeJoinLeave("leave");
        remove(ref(rtdb, "onlineUsers/" + user.uid));
      }
    }catch{}
    cleanupGuestLocal();
  });

  /* âœ… Dhikr notifications */
  const DHIKR = ["ØµÙ„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ÙŠ", "Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡", "Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡", "Ù„Ø§ Ø§Ù„Ù‡ Ø§Ù„Ø§ Ø§Ù„Ù„Ù‡", "Ø§Ù„Ù„Ù‡ Ø§ÙƒØ¨Ø±"];
  let __dhikrStarted = false;
  function showDhikr(){
    const txt = DHIKR[Math.floor(Math.random()*DHIKR.length)];
    const side = Math.random() < .5 ? "left" : "right";
    const top = Math.floor(90 + Math.random() * (window.innerHeight - 200));
    const el = document.createElement("div");
    el.className = "dhikrToast";
    el.textContent = txt;
    el.style.top = top + "px";
    el.style[side] = "14px";
    document.body.appendChild(el);
    setTimeout(()=>{ try{ el.remove(); }catch{} }, 5200);
  }
  function startDhikrLoop(){
    if (__dhikrStarted) return;
    __dhikrStarted = true;
    setTimeout(showDhikr, 1500);
    setInterval(showDhikr, 30000);
  }
</script>
</body>
</html>

