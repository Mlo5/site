<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØºØ±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© - M L O 5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg-dark: #020202;
      --yellow: #facc15;
      --white: #f9fafb;
      --muted: #9ca3af;
      --border-subtle: rgba(156, 163, 175, 0.35);
      --radius-lg: 20px;
      --grid-x: 0px;
      --grid-y: 0px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-dark);
      color: var(--white);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      transition: background 0.3s ease, color 0.3s ease;
      position: relative;
      cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><polygon points='2,2 2,22 8,16 14,26 18,24 12,14 20,14' fill='%23facc15' stroke='%23000000' stroke-width='1.5'/></svg>") 0 0, auto;
    }

    .bg-grid {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, rgba(249, 250, 251, 0.55) 1px, transparent 1px);
      background-size: 30px 30px;
      background-position: calc(50% + var(--grid-x)) calc(50% + var(--grid-y));
      opacity: 0.25;
      mix-blend-mode: screen;
    }

    .page {
      width: 100%;
      max-width: 1100px;
      padding: 32px 16px 40px;
      margin: auto;
      position: relative;
      z-index: 1;
    }

    .card {
      background: linear-gradient(145deg, #020202, #050505);
      border-radius: 18px;
      padding: 14px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(55, 65, 81, 0.6);
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      border-color: rgba(250, 204, 21, 0.65);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.9), 0 0 0 1px rgba(250, 204, 21, 0.35);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
      direction: ltr;
    }

    .top-chip {
      font-size: 0.9rem;
      color: var(--white);
      text-decoration: none;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.6);
      background: rgba(0, 0, 0, 0.6);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(15, 23, 42, 0.9);
      transition: background 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }

    .top-chip:hover {
      background: rgba(250, 204, 21, 0.15);
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.95), 0 0 0 1px rgba(250, 204, 21, 0.7);
    }

    .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      display: inline-block;
    }
    .dot.on { background: rgba(34, 197, 94, 0.95); }

    .title {
      font-family: "Poppins", system-ui, sans-serif;
      font-weight: 800;
      letter-spacing: 0.12em;
      color: var(--white);
      text-transform: uppercase;
      white-space: nowrap;
    }
    .title small { letter-spacing: 0; font-weight: 700; color: var(--muted); }

    /* âœ… Ù†ÙØ³ Ø§Ù„ØªÙ‚Ø³ÙŠÙ…Ø©ØŒ Ø¨Ø³ Ù†Ø®Ù„ÙŠÙ‡Ø§ ØªÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø© */
    .wrap {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
      height: calc(100vh - 32px - 40px - 14px - 44px); /* page padding + topbar + gap ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ */
      min-height: 70vh;
    }

    .panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .panel-head .h { display: flex; flex-direction: column; gap: 2px; }
    .panel-head .h b { color: var(--yellow); font-size: 1rem; }
    .panel-head .h span { color: var(--muted); font-size: 0.85rem; }

    .badge {
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.55);
      padding: 6px 10px;
      font-size: 0.85rem;
      background: rgba(0,0,0,.45);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    /* âœ… online panel flex */
    .onlineCard {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
    }

    #onlineList {
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: auto;
      min-height: 0;
      flex: 1;
      padding-right: 4px;
    }

    .userRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      background: rgba(0,0,0,.55);
      box-shadow: 0 10px 22px rgba(0,0,0,.6);
    }

    .userMeta { display: flex; flex-direction: column; gap: 3px; min-width: 0; }
    .userMeta b {
      font-size: 0.92rem;
      color: var(--white);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }

    .userMeta span {
      font-size: 0.8rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .miniPill {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 3px 8px;
      font-size: 0.75rem;
      background: rgba(0,0,0,.4);
      color: var(--yellow);
      white-space: nowrap;
    }

    .ignoreBtn {
      border: 1px solid rgba(250, 204, 21, 0.55);
      background: rgba(0,0,0,.45);
      color: var(--yellow);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: transform .15s ease, background .15s ease;
      user-select: none;
    }
    .ignoreBtn:hover { transform: translateY(-1px); background: rgba(250,204,21,.12); }
    .ignoreBtn.ignored { border-color: rgba(239,68,68,.8); color: rgba(239,68,68,.95); }

    .statusWrap { display: flex; align-items: center; gap: 8px; justify-content: flex-end; direction: rtl; }

    /* âœ… Ø®Ù„ÙÙŠØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø£Ø³ÙˆØ¯ */
    select, input {
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.55);
      background: #000; /* Ø·Ù„Ø¨Ùƒ */
      color: var(--white);
      padding: 8px 12px;
      outline: none;
      font-size: 0.9rem;
    }

    /* âœ… chat card flex: input Ø¨Ø§Ù„Ø£Ø³ÙÙ„ */
    .chatCard {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
      position: relative;
    }

    #messages {
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: auto;
      min-height: 0;
      flex: 1;
      padding-right: 4px;
      padding-bottom: 6px;
    }

    .msg {
      max-width: 78%;
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      background: rgba(0,0,0,.55);
      box-shadow: 0 10px 22px rgba(0,0,0,.6);
      padding: 10px 12px;
      line-height: 1.5;
      word-break: break-word;
    }

    .msg.me {
      margin-right: auto;
      border-color: rgba(250, 204, 21, 0.75);
      box-shadow: 0 14px 32px rgba(0,0,0,.75), 0 0 0 1px rgba(250, 204, 21, 0.35);
    }

    .msgHead {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .nameTag {
      color: var(--yellow);
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 240px;
    }

    /* âœ… ÙˆÙ‚Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ­Øª Ø§Ù„Ù†Øµ */
    .msgTimeUnder {
      margin-top: 6px;
      font-size: 0.78rem;
      color: rgba(156,163,175,.92);
      text-align: left;
      direction: ltr;
    }

    .system {
      align-self: center;
      color: rgba(156,163,175,.95);
      font-size: 0.9rem;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(250, 204, 21, 0.55);
      background: rgba(0,0,0,.55);
      max-width: 100%;
    }

    /* Composer Ø£Ø³ÙÙ„ */
    .composer {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      direction: rtl;
    }

    #msgInput { flex: 1; border-radius: 999px; }

    .sendBtn, .emojiBtn, .clearBtn {
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.75);
      background: rgba(0,0,0,.75);
      color: var(--yellow);
      padding: 9px 14px;
      cursor: pointer;
      font-weight: 800;
      transition: transform .15s ease, background .15s ease;
      user-select: none;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .emojiBtn, .clearBtn { width: 40px; padding: 0; font-weight: 700; }
    .sendBtn:hover, .emojiBtn:hover, .clearBtn:hover { transform: translateY(-1px); background: rgba(250,204,21,.14); }

    /* Emoji picker */
    .emojiPicker {
      position: absolute;
      bottom: 62px;
      right: 14px;
      width: 280px;
      max-width: calc(100% - 28px);
      border-radius: 18px;
      border: 1px solid rgba(250, 204, 21, 0.55);
      background: rgba(0, 0, 0, 0.92);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.95);
      padding: 10px;
      display: none;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .emojiGrid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 6px;
      max-height: 200px;
      overflow: auto;
      padding-right: 4px;
    }

    .emojiItem {
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(0,0,0,.55);
      border-radius: 12px;
      padding: 6px 0;
      text-align: center;
      cursor: pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select: none;
    }
    .emojiItem:hover {
      transform: translateY(-1px);
      background: rgba(250,204,21,.12);
      border-color: rgba(250,204,21,.5);
    }

    /* gender colors */
    .gMale { color: #3b82f6; font-weight: 900; }
    .gFemale { color: #ec4899; font-weight: 900; }

    /* Modal */
    #modal {
      position: fixed;
      inset: 0;
      z-index: 999;
      background: rgba(0,0,0,.75);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    #modalBox {
      width: min(420px, 96vw);
      border-radius: 18px;
      border: 1px solid rgba(250, 204, 21, 0.55);
      background: rgba(0,0,0,.92);
      box-shadow: 0 18px 45px rgba(0,0,0,.95), 0 0 0 1px rgba(17,24,39,.9);
      padding: 14px;
      backdrop-filter: blur(10px);
    }

    #modalBox h3 {
      margin-bottom: 6px;
      color: var(--yellow);
      text-align: center;
      font-weight: 800;
    }

    #modalBox p {
      text-align: center;
      color: var(--muted);
      font-size: 0.85rem;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .modalRow { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .modalRow.one { grid-template-columns: 1fr; }

    .modalBtn {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.75);
      background: rgba(0,0,0,.75);
      color: var(--yellow);
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 800;
      transition: transform .15s ease, background .15s ease;
    }
    .modalBtn:hover { transform: translateY(-1px); background: rgba(250,204,21,.14); }

    .hintErr {
      margin-top: 8px;
      color: rgba(239, 68, 68, 0.95);
      font-size: 0.85rem;
      text-align: center;
      display: none;
    }

    @media (max-width: 900px) {
      .wrap { grid-template-columns: 1fr; height: auto; }
      .onlineCard, .chatCard { height: auto; }
      .emojiPicker { right: 10px; }
    }
  </style>
</head>

<body>
  <div class="bg-grid"></div>

  <main class="page">
    <div class="top-bar">
      <div class="top-chip" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„">
        <span class="dot" id="connDot"></span>
        <span id="connText">ØºÙŠØ± Ù…ØªØµÙ„</span>
      </div>

      <div class="title">M L O 5 <small>â€¢ Global Chat</small></div>

      <button class="top-chip" id="exitBtn" type="button" title="Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø´Ø§Øª">â†© Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="wrap">
      <!-- Online -->
      <section class="card onlineCard">
        <div class="panel-head">
          <div class="h">
            <b>Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø§Ù„Ø¢Ù†</b>
            <span>Ø§Ù„Ø¹Ø¯Ø¯: <b id="onlineCount">0</b></span>
          </div>

          <div class="statusWrap">
            <span class="badge" id="meBadge">Ø£Ù†Øª</span>
            <select id="statusSelect" title="ØºÙŠÙ‘Ø± Ø­Ø§Ù„ØªÙƒ">
              <option value="online">ğŸŸ¢ Ù…ØªØµÙ„</option>
              <option value="busy">â›” Ù…Ø´ØºÙˆÙ„</option>
              <option value="work">ğŸ’¼ Ø¨Ø§Ù„Ø¹Ù…Ù„</option>
              <option value="car">ğŸš— Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø©</option>
              <option value="food">ğŸ” Ø·Ø¹Ø§Ù…</option>
              <option value="out">ğŸŒ™ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</option>
            </select>
          </div>
        </div>

        <div id="onlineList"></div>
      </section>

      <!-- Chat -->
      <section class="card chatCard">
        <div class="panel-head">
          <div class="h">
            <b>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</b>
            <span>Ù„Ø§ ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ø¦Ù„ Ù‚Ø¨Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</span>
          </div>
          <div class="badge" id="ignoreCount">ØªØ¬Ø§Ù‡Ù„: 0</div>
        </div>

        <div id="messages"></div>

        <!-- âœ… Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„ -->
        <form id="chatForm" class="composer">
          <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" disabled />
          <button class="clearBtn" id="clearBtn" type="button" title="Ù…Ø³Ø­ Ø§Ù„Ù†Øµ">âœ–</button>
          <button class="emojiBtn" id="emojiBtn" type="button" title="Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">ğŸ˜Š</button>
          <button class="sendBtn" id="sendBtn" type="submit" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
        </form>

        <div class="emojiPicker" id="emojiPicker" aria-hidden="true">
          <div class="emojiGrid" id="emojiGrid"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal">
    <div id="modalBox">
      <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <p>Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©).<br>Ø§Ù„Ø¹Ù…Ø± 10+ â€¢ Ø§Ù„Ø§Ø³Ù… 3+ Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ²</p>

      <div class="modalRow one">
        <input id="nameInput" placeholder="Ø§Ø³Ù…Ùƒ (Ø­Ø±ÙˆÙ/Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)" />
      </div>

      <div class="modalRow">
        <select id="genderInput">
          <option value="">Ø§Ù„Ø¬Ù†Ø³</option>
          <option value="male">Ø°ÙƒØ± â™‚ï¸</option>
          <option value="female">Ø£Ù†Ø«Ù‰ â™€ï¸</option>
        </select>

        <input id="ageInput" type="number" min="10" max="99" placeholder="Ø§Ù„Ø¹Ù…Ø± (10+)" />
      </div>

      <button id="enterBtn" class="modalBtn" type="button">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø´Ø§Øª</button>
      <div class="hintErr" id="modalErr"></div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    query, where, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getDatabase, ref, set, onDisconnect, onValue, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBnxruqFdBHEHTSVXl-QK848lsGvwBBH9U",
    authDomain: "mlo5-users.firebaseapp.com",
    databaseURL: "https://mlo5-users-default-rtdb.firebaseio.com",
    projectId: "mlo5-users",
    appId: "1:142086858806:web:64c50f3a8d6250a2049097"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const rtdb = getDatabase(app);

  // UI
  const connDot = document.getElementById("connDot");
  const connText = document.getElementById("connText");
  const exitBtn = document.getElementById("exitBtn");

  const onlineList = document.getElementById("onlineList");
  const onlineCount = document.getElementById("onlineCount");
  const meBadge = document.getElementById("meBadge");
  const statusSelect = document.getElementById("statusSelect");
  const ignoreCount = document.getElementById("ignoreCount");

  const messagesDiv = document.getElementById("messages");
  const chatForm = document.getElementById("chatForm");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");

  const clearBtn = document.getElementById("clearBtn");
  const emojiBtn = document.getElementById("emojiBtn");
  const emojiPicker = document.getElementById("emojiPicker");
  const emojiGrid = document.getElementById("emojiGrid");

  const modal = document.getElementById("modal");
  const modalErr = document.getElementById("modalErr");
  const nameInput = document.getElementById("nameInput");
  const genderInput = document.getElementById("genderInput");
  const ageInput = document.getElementById("ageInput");
  const enterBtn = document.getElementById("enterBtn");

  // âœ… ØµÙˆØª ÙÙ‚Ø· join/leave (ÙˆÙ„Ø§ Ø¹Ù„Ø§Ù‚Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„)
  const toastSound = new Audio("toast.mp3");
  toastSound.preload = "auto";
  toastSound.volume = 1.0;

  // State
  let user = null;
  let profile = null;
  let joinAtMs = null;
  let initialLoaded = false;
  let lastSoundAt = 0;

  // Ignore windows (Ø­ØªÙ‰ Ù„Ù…Ø§ ØªÙÙƒ ØªØ¬Ø§Ù‡Ù„ Ù…Ø§ ÙŠØ¨ÙŠÙ† Ø§Ù„Ù„ÙŠ ÙƒØªØ¨Ù‡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¬Ø§Ù‡Ù„)
  const ignoreKey = (uid) => `chatIgnoreWindows_${uid}`;
  const profKey = (uid) => `chatProfile_${uid}`;
  const statusKey = (uid) => `chatStatus_${uid}`;

  // ignoreWindows[uid] = [{start,end}]
  let ignoreWindows = {};
  let ignoreActiveStart = {}; // uid -> startMs if currently ignored

  // Profanity (Ù…Ø¨Ø¯Ø¦ÙŠ)
  const BAD_WORDS = ["fuck","shit","bitch","asshole","ÙƒØ³","Ø²Ø¨","Ø´Ø±Ù…ÙˆØ·","Ù‚Ø­Ø¨Ù‡","Ù…Ù†ÙŠÙƒ","Ø®ÙˆÙ„","Ø·ÙŠØ²"];

  const EMOJIS = "ğŸ˜€ğŸ˜…ğŸ˜‚ğŸ¤£ğŸ˜ŠğŸ˜ğŸ˜˜ğŸ˜ğŸ¤©ğŸ¥³ğŸ˜¡ğŸ˜­ğŸ˜±ğŸ‘ğŸ‘ğŸ‘ğŸ™ğŸ”¥ğŸ’›â­âš¡ğŸ®ğŸ’€".split("");

  function genderSymbolHtml(g) {
    if (g === "male") return `<span class="gMale">â™‚ï¸</span>`;
    if (g === "female") return `<span class="gFemale">â™€ï¸</span>`;
    return "";
  }

  function statusLabel(s) {
    switch (s) {
      case "online": return "ğŸŸ¢ Ù…ØªØµÙ„";
      case "busy": return "â›” Ù…Ø´ØºÙˆÙ„";
      case "work": return "ğŸ’¼ Ø¨Ø§Ù„Ø¹Ù…Ù„";
      case "car": return "ğŸš— Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø©";
      case "food": return "ğŸ” Ø·Ø¹Ø§Ù…";
      case "out": return "ğŸŒ™ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬";
      default: return "ğŸŸ¢ Ù…ØªØµÙ„";
    }
  }

  function sanitizeName(raw) {
    let n = String(raw || "");
    n = n.replace(/[^0-9A-Za-z\u0600-\u06FF ]+/g, "");
    n = n.replace(/\s+/g, " ").trim();
    return n;
  }

  function isProfane(text) {
    const t = String(text || "").toLowerCase();
    return BAD_WORDS.some(w => t.includes(w));
  }

  function formatTime(tsMs) {
    if (!tsMs || Number.isNaN(tsMs)) return "";
    const d = new Date(tsMs);
    let h = d.getHours();
    const m = String(d.getMinutes()).padStart(2, "0");
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if (h === 0) h = 12;
    return `${h}:${m} ${ampm}`;
  }

  function setModalError(msg) {
    modalErr.style.display = msg ? "block" : "none";
    modalErr.textContent = msg || "";
  }

  // grid parallax
  const root = document.documentElement;
  document.addEventListener("mousemove", (e) => {
    const xRatio = e.clientX / window.innerWidth - 0.5;
    const yRatio = e.clientY / window.innerHeight - 0.5;
    const maxShift = 40;
    root.style.setProperty("--grid-x", (xRatio * maxShift).toFixed(1) + "px");
    root.style.setProperty("--grid-y", (yRatio * maxShift).toFixed(1) + "px");
  });

  // Emoji
  function buildEmojiGrid() {
    emojiGrid.innerHTML = "";
    EMOJIS.forEach(em => {
      const b = document.createElement("div");
      b.className = "emojiItem";
      b.textContent = em;
      b.addEventListener("click", () => {
        insertAtCursor(msgInput, em);
        hideEmoji();
      });
      emojiGrid.appendChild(b);
    });
  }
  buildEmojiGrid();

  function showEmoji() { emojiPicker.style.display = "block"; emojiPicker.setAttribute("aria-hidden", "false"); }
  function hideEmoji() { emojiPicker.style.display = "none"; emojiPicker.setAttribute("aria-hidden", "true"); }
  emojiBtn.addEventListener("click", () => (emojiPicker.style.display === "block" ? hideEmoji() : showEmoji()));
  document.addEventListener("click", (e) => { if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) hideEmoji(); });

  function insertAtCursor(input, text) {
    const start = input.selectionStart ?? input.value.length;
    const end = input.selectionEnd ?? input.value.length;
    input.value = input.value.slice(0, start) + text + input.value.slice(end);
    const pos = start + text.length;
    input.setSelectionRange(pos, pos);
    input.focus();
  }

  // âœ… Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ù†Øµ (Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·)
  clearBtn.addEventListener("click", () => { msgInput.value = ""; msgInput.focus(); });

  // Auth
  onAuthStateChanged(auth, async (u) => {
    if (!u) { location.href = "login.html"; return; }
    user = u;
    meBadge.textContent = "Ø£Ù†Øª";

    // load ignore windows
    try { ignoreWindows = JSON.parse(localStorage.getItem(ignoreKey(user.uid)) || "{}"); } catch { ignoreWindows = {}; }
    ignoreActiveStart = {}; // on load we don't assume active
    refreshIgnoreCount();

    watchConnection();

    // âœ… Ù„Ø§ ØªØ¹ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø°Ø§ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù…Ø­ÙÙˆØ¸
    const savedProfile = localStorage.getItem(profKey(user.uid));
    if (savedProfile) {
      profile = JSON.parse(savedProfile);
      const savedStatus = localStorage.getItem(statusKey(user.uid)) || "online";
      statusSelect.value = savedStatus;
      await enterChat(savedStatus);
    } else {
      modal.style.display = "flex";
    }
  });

  // Exit (Ù„Ø§ signOut)
  exitBtn.addEventListener("click", async () => {
    try {
      if (user && profile) {
        await writeSystem("leave");
        await remove(ref(rtdb, "onlineUsers/" + user.uid));
      }
    } catch {}
    location.href = "index.html";
  });

  // Modal enter
  enterBtn.addEventListener("click", async () => {
    setModalError("");

    const cleaned = sanitizeName(nameInput.value);
    const g = genderInput.value;
    const age = Number(ageInput.value);

    if (!cleaned || cleaned.length < 3) { setModalError("Ø§Ù„Ø§Ø³Ù… Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ²)."); return; }
    if (!g) { setModalError("Ø§Ø®ØªØ§Ø± Ø§Ù„Ø¬Ù†Ø³."); return; }
    if (!Number.isFinite(age) || age < 10) { setModalError("Ø§Ù„Ø¹Ù…Ø± Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 10 Ø£Ùˆ Ø£ÙƒØ«Ø±."); return; }

    profile = { name: cleaned, gender: g, age };
    localStorage.setItem(profKey(user.uid), JSON.stringify(profile));

    const savedStatus = localStorage.getItem(statusKey(user.uid)) || "online";
    statusSelect.value = savedStatus;

    await enterChat(savedStatus);
  });

  // Status change
  statusSelect.addEventListener("change", async () => {
    if (!user || !profile) return;
    const s = statusSelect.value || "online";
    localStorage.setItem(statusKey(user.uid), s);
    await updatePresenceStatus(s);
  });

  async function enterChat(statusVal) {
    msgInput.disabled = false;
    sendBtn.disabled = false;

    joinAtMs = Date.now();

    await updatePresenceStatus(statusVal, true);
    await writeSystem("join");

    modal.style.display = "none";

    startOnlineListener();
    startMessagesListener();
  }

  async function updatePresenceStatus(statusVal, first = false) {
    const onlineRef = ref(rtdb, "onlineUsers/" + user.uid);
    const payload = {
      uid: user.uid,
      name: profile.name,
      gender: profile.gender,
      age: profile.age,
      status: statusVal || "online",
      statusText: statusLabel(statusVal || "online")
    };
    await set(onlineRef, payload);
    if (first) onDisconnect(onlineRef).remove();
  }

  // Firestore system (join/leave only)
  async function writeSystem(type) {
    const text =
      type === "join" ? `${profile.name} Ø¯Ø®Ù„ Ø§Ù„Ø´Ø§Øª` :
      type === "leave" ? `${profile.name} Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø´Ø§Øª` : "";

    return addDoc(collection(db, "globalMessages"), {
      system: true,
      type,
      text,
      actorUid: user.uid,
      actorName: profile.name,
      actorGender: profile.gender,
      createdAt: serverTimestamp(),
      createdAtMs: Date.now()
    });
  }

  function isInIgnoreWindow(uid, t) {
    const arr = ignoreWindows[uid] || [];
    for (const w of arr) {
      const start = w.start ?? 0;
      const end = w.end ?? Infinity;
      if (t >= start && t <= end) return true;
    }
    return false;
  }

  // Messages listener (since joinAtMs only)
  function startMessagesListener() {
    initialLoaded = false;

    const q = query(
      collection(db, "globalMessages"),
      where("createdAtMs", ">=", joinAtMs),
      orderBy("createdAtMs", "asc")
    );

    onSnapshot(q, (snap) => {
      messagesDiv.innerHTML = "";
      const isFirst = !initialLoaded;

      snap.forEach((doc) => {
        const m = doc.data();

        // ignore logic: hide msgs written during ignore windows
        if (!m.system && m.uid && isInIgnoreWindow(m.uid, m.createdAtMs || 0)) return;

        if (m.system) {
          const div = document.createElement("div");
          div.className = "system";
          div.textContent = m.text || "";
          messagesDiv.appendChild(div);

          // âœ… Ø§Ù„ØµÙˆØª ÙÙ‚Ø· join/leave + Ù„ÙŠØ³ Ø¹Ù„Ù‰ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ + Ù„ÙŠØ³ Ù„Ù†ÙØ³Ùƒ
          if (!isFirst && (m.type === "join" || m.type === "leave") && m.actorUid && m.actorUid !== user.uid) {
            const now = Date.now();
            if (now - lastSoundAt > 800) {
              lastSoundAt = now;
              toastSound.currentTime = 0;
              toastSound.play().catch(() => {});
            }
          }
        } else {
          const div = document.createElement("div");
          div.className = "msg" + (m.uid === user.uid ? " me" : "");

          const gHtml = genderSymbolHtml(m.gender);
          const name = `${gHtml} ${escapeHtml(m.name || "Ù…Ø³ØªØ®Ø¯Ù…")}`.trim();
          const time = formatTime(m.createdAtMs);

          div.innerHTML = `
            <div class="msgHead">
              <div class="nameTag">${name}</div>
            </div>
            <div>${escapeHtml(m.text || "")}</div>
            <div class="msgTimeUnder">${escapeHtml(time)}</div>
          `;

          messagesDiv.appendChild(div);
        }
      });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      initialLoaded = true;
    });
  }

  // Send message (no sound)
  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!user || !profile) return;

    const text = String(msgInput.value || "").trim();
    if (!text) return;

    if (isProfane(text)) { alert("âŒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø±ÙÙˆØ¶Ø© (ÙƒÙ„Ø§Ù… ØºÙŠØ± Ù„Ø§Ø¦Ù‚)."); return; }

    msgInput.value = "";

    await addDoc(collection(db, "globalMessages"), {
      system: false,
      text,
      uid: user.uid,
      name: profile.name,
      gender: profile.gender,
      age: profile.age,
      createdAt: serverTimestamp(),
      createdAtMs: Date.now()
    });
  });

  // Online list + Ignore button (â›” -> ğŸš«)
  function startOnlineListener() {
    const allOnlineRef = ref(rtdb, "onlineUsers");
    onValue(allOnlineRef, (snap) => {
      const users = snap.val() || {};
      const arr = Object.values(users);

      onlineCount.textContent = String(arr.length);
      onlineList.innerHTML = "";

      arr
        .sort((a, b) => (a.name || "").localeCompare(b.name || ""))
        .forEach((u) => {
          const row = document.createElement("div");
          row.className = "userRow";

          const isMe = u.uid === user.uid;
          const gHtml = genderSymbolHtml(u.gender);
          const displayName = `${gHtml} ${escapeHtml(u.name || "Ù…Ø³ØªØ®Ø¯Ù…")}`.trim();
          const st = u.statusText || statusLabel(u.status || "online");

          const left = document.createElement("div");
          left.className = "userMeta";
          left.innerHTML = `
            <b>${displayName}</b>
            <span>
              <span class="miniPill">${escapeHtml(st)}</span>
              ${isMe ? '<span class="miniPill">Ø£Ù†Øª</span>' : ''}
            </span>
          `;
          row.appendChild(left);

          const btn = document.createElement("button");
          btn.className = "ignoreBtn";
          btn.type = "button";

          if (isMe) {
            btn.textContent = "â€”";
            btn.style.opacity = "0.6";
            btn.style.cursor = "default";
            btn.disabled = true;
          } else {
            const currentlyIgnored = isCurrentlyIgnored(u.uid);
            btn.textContent = currentlyIgnored ? "ğŸš«" : "â›”";
            btn.classList.toggle("ignored", currentlyIgnored);
            btn.title = currentlyIgnored ? "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¬Ø§Ù‡Ù„" : "ØªØ¬Ø§Ù‡Ù„";
            btn.addEventListener("click", () => toggleIgnore(u.uid));
          }

          row.appendChild(btn);
          onlineList.appendChild(row);
        });
    });
  }

  function isCurrentlyIgnored(uid) {
    // ignored if has active window with end==null
    const arr = ignoreWindows[uid] || [];
    return arr.some(w => w.end == null);
  }

  function toggleIgnore(uid) {
    if (!uid) return;

    ignoreWindows[uid] = ignoreWindows[uid] || [];
    const arr = ignoreWindows[uid];

    const activeIndex = arr.findIndex(w => w.end == null);
    const now = Date.now();

    if (activeIndex >= 0) {
      // unignore: close window
      arr[activeIndex].end = now;
    } else {
      // ignore: open window
      arr.push({ start: now, end: null });
    }

    localStorage.setItem(ignoreKey(user.uid), JSON.stringify(ignoreWindows));
    refreshIgnoreCount();
  }

  function refreshIgnoreCount() {
    let count = 0;
    for (const k in ignoreWindows) {
      if ((ignoreWindows[k] || []).some(w => w.end == null)) count++;
    }
    ignoreCount.textContent = `ØªØ¬Ø§Ù‡Ù„: ${count}`;
  }

  // Connection
  function watchConnection() {
    const connRef = ref(rtdb, ".info/connected");
    onValue(connRef, (snap) => {
      const connected = snap.val() === true;
      connDot.classList.toggle("on", connected);
      connText.textContent = connected ? "Ù…ØªØµÙ„" : "ØºÙŠØ± Ù…ØªØµÙ„";
    });
  }

  // best-effort leave (presence guaranteed by onDisconnect)
  window.addEventListener("beforeunload", () => {
    try { if (user && profile) writeSystem("leave"); } catch {}
  });

  function escapeHtml(s = "") {
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;"
    }[m]));
  }
</script>
</body>
</html>
