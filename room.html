<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø© - M L O 5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-dark:#020202;
      --yellow:#facc15;
      --white:#f9fafb;
      --muted:#9ca3af;
      --border-subtle:rgba(156,163,175,.35);
      --grid-x:0px; --grid-y:0px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg-dark);
      color:var(--white);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:stretch;
      position:relative;
      cursor:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><polygon points='2,2 2,22 8,16 14,26 18,24 12,14 20,14' fill='%23facc15' stroke='%23000000' stroke-width='1.5'/></svg>") 0 0, auto;
    }
    .bg-grid{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background-image:radial-gradient(circle, rgba(249,250,251,.55) 1px, transparent 1px);
      background-size:30px 30px;
      background-position:calc(50% + var(--grid-x)) calc(50% + var(--grid-y));
      opacity:.25; mix-blend-mode:screen;
    }
    .page{
      width:100%;
      max-width:1100px;
      padding:32px 16px 40px;
      margin:auto;
      position:relative;
      z-index:1;
    }
    .card{
      background:linear-gradient(145deg,#020202,#050505);
      border-radius:18px;
      padding:14px;
      border:1px solid var(--border-subtle);
      box-shadow:0 12px 30px rgba(0,0,0,.8),0 0 0 1px rgba(55,65,81,.6);
      position:relative;
      overflow:hidden;
      min-height:0;
    }
    .top-bar{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-bottom:14px; direction:ltr;
    }
    .top-chip{
      font-size:.9rem; color:var(--white);
      padding:6px 14px; border-radius:999px;
      border:1px solid rgba(250,204,21,.6);
      background:rgba(0,0,0,.6);
      box-shadow:0 8px 20px rgba(0,0,0,.8),0 0 0 1px rgba(15,23,42,.9);
      display:inline-flex; align-items:center; gap:8px;
      user-select:none; cursor:pointer;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(239,68,68,.9)}
    .dot.on{background:rgba(34,197,94,.95)}
    .title{
      font-family:"Poppins",system-ui,sans-serif;
      font-weight:800; letter-spacing:.12em;
      text-transform:uppercase; white-space:nowrap;
    }
    .title small{letter-spacing:0;font-weight:700;color:var(--muted)}

    .wrap{
      display:grid;
      grid-template-columns:320px 1fr;
      gap:14px;
      height:calc(100vh - 32px - 40px - 14px - 44px);
      min-height:70vh;
    }

    .panel-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    .panel-head .h{display:flex;flex-direction:column;gap:2px}
    .panel-head .h b{color:var(--yellow);font-size:1rem}
    .panel-head .h span{color:var(--muted);font-size:.85rem}

    .badge{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.55);
      padding:6px 10px;
      font-size:.85rem;
      background:rgba(0,0,0,.45);
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }

    .onlineCard{display:flex;flex-direction:column;height:100%}
    #onlineList{display:flex;flex-direction:column;gap:10px;overflow:auto;min-height:0;flex:1;padding-right:4px}
    .userRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px;border-radius:16px;border:1px solid var(--border-subtle);
      background:rgba(0,0,0,.55);box-shadow:0 10px 22px rgba(0,0,0,.6);
    }
    .userMeta{display:flex;flex-direction:column;gap:3px;min-width:0}
    .userMeta b{
      font-size:.92rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:190px;
      display:flex; align-items:center; gap:8px;
    }
    .userMeta span{font-size:.8rem;color:var(--muted);display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap}
    .miniPill{
      border-radius:999px;border:1px solid rgba(148,163,184,.7);
      padding:3px 8px;font-size:.75rem;background:rgba(0,0,0,.4);
      color:var(--yellow);white-space:nowrap;
    }

    .ignoreBtn{
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.45);
      color:var(--yellow);
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      font-size:.95rem;
      user-select:none;
    }
    .ignoreBtn.ignored{border-color:rgba(239,68,68,.85);color:rgba(239,68,68,.95)}
    .ignoreBtn:disabled{opacity:.5;cursor:not-allowed}

    .dotsBtn{
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.45);
      color:var(--yellow);
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      font-size:1.05rem;
      user-select:none;
      line-height:1;
    }
    .dotsBtn:disabled{opacity:.5;cursor:not-allowed}

    .rowActions{display:flex;align-items:center;gap:8px;justify-content:flex-end;direction:ltr}

    .statusWrap{display:flex;align-items:center;gap:8px;justify-content:flex-end;direction:rtl}
    select,input{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.55);
      background:#000;
      color:var(--white);
      padding:8px 12px;
      outline:none;
      font-size:.9rem;
    }

    .chatCard{display:flex;flex-direction:column;height:100%;min-height:0;position:relative}

    /* âœ… ØªØ¨ÙˆÙŠØ¨Ø§Øª: Ø¹Ø§Ù… + Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø®Ø§ØµØ© */
    .tabsBar{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tabBtn{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.55);
      color:var(--yellow);
      padding:8px 12px;
      cursor:pointer;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .tabBtn.active{
      border-color:rgba(250,204,21,.95);
      box-shadow:0 0 0 1px rgba(250,204,21,.35);
    }
    .unreadDot{
      width:8px;height:8px;border-radius:50%;
      background:rgba(34,197,94,.95);
      box-shadow:0 0 10px rgba(34,197,94,.45);
      display:none;
    }
    .tabBtn.hasUnread .unreadDot{display:inline-block}

    .viewsWrap{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    #messages, #dmMessages{
      display:flex;flex-direction:column;gap:10px;overflow:auto;
      min-height:0;flex:1;padding-right:4px;padding-bottom:6px;
    }

    .msg{
      max-width:78%;
      border-radius:18px;
      border:1px solid var(--border-subtle);
      background:rgba(0,0,0,.55);
      box-shadow:0 10px 22px rgba(0,0,0,.6);
      padding:10px 12px;
      line-height:1.5;
      word-break:break-word;
    }
    .msg.me{
      margin-right:auto;
      border-color:rgba(250,204,21,.75);
      box-shadow:0 14px 32px rgba(0,0,0,.75),0 0 0 1px rgba(250,204,21,.35);
    }

    .msgHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px;color:var(--muted);font-size:.85rem}
    .nameTag{font-weight:900;display:inline-flex;align-items:center;gap:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}

    .msgTools{display:inline-flex;align-items:center;gap:8px}
    .replyBtn{
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.35);
      color:var(--yellow);
      border-radius:999px;
      padding:4px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:.85rem;
      user-select:none;
    }

    .replyBar{
      display:none;
      margin-top:10px;
      border:1px dashed rgba(250,204,21,.55);
      background:rgba(0,0,0,.45);
      border-radius:16px;
      padding:8px 10px;
      color:var(--muted);
      font-size:.85rem;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .replyBar b{color:var(--yellow)}
    .replyCancel{
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      border-radius:999px;
      width:34px;height:34px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      user-select:none;
    }
    .replyQuote{
      border-right:3px solid rgba(250,204,21,.75);
      padding-right:10px;
      margin-bottom:8px;
      color:rgba(156,163,175,.95);
      font-size:.9rem;
    }

    .msgTimeUnder{margin-top:6px;font-size:.78rem;color:rgba(156,163,175,.92);text-align:left;direction:ltr}

    .system{
      align-self:center;
      color:rgba(156,163,175,.95);
      font-size:.9rem;
      padding:6px 10px;
      border-radius:999px;
      border:1px dashed rgba(250,204,21,.55);
      background:rgba(0,0,0,.55);
      max-width:100%;
    }

    .composer{display:flex;align-items:center;gap:10px;margin-top:12px;direction:rtl}
    #msgInput,#dmInput{flex:1;border-radius:999px}

    .sendBtn,.emojiBtn,.clearBtn,.adminClearBtn{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      padding:9px 14px;
      cursor:pointer;
      font-weight:800;
      height:40px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .emojiBtn,.clearBtn{width:40px;padding:0}
    .adminClearBtn{width:40px;padding:0;display:none}

    .emojiPicker{
      position:absolute;
      bottom:62px;
      right:14px;
      width:280px;
      max-width:calc(100% - 28px);
      border-radius:18px;
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.92);
      box-shadow:0 18px 45px rgba(0,0,0,.95);
      padding:10px;
      display:none;
      z-index:50;
      backdrop-filter:blur(10px);
    }
    .emojiGrid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;max-height:200px;overflow:auto;padding-right:4px}
    .emojiItem{border:1px solid rgba(148,163,184,.35);background:rgba(0,0,0,.55);border-radius:12px;padding:6px 0;text-align:center;cursor:pointer;user-select:none}

    .gMale{color:#3b82f6;font-weight:900}
    .gFemale{color:#ec4899;font-weight:900}

    /* âœ… Ø´ÙƒÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: Ù…Ø³ØªØ·ÙŠÙ„ Ø£ØµÙØ± + ØªÙˆØ´ÙŠØ­ Ø£Ø³ÙˆØ¯ + Ù†Øµ Ø£Ø³ÙˆØ¯ Ø¨Ø¯ÙˆÙ† Ø®Ù„ÙÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
    .adminPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:3px 12px;
      border-radius:12px;
      background:var(--yellow);
      color:#000;
      font-weight:900;
      position:relative;
      overflow:hidden;
    }
    .adminPill::after{
      content:"";
      position:absolute;
      inset:-30%;
      background:rgba(0,0,0,.25);
      transform:rotate(10deg);
      animation:adminSmudge 1.2s infinite;
      pointer-events:none;
    }
    @keyframes adminSmudge{0%,100%{opacity:.22}50%{opacity:.08}}

    .adminTag{
      font-size:1.05rem;
      filter:drop-shadow(0 0 8px rgba(250,204,21,.55));
      animation:blink 1s infinite;
    }
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}

    .guestPill{
      border:1px solid rgba(250,204,21,.35);
      background:rgba(0,0,0,.45);
      border-radius:999px;
      padding:2px 8px;
      font-size:.78rem;
      color:var(--yellow);
      white-space:nowrap;
    }

    #modal{
      position:fixed; inset:0; z-index:999;
      background:rgba(0,0,0,.75);
      display:none; align-items:center; justify-content:center;
      padding:16px;
    }
    #modalBox{
      width:min(860px,96vw);
      border-radius:18px;
      border:1px solid rgba(250,204,21,.55);
      background:rgba(0,0,0,.92);
      box-shadow:0 18px 45px rgba(0,0,0,.95),0 0 0 1px rgba(17,24,39,.9);
      padding:14px;
      backdrop-filter:blur(10px);
    }
    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 900px){ .modalGrid{grid-template-columns:1fr} }
    .modalCard{
      border:1px solid rgba(250,204,21,.35);
      border-radius:16px;
      background:rgba(0,0,0,.45);
      padding:12px;
    }
    .modalCard h3{margin-bottom:8px;color:var(--yellow);text-align:center;font-weight:900}
    .modalCard p{color:var(--muted);text-align:center;font-size:.9rem;margin-bottom:12px;line-height:1.7}

    .choiceRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
    .choiceBtn{
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      padding:10px 14px;
      cursor:pointer;
      font-weight:900;
      flex:1;
      min-width:180px;
    }

    .modalRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .modalRow.one{grid-template-columns:1fr}
    .modalBtn{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      padding:10px 14px;
      cursor:pointer;
      font-weight:900;
    }
    .hintErr{margin-top:8px;color:rgba(239,68,68,.95);font-size:.85rem;text-align:center;display:none}

    .nameWrap{display:flex;gap:10px;align-items:center}
    .nameWrap input{flex:1}
    .nameEmojiBtn{
      width:42px;height:42px;border-radius:999px;
      border:1px solid rgba(250,204,21,.75);
      background:rgba(0,0,0,.75);
      color:var(--yellow);
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:1.05rem;
      user-select:none;
    }

    .colorRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .colorBox{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid rgba(250,204,21,.35);
      border-radius:999px;
      padding:6px 10px;
      background:rgba(0,0,0,.45);
      color:var(--white);
      font-size:.85rem;
    }
    .colorBox input{width:44px;height:28px;padding:0;border-radius:10px;border:1px solid rgba(250,204,21,.55); background:#000}

    .adminNote{
      color:var(--muted);
      font-size:.85rem;
      line-height:1.6;
      text-align:center;
      margin-top:8px;
    }

    .menu{
      position:fixed; z-index:9999;
      background:rgba(0,0,0,.92);
      border:1px solid rgba(250,204,21,.55);
      border-radius:14px;
      padding:8px;
      min-width:190px;
      display:none;
      box-shadow:0 18px 40px rgba(0,0,0,.9);
    }
    .menu button{
      width:100%;
      border:none;
      background:transparent;
      color:var(--white);
      text-align:right;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
    }
    .menu button:hover{background:rgba(250,204,21,.12); color:var(--yellow)}

    @media (max-width:900px){
      .wrap{grid-template-columns:1fr;height:auto}
    }
  </style>
</head>

<body>
  <div class="bg-grid"></div>

  <main class="page">
    <div class="top-bar">
      <div class="top-chip" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„">
        <span class="dot" id="connDot"></span>
        <span id="connText">ØºÙŠØ± Ù…ØªØµÙ„</span>
      </div>

      <div class="title">M L O 5 <small>â€¢ Global Chat</small></div>

      <button class="top-chip" id="exitBtn" type="button" title="Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø´Ø§Øª">â†© Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="wrap">
      <!-- Online -->
      <section class="card onlineCard">
        <div class="panel-head">
          <div class="h">
            <b>Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø§Ù„Ø¢Ù†</b>
            <span>Ø§Ù„Ø¹Ø¯Ø¯: <b id="onlineCount">0</b></span>
          </div>

          <div class="statusWrap">
            <span class="badge" id="meBadge">Ø£Ù†Øª</span>
            <select id="statusSelect" title="ØºÙŠÙ‘Ø± Ø­Ø§Ù„ØªÙƒ">
              <option value="online">ğŸŸ¢ Ù…ØªØµÙ„</option>
              <option value="busy">â›” Ù…Ø´ØºÙˆÙ„</option>
              <option value="work">ğŸ’¼ Ø¨Ø§Ù„Ø¹Ù…Ù„</option>
              <option value="car">ğŸš— Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø©</option>
              <option value="food">ğŸ” Ø·Ø¹Ø§Ù…</option>
              <option value="out">ğŸŒ™ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</option>
            </select>
          </div>
        </div>

        <div id="onlineList"></div>
      </section>

      <!-- Chat -->
      <section class="card chatCard">
        <div class="panel-head">
          <div class="h">
            <b id="viewTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</b>
            <span id="viewSub">Ù„Ø§ ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ø¦Ù„ Ù‚Ø¨Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</span>
          </div>
          <div class="badge" id="ignoreCount">ØªØ¬Ø§Ù‡Ù„: 0</div>
        </div>

        <!-- âœ… Tabs -->
        <div class="tabsBar" id="tabsBar">
          <button class="tabBtn active" id="tabGlobal" type="button">
            <span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</span>
          </button>
        </div>

        <div class="viewsWrap">
          <!-- Global view -->
          <div id="globalView" style="display:flex;flex-direction:column;min-height:0;flex:1;">
            <div id="messages"></div>

            <div class="replyBar" id="replyBar">
              <div>
                <span>Ø±Ø¯ Ø¹Ù„Ù‰: </span>
                <b id="replyToName">â€”</b>
                <span id="replyToText" style="margin-right:8px;"></span>
              </div>
              <button class="replyCancel" id="replyCancel" type="button" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¯">âœ•</button>
            </div>

            <form id="chatForm" class="composer">
              <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" disabled />
              <button class="clearBtn" id="clearBtn" type="button" title="Ù…Ø³Ø­ Ø§Ù„Ù†Øµ Ø¹Ù†Ø¯Ùƒ ÙÙ‚Ø·">âœ–</button>
              <button class="adminClearBtn" id="adminClearBtn" type="button" title="Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹ (Admin)">ğŸ§¹</button>
              <button class="emojiBtn" id="emojiBtn" type="button" title="Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">ğŸ˜Š</button>
              <button class="sendBtn" id="sendBtn" type="submit" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
            </form>
          </div>

          <!-- DM view -->
          <div id="dmView" style="display:none;flex-direction:column;min-height:0;flex:1;">
            <div class="panel-head" style="margin-top:4px;">
              <div class="h">
                <b>Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ©</b>
                <span id="dmSub">â€”</span>
              </div>
              <button class="top-chip" id="dmClose" type="button" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
            </div>

            <div id="dmMessages"></div>

            <form id="dmForm" class="composer">
              <input id="dmInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©..." autocomplete="off" disabled />
              <button class="emojiBtn" id="dmEmojiBtn" type="button" title="Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">ğŸ˜Š</button>
              <button class="sendBtn" id="dmSendBtn" type="submit" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
            </form>
          </div>
        </div>

        <div class="emojiPicker" id="emojiPicker" aria-hidden="true">
          <div class="emojiGrid" id="emojiGrid"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal">
    <div id="modalBox">
      <div class="modalGrid">
        <!-- User info -->
        <div class="modalCard">
          <h3>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Øª</h3>
          <p>( Ù…ÙØ§ ÙŠÙÙ„Ù’ÙÙØ¸Ù Ù…ÙÙ†Ù’ Ù‚ÙÙˆÙ’Ù„Ù Ø¥ÙÙ„Ø§ Ù„ÙØ¯ÙÙŠÙ’Ù‡Ù Ø±ÙÙ‚ÙÙŠØ¨ÙŒ Ø¹ÙØªÙÙŠØ¯ÙŒ )</p>

          <div class="choiceRow">
            <button class="choiceBtn" id="chooseLogin" type="button">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
            <button class="choiceBtn" id="chooseGuest" type="button">ğŸ‘¤ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ</button>
          </div>

          <div id="formBox" style="display:none;">
            <div class="modalRow one">
              <div class="nameWrap">
                <input id="nameInput" placeholder="Ø§Ø³Ù…Ùƒ (3+)" />
                <button class="nameEmojiBtn" id="nameEmojiBtn" type="button" title="Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">ğŸ˜Š</button>
              </div>
            </div>

            <div class="modalRow">
              <select id="genderInput">
                <option value="">Ø§Ù„Ø¬Ù†Ø³</option>
                <option value="male">Ø°ÙƒØ± â™‚ï¸</option>
                <option value="female">Ø£Ù†Ø«Ù‰ â™€ï¸</option>
              </select>
              <input id="ageInput" type="number" min="10" max="99" placeholder="Ø§Ù„Ø¹Ù…Ø± (10+)" />
            </div>

            <div class="colorRow">
              <div class="colorBox">
                <span>Ù„ÙˆÙ† Ø§Ù„Ø§Ø³Ù…</span>
                <input id="nameColor" type="color" value="#facc15" />
              </div>
              <div class="colorBox">
                <span>Ù„ÙˆÙ† Ø§Ù„Ù†Øµ</span>
                <input id="textColor" type="color" value="#f9fafb" />
              </div>
            </div>

            <button id="enterBtn" class="modalBtn" type="button">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø´Ø§Øª</button>
          </div>

          <div class="hintErr" id="modalErr"></div>
        </div>

        <!-- ADMIN -->
        <div class="modalCard">
          <h3>ADMIN</h3>
          <div class="modalRow one">
            <input id="adminUser" placeholder="Username" autocomplete="off" />
          </div>
          <div class="modalRow one">
            <input id="adminPass" placeholder="Password" type="password" autocomplete="off" />
          </div>

          <button id="adminLoginBtn" class="modalBtn" type="button">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</button>
          <div class="hintErr" id="adminErr"></div>

          <div class="adminNote">
            ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø¥Ù„Ø§ Ù„Ø­Ø³Ø§Ø¨Ùƒ (UID).<br>
            Ø­ØªÙ‰ Ù„Ùˆ Ø¹Ø±Ù Ø£Ø­Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù„Ù† ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Context menu -->
  <div class="menu" id="ctxMenu">
    <button id="ctxDmBtn">Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ©</button>
    <button id="ctxBanBtn" style="display:none;">Ø­Ø¸Ø±</button>
    <button id="ctxKickBtn" style="display:none;">Ø·Ø±Ø¯</button>
    <button id="ctxMuteBtn" style="display:none;">ÙƒØªÙ… (5 Ø¯Ù‚Ø§Ø¦Ù‚)</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    signInAnonymously, signOut,
    setPersistence, inMemoryPersistence
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    query, orderBy, onSnapshot, doc, setDoc, where
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getDatabase, ref, set, onDisconnect, onValue, remove, update } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBnxruqFdBHEHTSVXl-QK848lsGvwBBH9U",
    authDomain: "mlo5-users.firebaseapp.com",
    databaseURL: "https://mlo5-users-default-rtdb.firebaseio.com",
    projectId: "mlo5-users",
    appId: "1:142086858806:web:64c50f3a8d6250a2049097"
  };

  const ADMIN_UIDS = ["VFjSs6kH2jcFJnddE7SXIpipzDi2"];
  const ADMIN_USERNAME = "MLO5";
  const ADMIN_PASSWORD = "APRIL3049";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const rtdb = getDatabase(app);

  // UI
  const connDot = document.getElementById("connDot");
  const connText = document.getElementById("connText");
  const exitBtn = document.getElementById("exitBtn");

  const onlineList = document.getElementById("onlineList");
  const onlineCount = document.getElementById("onlineCount");
  const meBadge = document.getElementById("meBadge");
  const statusSelect = document.getElementById("statusSelect");
  const ignoreCount = document.getElementById("ignoreCount");

  const viewTitle = document.getElementById("viewTitle");
  const viewSub = document.getElementById("viewSub");

  const tabsBar = document.getElementById("tabsBar");
  const tabGlobal = document.getElementById("tabGlobal");

  const globalView = document.getElementById("globalView");
  const dmView = document.getElementById("dmView");

  const messagesDiv = document.getElementById("messages");
  const chatForm = document.getElementById("chatForm");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");
  const adminClearBtn = document.getElementById("adminClearBtn");
  const emojiBtn = document.getElementById("emojiBtn");

  const replyBar = document.getElementById("replyBar");
  const replyToNameEl = document.getElementById("replyToName");
  const replyToTextEl = document.getElementById("replyToText");
  const replyCancel = document.getElementById("replyCancel");

  const dmSub = document.getElementById("dmSub");
  const dmClose = document.getElementById("dmClose");
  const dmMessages = document.getElementById("dmMessages");
  const dmForm = document.getElementById("dmForm");
  const dmInput = document.getElementById("dmInput");
  const dmSendBtn = document.getElementById("dmSendBtn");
  const dmEmojiBtn = document.getElementById("dmEmojiBtn");

  const emojiPicker = document.getElementById("emojiPicker");
  const emojiGrid = document.getElementById("emojiGrid");

  const modal = document.getElementById("modal");
  const modalErr = document.getElementById("modalErr");
  const formBox = document.getElementById("formBox");
  const chooseLogin = document.getElementById("chooseLogin");
  const chooseGuest = document.getElementById("chooseGuest");

  const nameInput = document.getElementById("nameInput");
  const nameEmojiBtn = document.getElementById("nameEmojiBtn");
  const genderInput = document.getElementById("genderInput");
  const ageInput = document.getElementById("ageInput");
  const nameColorInput = document.getElementById("nameColor");
  const textColorInput = document.getElementById("textColor");
  const enterBtn = document.getElementById("enterBtn");

  const adminUser = document.getElementById("adminUser");
  const adminPass = document.getElementById("adminPass");
  const adminLoginBtn = document.getElementById("adminLoginBtn");
  const adminErr = document.getElementById("adminErr");

  const ctxMenu = document.getElementById("ctxMenu");
  const ctxDmBtn = document.getElementById("ctxDmBtn");
  const ctxBanBtn = document.getElementById("ctxBanBtn");
  const ctxKickBtn = document.getElementById("ctxKickBtn");
  const ctxMuteBtn = document.getElementById("ctxMuteBtn");

  const toastSound = new Audio("toast.mp3");
  toastSound.preload = "auto";
  toastSound.volume = 1.0;

  // State
  let user = null;
  let profile = null;
  let joinAtMs = null;
  let initialLoaded = false;
  let lastSoundAt = 0;

  // Tabs state
  let activeTab = "global"; // "global" or "dm:<uid>"
  const dmTabs = new Map(); // uid -> {peer, btn, dotEl, unsub}

  // DM current
  let dmPeer = null;
  let dmKey = null;
  let dmUnsub = null;

  // Reply
  let replyTo = null;

  // Admin
  const adminSessionKey = (uid) => `adminSession_${uid}`;
  let isAdmin = false;
  let isGuest = false;

  // storage keys
  const ignoreKey = (uid) => `chatIgnoreWindows_${uid}`;
  const profKey   = (uid) => `chatProfile_${uid}`;
  const statusKey = (uid) => `chatStatus_${uid}`;

  let ignoreWindows = {};

  // profanity for GLOBAL only
  const BAD_WORDS = ["fuck","shit","bitch","asshole","ÙƒØ³","Ø²Ø¨","Ø´Ø±Ù…ÙˆØ·","Ù‚Ø­Ø¨Ù‡","Ù…Ù†ÙŠÙƒ","Ø®ÙˆÙ„","Ø·ÙŠØ²"];
  const EMOJIS = "ğŸ˜€ğŸ˜…ğŸ˜‚ğŸ¤£ğŸ˜ŠğŸ˜ğŸ˜˜ğŸ˜ğŸ¤©ğŸ¥³ğŸ˜¡ğŸ˜­ğŸ˜±ğŸ‘ğŸ‘ğŸ‘ğŸ™ğŸ”¥ğŸ’›â­âš¡ğŸ®ğŸ’€".split("");

  function setErr(el, msg){
    el.style.display = msg ? "block" : "none";
    el.textContent = msg || "";
  }
  function collapseSpaces(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function escapeHtml(s=""){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }
  function formatTime(tsMs){
    if (!tsMs || Number.isNaN(tsMs)) return "";
    const d = new Date(tsMs);
    let h = d.getHours();
    const m = String(d.getMinutes()).padStart(2,"0");
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if (h === 0) h = 12;
    return `${h}:${m} ${ampm}`;
  }
  function genderSymbolHtml(g){
    if (g === "male") return `<span class="gMale">â™‚ï¸</span>`;
    if (g === "female") return `<span class="gFemale">â™€ï¸</span>`;
    return "";
  }
  function statusLabel(s){
    switch(s){
      case "online": return "ğŸŸ¢ Ù…ØªØµÙ„";
      case "busy": return "â›” Ù…Ø´ØºÙˆÙ„";
      case "work": return "ğŸ’¼ Ø¨Ø§Ù„Ø¹Ù…Ù„";
      case "car": return "ğŸš— Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø©";
      case "food": return "ğŸ” Ø·Ø¹Ø§Ù…";
      case "out": return "ğŸŒ™ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬";
      default: return "ğŸŸ¢ Ù…ØªØµÙ„";
    }
  }
  function isProfane(text){
    const t = String(text||"").toLowerCase();
    return BAD_WORDS.some(w => t.includes(w));
  }

  function participantsKey(a,b){ return [a,b].sort().join("_"); }

  // âœ… DM Rules
  function canOpenDmWith(peer){
    if (!peer) return false;
    if (isGuest) return false;
    const peerIsAdmin = ADMIN_UIDS.includes(peer.uid) || peer.isAdmin === true;
    if (peerIsAdmin) return true;
    return peer.isGuest !== true;
  }

  // Emoji picker
  let activeEmojiTarget = null;
  function buildEmojiGrid(){
    emojiGrid.innerHTML = "";
    EMOJIS.forEach(em=>{
      const b = document.createElement("div");
      b.className = "emojiItem";
      b.textContent = em;
      b.addEventListener("click", ()=>{
        if (activeEmojiTarget) insertAtCursor(activeEmojiTarget, em);
        hideEmoji();
      });
      emojiGrid.appendChild(b);
    });
  }
  buildEmojiGrid();
  function showEmojiFor(inputEl){
    activeEmojiTarget = inputEl;
    emojiPicker.style.display = "block";
    emojiPicker.setAttribute("aria-hidden","false");
  }
  function hideEmoji(){
    emojiPicker.style.display = "none";
    emojiPicker.setAttribute("aria-hidden","true");
    activeEmojiTarget = null;
  }
  function insertAtCursor(input, text){
    const start = input.selectionStart ?? input.value.length;
    const end   = input.selectionEnd ?? input.value.length;
    input.value = input.value.slice(0,start) + text + input.value.slice(end);
    const pos = start + text.length;
    input.setSelectionRange(pos,pos);
    input.focus();
  }

  document.addEventListener("click",(e)=>{
    if (!emojiPicker.contains(e.target) &&
        e.target !== emojiBtn && e.target !== dmEmojiBtn && e.target !== nameEmojiBtn) hideEmoji();
    if (!ctxMenu.contains(e.target)) hideCtxMenu();
  });
  emojiBtn.addEventListener("click",(e)=>{ e.preventDefault(); showEmojiFor(msgInput); });
  dmEmojiBtn.addEventListener("click",(e)=>{ e.preventDefault(); showEmojiFor(dmInput); });
  nameEmojiBtn.addEventListener("click",(e)=>{ e.preventDefault(); showEmojiFor(nameInput); });
  clearBtn.addEventListener("click",(e)=>{ e.preventDefault(); msgInput.value=""; msgInput.focus(); });

  // Reply
  function setReplyTarget(m){
    replyTo = m ? { uid:m.uid, name:m.name, text:m.text } : null;
    if (!replyTo){
      replyBar.style.display = "none";
      replyToNameEl.textContent = "â€”";
      replyToTextEl.textContent = "";
      return;
    }
    replyToNameEl.textContent = replyTo.name || "Ù…Ø³ØªØ®Ø¯Ù…";
    const t = (replyTo.text || "").slice(0, 60);
    replyToTextEl.textContent = `â€” "${t}${(replyTo.text||"").length>60 ? "..." : ""}"`;
    replyBar.style.display = "flex";
  }
  replyCancel.addEventListener("click", ()=> setReplyTarget(null));

  // Ignore windows
  function loadIgnoreWindows(){
    try{ ignoreWindows = JSON.parse(localStorage.getItem(ignoreKey(user.uid)) || "{}"); }
    catch{ ignoreWindows = {}; }
    refreshIgnoreCount();
  }
  function saveIgnoreWindows(){
    localStorage.setItem(ignoreKey(user.uid), JSON.stringify(ignoreWindows));
    refreshIgnoreCount();
  }
  function refreshIgnoreCount(){
    let count=0;
    for (const k in ignoreWindows){
      const arr = ignoreWindows[k] || [];
      if (arr.some(w => w.end == null)) count++;
    }
    ignoreCount.textContent = `ØªØ¬Ø§Ù‡Ù„: ${count}`;
  }
  function isCurrentlyIgnored(uid){
    const arr = ignoreWindows[uid] || [];
    return arr.some(w => w.end == null);
  }
  function isInIgnoreWindow(uid, t){
    const arr = ignoreWindows[uid] || [];
    for (const w of arr){
      const start = w.start ?? 0;
      const end = (w.end == null) ? Infinity : w.end;
      if (t >= start && t <= end) return true;
    }
    return false;
  }
  function toggleIgnore(uid){
    if (ADMIN_UIDS.includes(uid)) return;
    ignoreWindows[uid] = ignoreWindows[uid] || [];
    const arr = ignoreWindows[uid];
    const activeIdx = arr.findIndex(w => w.end == null);
    const now = Date.now();
    if (activeIdx >= 0) arr[activeIdx].end = now;
    else arr.push({start: now, end: null});
    saveIgnoreWindows();
  }

  // Context menu
  let ctxUser = null;
  function showCtxMenu(x,y){
    ctxMenu.style.left = x + "px";
    ctxMenu.style.top  = y + "px";
    ctxMenu.style.display = "block";
  }
  function hideCtxMenu(){
    ctxMenu.style.display = "none";
    ctxUser = null;
  }

  // âœ… System message helper (admin actions appear in chat)
  async function writeSystemText(text){
    await addDoc(collection(db, "globalMessages"), {
      system:true, type:"system",
      text,
      createdAt: serverTimestamp(),
      createdAtMs: Date.now()
    });
  }

  // Admin moderation actions + announce
  async function adminKick(target){
    await update(ref(rtdb, `moderation/${target.uid}`), { kickedAt: Date.now(), reason:"kick", by:user.uid });
    await writeSystemText(`ğŸ›‘ ØªÙ… Ø·Ø±Ø¯ ${target.name} Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†`);
  }
  async function adminBan(target){
    await update(ref(rtdb, `moderation/${target.uid}`), { banned:true, bannedAt: Date.now(), reason:"ban", by:user.uid });
    await writeSystemText(`â›” ØªÙ… Ø­Ø¸Ø± ${target.name} Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†`);
  }
  async function adminMute5(target){
    await update(ref(rtdb, `moderation/${target.uid}`), { mutedUntil: Date.now()+5*60*1000, reason:"mute5", by:user.uid });
    await writeSystemText(`ğŸ”‡ ØªÙ… ÙƒØªÙ… ${target.name} Ù„Ù…Ø¯Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†`);
  }

  // Clear for all (Admin)
  async function adminClearForAll(){
    if (!isAdmin) return;
    const clearedAtMs = Date.now();
    await setDoc(doc(db, "globalMeta", "clear"), {
      clearedAtMs, byUid:user.uid, byName: profile?.name || "Admin", createdAt: serverTimestamp()
    }, { merge:true });

    await writeSystemText(`ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†`);
  }
  adminClearBtn.addEventListener("click",(e)=>{ e.preventDefault(); adminClearForAll(); });

  // Presence
  async function updatePresenceStatus(statusVal, first=false){
    const onlineRef = ref(rtdb, "onlineUsers/" + user.uid);
    const payload = {
      uid: user.uid,
      name: profile.name,
      gender: profile.gender,
      age: profile.age,
      nameColor: profile.nameColor,
      textColor: profile.textColor,
      status: statusVal || "online",
      statusText: statusLabel(statusVal || "online"),
      isAdmin,
      isGuest
    };
    await set(onlineRef, payload);
    if (first) onDisconnect(onlineRef).remove();
  }

  // System join/leave
  async function writeJoinLeave(type){
    const text =
      type === "join" ? `${profile.name} Ø¯Ø®Ù„ Ø§Ù„Ø´Ø§Øª` :
      type === "leave" ? `${profile.name} Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø´Ø§Øª` : "";
    return addDoc(collection(db, "globalMessages"), {
      system:true, type, text,
      actorUid:user.uid, actorName:profile.name,
      createdAt: serverTimestamp(), createdAtMs: Date.now()
    });
  }

  // Connection
  let connWatching = false;
  function watchConnection(){
    if (connWatching) return;
    connWatching = true;
    onValue(ref(rtdb, ".info/connected"), (snap)=>{
      const connected = snap.val() === true;
      connDot.classList.toggle("on", connected);
      connText.textContent = connected ? "Ù…ØªØµÙ„" : "ØºÙŠØ± Ù…ØªØµÙ„";
    });
  }

  // Moderation listener (self)
  function startModerationListener(){
    onValue(ref(rtdb, `moderation/${user.uid}`), async (snap)=>{
      const m = snap.val();
      if (!m) return;

      if (m.banned === true){
        alert("ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ù„Ø´Ø§Øª.");
        try{ await remove(ref(rtdb, "onlineUsers/" + user.uid)); }catch{}
        if (user?.isAnonymous) try{ await signOut(auth); }catch{}
        location.href = "index.html";
        return;
      }
      if (m.kickedAt && Date.now() - m.kickedAt < 15000){
        alert("ØªÙ… Ø·Ø±Ø¯Ùƒ Ù…Ù† Ø§Ù„Ø´Ø§Øª.");
        try{ await remove(ref(rtdb, "onlineUsers/" + user.uid)); }catch{}
        if (user?.isAnonymous) try{ await signOut(auth); }catch{}
        location.href = "index.html";
        return;
      }

      const until = m.mutedUntil || 0;
      const muted = Date.now() < until;
      msgInput.disabled = muted;
      sendBtn.disabled = muted;
      msgInput.placeholder = muted ? "ØªÙ… ÙƒØªÙ…Ùƒ Ù„Ù…Ø¯Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚" : "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...";
    });
  }

  // Clear meta
  let globalClearedAtMs = 0;
  function startClearMetaListener(){
    onSnapshot(doc(db, "globalMeta", "clear"), (snap)=>{
      if (!snap.exists()) return;
      const d = snap.data() || {};
      globalClearedAtMs = Number(d.clearedAtMs || 0);
    });
  }

  // âœ… Tabs switching
  function setActiveTab(tabId){
    activeTab = tabId;
    // reset all tabs active
    [...tabsBar.querySelectorAll(".tabBtn")].forEach(b=>b.classList.remove("active"));

    if (tabId === "global"){
      tabGlobal.classList.add("active");
      globalView.style.display = "flex";
      dmView.style.display = "none";
      viewTitle.textContent = "Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©";
      viewSub.textContent = "Ù„Ø§ ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ø¦Ù„ Ù‚Ø¨Ù„ Ø¯Ø®ÙˆÙ„Ùƒ";
      return;
    }

    // dm
    const uid = tabId.replace("dm:","");
    const t = dmTabs.get(uid);
    if (t){
      t.btn.classList.add("active");
      t.btn.classList.remove("hasUnread");
      openDmWith(t.peer, { autoSwitch:false });
    }
  }

  tabGlobal.addEventListener("click", ()=> setActiveTab("global"));

  function ensureDmTab(peer){
    const uid = peer.uid;
    if (dmTabs.has(uid)) return dmTabs.get(uid);

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "tabBtn";
    btn.dataset.tab = `dm:${uid}`;

    const dot = document.createElement("span");
    dot.className = "unreadDot";

    btn.innerHTML = `<span>Ø®Ø§Øµ: ${escapeHtml(peer.name||"Ù…Ø³ØªØ®Ø¯Ù…")}</span>`;
    btn.appendChild(dot);

    btn.addEventListener("click", ()=>{
      setActiveTab(`dm:${uid}`);
    });

    tabsBar.appendChild(btn);

    const item = { peer, btn, dotEl: dot, unsub:null };
    dmTabs.set(uid, item);
    return item;
  }

  // Online list (ignore + dots)
  function startOnlineListener(){
    onValue(ref(rtdb, "onlineUsers"), (snap)=>{
      const users = snap.val() || {};
      const arr = Object.values(users);

      onlineCount.textContent = String(arr.length);
      onlineList.innerHTML = "";

      arr.sort((a,b)=>(a.name||"").localeCompare(b.name||""))
        .forEach((u)=>{
          const row = document.createElement("div");
          row.className = "userRow";

          const left = document.createElement("div");
          left.className = "userMeta";

          const gHtml = genderSymbolHtml(u.gender);
          const guestHtml = u.isGuest ? `<span class="guestPill">[Ø¶ÙŠÙ]</span>` : "";
          const isRowAdmin = (ADMIN_UIDS.includes(u.uid) || u.isAdmin === true);

          const nameVisual = isRowAdmin
            ? `<span class="adminTag">ğŸ·ï¸</span><span class="adminPill">${escapeHtml(u.name||"Admin")}</span>${guestHtml}`
            : `<span style="color:${escapeHtml(u.nameColor || "#facc15")};font-weight:900">${escapeHtml(u.name||"Ù…Ø³ØªØ®Ø¯Ù…")}</span>${guestHtml}`;

          left.innerHTML = `
            <b>${gHtml} ${nameVisual}</b>
            <span>
              <span class="miniPill">${escapeHtml(u.statusText || statusLabel(u.status || "online"))}</span>
              ${u.uid === user.uid ? `<span class="miniPill" style="border-color:rgba(250,204,21,.55)">Ø£Ù†Øª</span>` : ""}
            </span>
          `;
          row.appendChild(left);

          const actions = document.createElement("div");
          actions.className = "rowActions";

          if (u.uid !== user.uid){
            const ign = document.createElement("button");
            ign.type = "button";
            ign.className = "ignoreBtn";

            const targetIsAdmin = (ADMIN_UIDS.includes(u.uid) || u.isAdmin === true);
            const ignored = isCurrentlyIgnored(u.uid);

            ign.textContent = ignored ? "ğŸš«" : "â›”";
            ign.classList.toggle("ignored", ignored);
            ign.disabled = targetIsAdmin;
            ign.title = targetIsAdmin ? "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø¯Ù…Ù†" : (ignored ? "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¬Ø§Ù‡Ù„" : "ØªØ¬Ø§Ù‡Ù„");

            ign.addEventListener("click",(e)=>{
              e.stopPropagation();
              if (targetIsAdmin) return;
              toggleIgnore(u.uid);
              const nowIgnored = isCurrentlyIgnored(u.uid);
              ign.textContent = nowIgnored ? "ğŸš«" : "â›”";
              ign.classList.toggle("ignored", nowIgnored);
            });

            const dots = document.createElement("button");
            dots.type = "button";
            dots.className = "dotsBtn";
            dots.textContent = "â‹¯";
            dots.title = "Ø®ÙŠØ§Ø±Ø§Øª";

            dots.addEventListener("click",(e)=>{
              e.stopPropagation();
              ctxUser = {
                uid: u.uid,
                name: u.name,
                gender: u.gender,
                nameColor: u.nameColor || "#facc15",
                textColor: u.textColor || "#f9fafb",
                isAdmin: u.isAdmin === true || ADMIN_UIDS.includes(u.uid),
                isGuest: u.isGuest === true
              };

              // dm option
              const canDm = canOpenDmWith(ctxUser);
              ctxDmBtn.style.display = canDm ? "block" : "none";

              // admin actions
              const showAdminActions = (isAdmin && ctxUser.uid !== user.uid && !ctxUser.isAdmin);
              ctxBanBtn.style.display = showAdminActions ? "block" : "none";
              ctxKickBtn.style.display = showAdminActions ? "block" : "none";
              ctxMuteBtn.style.display = showAdminActions ? "block" : "none";

              showCtxMenu(e.clientX, e.clientY);
            });

            actions.appendChild(ign);
            actions.appendChild(dots);
          }

          row.appendChild(actions);
          onlineList.appendChild(row);
        });
    });
  }

  // âœ… Global messages: ØªØ±ØªÙŠØ¨ â€œØ³ÙŠØ±ÙØ±â€ Ù„Ù…Ù†Ø¹ Ø·Ù„ÙˆØ¹ Ø±Ø³Ø§Ù„ØªÙƒ ÙÙˆÙ‚
  function startGlobalMessagesListener(){
    initialLoaded = false;

    const q = query(
      collection(db, "globalMessages"),
      orderBy("createdAt", "asc"),
      orderBy("createdAtMs", "asc")
    );

    onSnapshot(q, (snap)=>{
      messagesDiv.innerHTML = "";
      const isFirst = !initialLoaded;
      const cutoff = Math.max(joinAtMs || 0, globalClearedAtMs || 0);

      snap.forEach((docx)=>{
        const m = docx.data();

        const serverMs = m.createdAt?.toMillis?.() || 0;
        const t = serverMs || Number(m.createdAtMs || 0);

        if (t < cutoff) return;
        if (!m.system && m.uid && isInIgnoreWindow(m.uid, t)) return;

        if (m.system){
          const div = document.createElement("div");
          div.className = "system";
          div.textContent = m.text || "";
          messagesDiv.appendChild(div);

          if (!isFirst && (m.type==="join" || m.type==="leave") && m.actorUid && m.actorUid !== user.uid){
            const now = Date.now();
            if (now - lastSoundAt > 800){
              lastSoundAt = now;
              toastSound.currentTime = 0;
              toastSound.play().catch(()=>{});
            }
          }
        } else {
          const div = document.createElement("div");
          div.className = "msg" + (m.uid === user.uid ? " me" : "");

          const gHtml = genderSymbolHtml(m.gender);
          const guestHtml = m.isGuest ? `<span class="guestPill">[Ø¶ÙŠÙ]</span>` : "";
          const isMsgAdmin = (m.isAdmin === true || ADMIN_UIDS.includes(m.uid));

          const nameHtml = isMsgAdmin
            ? `<span class="adminTag">ğŸ·ï¸</span> <span class="adminPill">${escapeHtml(m.name||"Admin")}</span> ${guestHtml}`
            : `<span style="color:${escapeHtml(m.nameColor || "#facc15")}">${escapeHtml(m.name||"Ù…Ø³ØªØ®Ø¯Ù…")}</span> ${guestHtml}`;

          const replyHtml = m.replyTo
            ? `<div class="replyQuote">Ø±Ø¯ Ø¹Ù„Ù‰ <b style="color:var(--yellow)">${escapeHtml(m.replyTo.name||"Ù…Ø³ØªØ®Ø¯Ù…")}</b>: "${escapeHtml((m.replyTo.text||"").slice(0,120))}${(m.replyTo.text||"").length>120?"...":""}"</div>`
            : "";

          div.innerHTML = `
            <div class="msgHead">
              <div class="nameTag">${gHtml} ${nameHtml}</div>
              <div class="msgTools">
                <button class="replyBtn" type="button">â†©ï¸ Ø±Ø¯</button>
              </div>
            </div>
            ${replyHtml}
            <div style="color:${escapeHtml(m.textColor || "#f9fafb")}">${escapeHtml(m.text||"")}</div>
            <div class="msgTimeUnder">${escapeHtml(formatTime(t))}</div>
          `;

          div.querySelector(".replyBtn").addEventListener("click", ()=>{
            setReplyTarget({ uid:m.uid, name:m.name, text:m.text });
          });

          messagesDiv.appendChild(div);
        }
      });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      initialLoaded = true;
    });
  }

  // DM open + tab behavior
  function openDmWith(peer, opts={autoSwitch:true}){
    if (!canOpenDmWith(peer)){
      alert("âŒ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø© (Ø§Ù„Ø¶ÙŠÙ Ù…Ù…Ù†ÙˆØ¹ØŒ Ø£Ùˆ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø¶ÙŠÙ).");
      return;
    }

    dmPeer = peer;
    dmKey = participantsKey(user.uid, peer.uid);

    dmSub.innerHTML = `${genderSymbolHtml(peer.gender)} <span style="color:${escapeHtml(peer.nameColor||"#facc15")};font-weight:900">${escapeHtml(peer.name||"Ù…Ø³ØªØ®Ø¯Ù…")}</span>${peer.isGuest ? ` <span class="guestPill">[Ø¶ÙŠÙ]</span>` : ""}`;

    globalView.style.display = "none";
    dmView.style.display = "flex";
    viewTitle.textContent = "Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ©";
    viewSub.textContent = "Ù„Ø§ ÙŠØªÙ… Ø­Ø¸Ø± Ø§Ù„ÙƒÙ„Ø§Ù… Ø§Ù„Ø³ÙŠÙ‘Ø¡ Ù‡Ù†Ø§";

    dmInput.disabled = false;
    dmSendBtn.disabled = false;

    dmMessages.innerHTML = "";
    if (dmUnsub) dmUnsub();

    const q = query(
      collection(db, "dmMessages"),
      where("participantsKey", "==", dmKey),
      orderBy("createdAt", "asc"),
      orderBy("createdAtMs", "asc")
    );

    dmUnsub = onSnapshot(q, (snap)=>{
      dmMessages.innerHTML = "";
      snap.forEach((d)=>{
        const m = d.data();

        const serverMs = m.createdAt?.toMillis?.() || 0;
        const t = serverMs || Number(m.createdAtMs || 0);

        const div = document.createElement("div");
        div.className = "msg" + (m.fromUid === user.uid ? " me" : "");

        const fromMe = m.fromUid === user.uid;
        const fromName = fromMe ? profile.name : (peer.name || "Ù…Ø³ØªØ®Ø¯Ù…");
        const fromGender = fromMe ? profile.gender : peer.gender;
        const fromNameColor = fromMe ? profile.nameColor : (peer.nameColor || "#facc15");
        const fromTextColor = fromMe ? profile.textColor : (peer.textColor || "#f9fafb");
        const gHtml = genderSymbolHtml(fromGender);

        div.innerHTML = `
          <div class="msgHead">
            <div class="nameTag">${gHtml} <span style="color:${escapeHtml(fromNameColor)}">${escapeHtml(fromName)}</span></div>
          </div>
          <div style="color:${escapeHtml(fromTextColor)}">${escapeHtml(m.text||"")}</div>
          <div class="msgTimeUnder">${escapeHtml(formatTime(t))}</div>
        `;
        dmMessages.appendChild(div);
      });
      dmMessages.scrollTop = dmMessages.scrollHeight;
    });

    if (opts.autoSwitch){
      setActiveTab(`dm:${peer.uid}`);
    }
  }

  dmClose.addEventListener("click", ()=>{
    if (dmUnsub) dmUnsub();
    dmUnsub = null;
    dmPeer = null;
    dmKey = null;
    dmView.style.display = "none";
    globalView.style.display = "flex";
    setActiveTab("global");
  });

  dmForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if (!user || !profile || !dmPeer || !dmKey) return;

    const text = collapseSpaces(dmInput.value);
    if (!text) return;
    dmInput.value = "";

    // DM Ù…Ø³Ù…ÙˆØ­ ÙƒÙ„Ø§Ù… Ø³ÙŠØ¡
    await addDoc(collection(db, "dmMessages"), {
      participantsKey: dmKey,
      fromUid: user.uid,
      toUid: dmPeer.uid,
      text,
      createdAt: serverTimestamp(),
      createdAtMs: Date.now()
    });
  });

  // Menu actions
  ctxDmBtn.addEventListener("click", ()=>{
    if (ctxUser){
      const item = ensureDmTab(ctxUser);
      openDmWith(item.peer, {autoSwitch:true});
    }
    hideCtxMenu();
  });
  ctxBanBtn.addEventListener("click", async ()=>{
    if (!isAdmin || !ctxUser || ctxUser.isAdmin) return;
    await adminBan(ctxUser);
    hideCtxMenu();
  });
  ctxKickBtn.addEventListener("click", async ()=>{
    if (!isAdmin || !ctxUser || ctxUser.isAdmin) return;
    await adminKick(ctxUser);
    hideCtxMenu();
  });
  ctxMuteBtn.addEventListener("click", async ()=>{
    if (!isAdmin || !ctxUser || ctxUser.isAdmin) return;
    await adminMute5(ctxUser);
    hideCtxMenu();
  });

  // Send GLOBAL
  chatForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if (!user || !profile) return;
    const text = collapseSpaces(msgInput.value);
    if (!text) return;
    if (msgInput.disabled) return;

    if (!isAdmin && isProfane(text)){
      alert("âŒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø±ÙÙˆØ¶Ø© (ÙƒÙ„Ø§Ù… ØºÙŠØ± Ù„Ø§Ø¦Ù‚).");
      return;
    }

    const payload = {
      system:false,
      text,
      uid:user.uid,
      name:profile.name,
      gender:profile.gender,
      age:profile.age,
      nameColor:profile.nameColor,
      textColor:profile.textColor,
      isAdmin, isGuest,
      createdAt: serverTimestamp(),
      createdAtMs: Date.now()
    };

    if (replyTo){
      payload.replyTo = { uid: replyTo.uid, name: replyTo.name, text: replyTo.text };
    }

    msgInput.value = "";
    setReplyTarget(null);

    await addDoc(collection(db, "globalMessages"), payload);
  });

  // Status
  statusSelect.addEventListener("change", async ()=>{
    if (!user || !profile) return;
    const s = statusSelect.value || "online";
    if (!user.isAnonymous) localStorage.setItem(statusKey(user.uid), s);
    await updatePresenceStatus(s);
  });

  // ADMIN activation
  adminLoginBtn.addEventListener("click", ()=>{
    setErr(adminErr, "");
    if (!user) return;
    if (user.isAnonymous){
      setErr(adminErr, "Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø§ ÙŠØ¹Ù…Ù„ Ù„Ù„Ø¶ÙŠÙ.");
      return;
    }
    if (!ADMIN_UIDS.includes(user.uid)){
      setErr(adminErr, "Ù‡Ø°Ù‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨.");
      return;
    }
    const u = (adminUser.value || "").trim();
    const p = (adminPass.value || "").trim();
    if (u !== ADMIN_USERNAME || p !== ADMIN_PASSWORD){
      setErr(adminErr, "Ø¨ÙŠØ§Ù†Ø§Øª ADMIN ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
      return;
    }
    localStorage.setItem(adminSessionKey(user.uid), "1");
    setErr(adminErr, "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†.");
    isAdmin = true;
    adminClearBtn.style.display = "inline-flex";
  });

  // Exit
  async function leaveAndGoHome(){
    try{
      if (user && profile){
        await writeJoinLeave("leave");
        await remove(ref(rtdb, "onlineUsers/" + user.uid));
      }
    }catch{}
    try{
      if (auth.currentUser?.isAnonymous) await signOut(auth);
    }catch{}
    location.href = "index.html";
  }
  exitBtn.addEventListener("click", ()=> leaveAndGoHome());

  // Guest/Login choice
  function showForm(){ formBox.style.display = "block"; }

  chooseLogin.addEventListener("click", ()=>{
    setErr(modalErr,"");
    if (!user || user.isAnonymous){
      location.href = "login.html";
      return;
    }
    isGuest = false;
    showForm();
  });

  chooseGuest.addEventListener("click", async ()=>{
    setErr(modalErr,"");
    if (user && !user.isAnonymous){
      setErr(modalErr, "Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„â€”Ø§Ø³ØªØ®Ø¯Ù… Ø®ÙŠØ§Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„.");
      return;
    }
    try{
      await setPersistence(auth, inMemoryPersistence);
      if (!auth.currentUser) await signInAnonymously(auth);
      isGuest = true;
      showForm();
    }catch(err){
      console.error(err);
      setErr(modalErr, "âŒ ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.");
    }
  });

  // Enter chat
  enterBtn.addEventListener("click", async ()=>{
    setErr(modalErr, "");

    const rawName = collapseSpaces(nameInput.value);
    const g = genderInput.value;
    const age = Number(ageInput.value);

    if (!rawName || rawName.length < 3){ setErr(modalErr, "Ø§Ù„Ø§Ø³Ù… Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; }
    if (!g){ setErr(modalErr, "Ø§Ø®ØªØ§Ø± Ø§Ù„Ø¬Ù†Ø³."); return; }
    if (!Number.isFinite(age) || age < 10){ setErr(modalErr, "Ø§Ù„Ø¹Ù…Ø± Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 10 Ø£Ùˆ Ø£ÙƒØ«Ø±."); return; }
    if (!user){ setErr(modalErr, "Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹."); return; }

    profile = {
      name: rawName,
      gender: g,
      age,
      nameColor: nameColorInput.value || "#facc15",
      textColor: textColorInput.value || "#f9fafb"
    };

    if (!user.isAnonymous){
      localStorage.setItem(profKey(user.uid), JSON.stringify(profile));
    }

    const savedStatus = (!user.isAnonymous ? (localStorage.getItem(statusKey(user.uid)) || "online") : "online");
    statusSelect.value = savedStatus;

    await enterChat(savedStatus);
  });

  async function enterChat(statusVal){
    isGuest = !!user?.isAnonymous;

    isAdmin =
      !isGuest &&
      ADMIN_UIDS.includes(user.uid) &&
      (localStorage.getItem(adminSessionKey(user.uid)) === "1");

    adminClearBtn.style.display = isAdmin ? "inline-flex" : "none";

    msgInput.disabled = false;
    sendBtn.disabled = false;

    joinAtMs = Date.now();

    await updatePresenceStatus(statusVal, true);
    await writeJoinLeave("join");

    modal.style.display = "none";

    loadIgnoreWindows();
    startClearMetaListener();
    startOnlineListener();
    startGlobalMessagesListener();
    startModerationListener();

    // âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØµÙˆÙ„ Ø±Ø³Ø§Ø¦Ù„ DM: Ø¥Ø°Ø§ ÙˆØµÙ„ØªÙƒ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© -> ÙŠÙ†ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ ÙÙˆØ±Ø§Ù‹
    startIncomingDmWatcher();
  }

  // âœ… DM incoming watcher: ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† (Ø§Ù„Ø¶ÙŠÙ Ù…Ù…Ù†ÙˆØ¹ DM Ø£ØµÙ„Ø§Ù‹)
  let dmInboxUnsub = null;
  function startIncomingDmWatcher(){
    if (dmInboxUnsub) dmInboxUnsub();
    if (!user || isGuest) return;

    const q = query(
      collection(db, "dmMessages"),
      orderBy("createdAt", "asc"),
      orderBy("createdAtMs", "asc")
    );

    dmInboxUnsub = onSnapshot(q, (snap)=>{
      snap.docChanges().forEach((ch)=>{
        if (ch.type !== "added") return;
        const m = ch.doc.data();

        // Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø±Ø¯Ø© Ø¥Ù„ÙŠ
        if (m.toUid !== user.uid) return;

        // Ø­Ø¯Ù‘Ø¯ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
        const peerUid = m.fromUid;
        if (!peerUid) return;

        // Ù„Ø§ DM Ù…Ø¹ Ø¶ÙŠÙ (Ø­Ø³Ø¨ Ø´Ø±ÙˆØ·Ùƒ)
        // (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø¯Ù…Ù† Ø£Ùˆ Ù…Ø³Ø¬Ù„ ÙÙ‚Ø·) â€” Ù…Ø§ Ø¹Ù†Ø¯Ù†Ø§ Ù‡Ù†Ø§ presence Ø³Ø±ÙŠØ¹ØŒ Ù„Ø°Ù„Ùƒ Ù†Ø®Ù„ÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ ÙŠØ·Ù„Ø¹ ÙˆØ§Ù„ÙØªØ­ Ù†ÙØ³Ù‡ ÙŠØªØ­Ù‚Ù‚ Ø¹Ø¨Ø± canOpenDmWith Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·.
        // Ù†Ø¹Ù…Ù„ ØªØ¨ÙˆÙŠØ¨ Ø¨Ø§Ø³Ù… UID Ù…Ø¤Ù‚Øª Ù„Ø­Ø¯ Ù…Ø§ ØªØ¸Ù‡Ø± Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù…Ù† online list.
        // Ø§Ù„Ø£ÙØ¶Ù„: Ù†Ø®Ø²Ù† Ø§Ù„Ø§Ø³Ù… ÙÙŠ dmMessages Ù„Ø§Ø­Ù‚Ø§Ù‹ØŒ Ø¨Ø³ Ø§Ù„Ø¢Ù† Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø§Ø³Ù… Ù…Ù† cache Ø¥Ù† ÙˆØ¬Ø¯:
        const cached = window.__onlineCache?.[peerUid] || { uid: peerUid, name: "Ù…Ø³ØªØ®Ø¯Ù…", gender:"", nameColor:"#facc15", textColor:"#f9fafb", isGuest:false, isAdmin: ADMIN_UIDS.includes(peerUid) };

        const item = ensureDmTab(cached);
        if (activeTab !== `dm:${peerUid}`){
          item.btn.classList.add("hasUnread");
        }
      });
    });
  }

  // Online cache for better DM tab names
  window.__onlineCache = {};

  // Boot: ALWAYS show modal
  onAuthStateChanged(auth, async (u)=>{
    user = u || null;
    watchConnection();

    if (user && !user.isAnonymous){
      const savedProfile = localStorage.getItem(profKey(user.uid));
      if (savedProfile){
        try{
          const p = JSON.parse(savedProfile);
          nameInput.value = p.name || "";
          genderInput.value = p.gender || "";
          ageInput.value = p.age || "";
          nameColorInput.value = p.nameColor || "#facc15";
          textColorInput.value = p.textColor || "#f9fafb";
        }catch{}
      }
    } else {
      nameInput.value = "";
      genderInput.value = "";
      ageInput.value = "";
      nameColorInput.value = "#facc15";
      textColorInput.value = "#f9fafb";
    }

    formBox.style.display = "none";
    setErr(modalErr, "");
    setErr(adminErr, "");
    modal.style.display = "flex";
  });

  // keep cache updated (small helper)
  onValue(ref(rtdb, "onlineUsers"), (snap)=>{
    const users = snap.val() || {};
    window.__onlineCache = users || {};
    // update dm tab labels if open
    dmTabs.forEach((item, uid)=>{
      const u = users[uid];
      if (u){
        item.peer = {
          uid: u.uid,
          name: u.name,
          gender: u.gender,
          nameColor: u.nameColor || "#facc15",
          textColor: u.textColor || "#f9fafb",
          isGuest: !!u.isGuest,
          isAdmin: !!u.isAdmin || ADMIN_UIDS.includes(u.uid)
        };
        item.btn.childNodes[0].textContent = `Ø®Ø§Øµ: ${u.name}`;
      }
    });
  });

  // beforeunload cleanup
  window.addEventListener("beforeunload", ()=>{
    try{
      if (user && profile){
        writeJoinLeave("leave");
        remove(ref(rtdb, "onlineUsers/" + user.uid));
      }
    }catch{}
    try{
      if (auth.currentUser?.isAnonymous) signOut(auth);
    }catch{}
  });

  // Default active tab
  setActiveTab("global");
</script>
</body>
</html>
