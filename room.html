<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù… - MLO5</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Tajawal',sans-serif;
  background:#0f0f14;
  color:#fff;
  height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  padding:12px;
  background:#151521;
  text-align:center;
  font-weight:bold;
}
#chat{
  flex:1;
  display:flex;
}
#messages{
  flex:1;
  padding:15px;
  overflow-y:auto;
}
.msg{
  background:#1c1c2b;
  padding:10px 14px;
  border-radius:10px;
  margin-bottom:8px;
  max-width:75%;
}
.me{background:#4f46e5;margin-right:auto;}
.system{
  background:transparent;
  color:#9ca3af;
  text-align:center;
  font-size:13px;
}
#online{
  width:220px;
  border-right:1px solid #222;
  padding:12px;
}
.user{
  font-size:14px;
  margin-bottom:6px;
}
form{
  display:flex;
  padding:10px;
  background:#151521;
}
input,select{
  padding:10px;
  border-radius:8px;
  border:none;
  outline:none;
}
#msgInput{flex:1;}
button{
  background:#4f46e5;
  border:none;
  color:#fff;
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
  margin-right:8px;
}

/* Modal */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:flex;
  align-items:center;
  justify-content:center;
}
#modalBox{
  background:#151521;
  padding:20px;
  border-radius:12px;
  width:300px;
}
#modalBox h3{text-align:center;margin-top:0;}
#modalBox input,#modalBox select{
  width:100%;
  margin-bottom:10px;
}
</style>
</head>

<body>

<header>ðŸ’¬ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù…</header>

<div id="chat">
  <div id="online">
    <b>Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ†</b>
    <div id="onlineList"></div>
  </div>
  <div id="messages"></div>
</div>

<form id="chatForm">
  <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." required>
  <button>Ø¥Ø±Ø³Ø§Ù„</button>
</form>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
<div id="modal">
  <div id="modalBox">
    <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <input id="nameInput" placeholder="Ø§Ø³Ù…Ùƒ">
    <select id="genderInput">
      <option value="">Ø§Ù„Ø¬Ù†Ø³</option>
      <option>Ø°ÙƒØ±</option>
      <option>Ø£Ù†Ø«Ù‰</option>
    </select>
    <input id="ageInput" type="number" placeholder="Ø§Ù„Ø¹Ù…Ø±">
    <button id="enterBtn">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø´Ø§Øª</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getDatabase, ref, set, onDisconnect, onValue, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBnxruqFdBHEHTSVXl-QK848lsGvwBBH9U",
  authDomain: "mlo5-users.firebaseapp.com",
  databaseURL: "https://mlo5-users-default-rtdb.firebaseio.com",
  projectId: "mlo5-users",
  appId: "1:142086858806:web:64c50f3a8d6250a2049097"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const rtdb = getDatabase(app);

let userData = null;
let user = null;

// ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, u=>{
  if(!u) location.href="login.html";
  user = u;
});

// Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø´Ø§Øª
enterBtn.onclick = async ()=>{
  const name = nameInput.value.trim();
  const gender = genderInput.value;
  const age = ageInput.value;

  if(!name || !gender || !age) return alert("Ø¹Ø¨Ù‘ÙŠ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

  userData = { name, gender, age };

  document.getElementById("modal").remove();

  const onlineRef = ref(rtdb,"onlineUsers/"+user.uid);
  set(onlineRef,userData);
  onDisconnect(onlineRef).remove();

  // Ø±Ø³Ø§Ù„Ø© Ø¯Ø®ÙˆÙ„
  addDoc(collection(db,"globalMessages"),{
    text: `${name} Ø¯Ø®Ù„ Ø§Ù„Ø´Ø§Øª`,
    system:true,
    createdAt: serverTimestamp()
  });

  loadChat();
  loadOnline();
};

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Øª
function loadChat(){
  const q = query(collection(db,"globalMessages"),orderBy("createdAt"));
  onSnapshot(q,snap=>{
    messages.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      if(m.system){
        div.className="system";
        div.textContent=m.text;
      }else{
        div.className="msg"+(m.uid===user.uid?" me":"");
        div.textContent=m.name+": "+m.text;
      }
      messages.appendChild(div);
      messages.scrollTop=messages.scrollHeight;
    });
  });
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
chatForm.onsubmit=async e=>{
  e.preventDefault();
  await addDoc(collection(db,"globalMessages"),{
    text: msgInput.value,
    uid: user.uid,
    name: userData.name,
    createdAt: serverTimestamp()
  });
  msgInput.value="";
};

// Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
function loadOnline(){
  const refOnline=ref(rtdb,"onlineUsers");
  onValue(refOnline,snap=>{
    onlineList.innerHTML="";
    snap.forEach(u=>{
      const d=u.val();
      const div=document.createElement("div");
      div.className="user";
      div.textContent="ðŸŸ¢ "+d.name;
      onlineList.appendChild(div);
    });
  });
}

// Ø±Ø³Ø§Ù„Ø© Ø®Ø±ÙˆØ¬
window.addEventListener("beforeunload",()=>{
  if(userData){
    addDoc(collection(db,"globalMessages"),{
      text: `${userData.name} Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø´Ø§Øª`,
      system:true,
      createdAt: serverTimestamp()
    });
  }
});
</script>

</body>
</html>
