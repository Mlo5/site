<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØºØ±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© - M L O 5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    /* âœ… Ù†ÙØ³ Ù…ØªØºÙŠØ±Ø§Øª Ø³ØªØ§ÙŠÙ„ Ù…ÙˆÙ‚Ø¹Ùƒ */
    :root {
      --bg-dark: #020202;
      --yellow: #facc15;
      --white: #f9fafb;
      --muted: #9ca3af;
      --border-subtle: rgba(156, 163, 175, 0.35);
      --radius-lg: 20px;
      --radius-full: 999px;
      --grid-x: 0px;
      --grid-y: 0px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-dark);
      color: var(--white);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      transition: background 0.3s ease, color 0.3s ease;
      position: relative;
      cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><polygon points='2,2 2,22 8,16 14,26 18,24 12,14 20,14' fill='%23facc15' stroke='%23000000' stroke-width='1.5'/></svg>") 0 0, auto;
    }

    .bg-grid {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, rgba(249, 250, 251, 0.55) 1px, transparent 1px);
      background-size: 30px 30px;
      background-position: calc(50% + var(--grid-x)) calc(50% + var(--grid-y));
      opacity: 0.25;
      mix-blend-mode: screen;
    }

    .page {
      width: 100%;
      max-width: 1100px;
      padding: 32px 16px 40px;
      margin: auto;
      position: relative;
      z-index: 1;
    }

    /* âœ… Ù†ÙØ³ Ø¥Ø­Ø³Ø§Ø³ Ø§Ù„ÙƒØ±ÙˆØª Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
    .card {
      background: linear-gradient(145deg, #020202, #050505);
      border-radius: 18px;
      padding: 14px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(55, 65, 81, 0.6);
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      border-color: rgba(250, 204, 21, 0.65);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.9), 0 0 0 1px rgba(250, 204, 21, 0.35);
    }

    /* Top bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
      direction: ltr;
    }

    .top-chip {
      font-size: 0.9rem;
      color: var(--white);
      text-decoration: none;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.6);
      background: rgba(0, 0, 0, 0.6);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(15, 23, 42, 0.9);
      transition: background 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }

    .top-chip:hover {
      background: rgba(250, 204, 21, 0.15);
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.95), 0 0 0 1px rgba(250, 204, 21, 0.7);
    }

    .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      display: inline-block;
    }
    .dot.on { background: rgba(34, 197, 94, 0.95); }

    .title {
      font-family: "Poppins", system-ui, sans-serif;
      font-weight: 800;
      letter-spacing: 0.12em;
      color: var(--white);
      text-transform: uppercase;
      white-space: nowrap;
    }
    .title small { letter-spacing: 0; font-weight: 700; color: var(--muted); }

    /* Layout (Ù†ÙØ³ Ø§Ù„ØªÙ‚Ø³ÙŠÙ…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† + Ø´Ø§Øª) */
    .wrap {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
      min-height: 72vh;
    }

    .panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .panel-head .h {
      display: flex; flex-direction: column; gap: 2px;
    }
    .panel-head .h b { color: var(--yellow); font-size: 1rem; }
    .panel-head .h span { color: var(--muted); font-size: 0.85rem; }

    .badge {
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.55);
      padding: 6px 10px;
      font-size: 0.85rem;
      background: rgba(0,0,0,.45);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    /* Online list */
    #onlineList {
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: auto;
      max-height: 60vh;
      padding-right: 4px;
    }

    .userRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      background: rgba(0,0,0,.55);
      box-shadow: 0 10px 22px rgba(0,0,0,.6);
    }

    .userMeta {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .userMeta b {
      font-size: 0.92rem;
      color: var(--white);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }

    .userMeta span {
      font-size: 0.8rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .miniPill {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 3px 8px;
      font-size: 0.75rem;
      background: rgba(0,0,0,.4);
      color: var(--yellow);
      white-space: nowrap;
    }

    .ignoreBtn {
      border: 1px solid rgba(250, 204, 21, 0.55);
      background: rgba(0,0,0,.45);
      color: var(--yellow);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: transform .15s ease, background .15s ease;
      user-select: none;
    }
    .ignoreBtn:hover { transform: translateY(-1px); background: rgba(250,204,21,.12); }
    .ignoreBtn.ignored { border-color: rgba(239,68,68,.8); color: rgba(239,68,68,.95); }

    /* Status picker (self) */
    .statusWrap {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-end;
      direction: rtl;
    }

    select, input {
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.55);
      background: rgba(0,0,0,.55);
      color: var(--white);
      padding: 8px 12px;
      outline: none;
      font-size: 0.9rem;
    }

    /* Chat messages */
    #messages {
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: auto;
      max-height: 56vh;
      padding-right: 4px;
      padding-bottom: 6px;
    }

    .msg {
      max-width: 78%;
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      background: rgba(0,0,0,.55);
      box-shadow: 0 10px 22px rgba(0,0,0,.6);
      padding: 10px 12px;
      line-height: 1.5;
      word-break: break-word;
    }

    .msg.me {
      margin-right: auto;
      border-color: rgba(250, 204, 21, 0.75);
      box-shadow: 0 14px 32px rgba(0,0,0,.75), 0 0 0 1px rgba(250, 204, 21, 0.35);
    }

    .msgHead {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .nameTag {
      color: var(--yellow);
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 220px;
    }

    .timeTag {
      font-size: 0.78rem;
      color: rgba(156,163,175,.92);
      white-space: nowrap;
    }

    .system {
      align-self: center;
      color: rgba(156,163,175,.95);
      font-size: 0.9rem;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(250, 204, 21, 0.55);
      background: rgba(0,0,0,.55);
      max-width: 100%;
    }

    /* Composer */
    .composer {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      direction: rtl;
    }

    #msgInput {
      flex: 1;
      border-radius: 999px;
    }

    .sendBtn {
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.75);
      background: rgba(0,0,0,.75);
      color: var(--yellow);
      padding: 9px 14px;
      cursor: pointer;
      font-weight: 800;
      transition: transform .15s ease, background .15s ease;
    }
    .sendBtn:hover { transform: translateY(-1px); background: rgba(250,204,21,.14); }

    .emojiBtn {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.75);
      background: rgba(0,0,0,.75);
      color: var(--yellow);
      cursor: pointer;
      font-size: 1.05rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: transform .15s ease, background .15s ease;
      user-select: none;
    }
    .emojiBtn:hover { transform: translateY(-1px); background: rgba(250,204,21,.14); }

    /* Emoji picker */
    .emojiPicker {
      position: absolute;
      bottom: 62px;
      right: 14px;
      width: 280px;
      max-width: calc(100% - 28px);
      border-radius: 18px;
      border: 1px solid rgba(250, 204, 21, 0.55);
      background: rgba(0, 0, 0, 0.92);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.95);
      padding: 10px;
      display: none;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .emojiGrid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 6px;
      max-height: 200px;
      overflow: auto;
      padding-right: 4px;
    }

    .emojiItem {
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(0,0,0,.55);
      border-radius: 12px;
      padding: 6px 0;
      text-align: center;
      cursor: pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select: none;
    }
    .emojiItem:hover {
      transform: translateY(-1px);
      background: rgba(250,204,21,.12);
      border-color: rgba(250,204,21,.5);
    }

    /* Modal */
    #modal {
      position: fixed;
      inset: 0;
      z-index: 999;
      background: rgba(0,0,0,.75);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    #modalBox {
      width: min(420px, 96vw);
      border-radius: 18px;
      border: 1px solid rgba(250, 204, 21, 0.55);
      background: rgba(0,0,0,.92);
      box-shadow: 0 18px 45px rgba(0,0,0,.95), 0 0 0 1px rgba(17,24,39,.9);
      padding: 14px;
      backdrop-filter: blur(10px);
    }

    #modalBox h3 {
      margin-bottom: 6px;
      color: var(--yellow);
      text-align: center;
      font-weight: 800;
    }

    #modalBox p {
      text-align: center;
      color: var(--muted);
      font-size: 0.85rem;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .modalRow { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .modalRow.one { grid-template-columns: 1fr; }

    .modalBtn {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.75);
      background: rgba(0,0,0,.75);
      color: var(--yellow);
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 800;
      transition: transform .15s ease, background .15s ease;
    }
    .modalBtn:hover { transform: translateY(-1px); background: rgba(250,204,21,.14); }

    .hintErr {
      margin-top: 8px;
      color: rgba(239, 68, 68, 0.95);
      font-size: 0.85rem;
      text-align: center;
      display: none;
    }

    @media (max-width: 900px) {
      .wrap { grid-template-columns: 1fr; }
      #onlineList { max-height: 28vh; }
      #messages { max-height: 46vh; }
      .emojiPicker { right: 10px; }
    }
  </style>
</head>

<body>
  <div class="bg-grid"></div>

  <main class="page">
    <!-- TOP BAR -->
    <div class="top-bar">
      <div class="top-chip" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„">
        <span class="dot" id="connDot"></span>
        <span id="connText">ØºÙŠØ± Ù…ØªØµÙ„</span>
      </div>

      <div class="title">M L O 5 <small>â€¢ Global Chat</small></div>

      <button class="top-chip" id="exitBtn" type="button" title="Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø´Ø§Øª">â†© Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="wrap">
      <!-- Online panel -->
      <section class="card" style="position:relative;">
        <div class="panel-head">
          <div class="h">
            <b>Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø§Ù„Ø¢Ù†</b>
            <span>Ø§Ù„Ø¹Ø¯Ø¯: <b id="onlineCount">0</b></span>
          </div>

          <div class="statusWrap">
            <span class="badge" id="meBadge">Ø£Ù†Øª</span>
            <select id="statusSelect" title="ØºÙŠÙ‘Ø± Ø­Ø§Ù„ØªÙƒ">
              <option value="busy">â›” Ù…Ø´ØºÙˆÙ„</option>
              <option value="work">ğŸ’¼ Ø¨Ø§Ù„Ø¹Ù…Ù„</option>
              <option value="car">ğŸš— Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø©</option>
              <option value="food">ğŸ” Ø·Ø¹Ø§Ù…</option>
              <option value="out">ğŸŒ™ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</option>
            </select>
          </div>
        </div>

        <div id="onlineList"></div>
      </section>

      <!-- Chat panel -->
      <section class="card" style="position:relative;">
        <div class="panel-head">
          <div class="h">
            <b>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</b>
            <span>Ù„Ø§ ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ø¦Ù„ Ù‚Ø¨Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</span>
          </div>
          <div class="badge" id="ignoreCount">ØªØ¬Ø§Ù‡Ù„: 0</div>
        </div>

        <div id="messages"></div>

        <form id="chatForm" class="composer">
          <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" disabled />
          <button class="emojiBtn" id="emojiBtn" type="button" title="Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">ğŸ˜Š</button>
          <button class="sendBtn" id="sendBtn" type="submit" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
        </form>

        <div class="emojiPicker" id="emojiPicker" aria-hidden="true">
          <div class="emojiGrid" id="emojiGrid"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal: name/gender/age -->
  <div id="modal">
    <div id="modalBox">
      <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <p>Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©).<br>Ø§Ù„Ø¹Ù…Ø± ìµœì†Œ 10 â€¢ Ø§Ù„Ø§Ø³Ù… 3 Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù… Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ²</p>

      <div class="modalRow one">
        <input id="nameInput" placeholder="Ø§Ø³Ù…Ùƒ (Ø­Ø±ÙˆÙ/Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)" />
      </div>

      <div class="modalRow">
        <select id="genderInput">
          <option value="">Ø§Ù„Ø¬Ù†Ø³</option>
          <option value="male">Ø°ÙƒØ± â™‚</option>
          <option value="female">Ø£Ù†Ø«Ù‰ â™€</option>
        </select>

        <input id="ageInput" type="number" min="10" max="99" placeholder="Ø§Ù„Ø¹Ù…Ø± (10+)" />
      </div>

      <button id="enterBtn" class="modalBtn" type="button">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø´Ø§Øª</button>
      <div class="hintErr" id="modalErr"></div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    query, where, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getDatabase, ref, set, onDisconnect, onValue, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  // âœ… Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
  const firebaseConfig = {
    apiKey: "AIzaSyBnxruqFdBHEHTSVXl-QK848lsGvwBBH9U",
    authDomain: "mlo5-users.firebaseapp.com",
    databaseURL: "https://mlo5-users-default-rtdb.firebaseio.com",
    projectId: "mlo5-users",
    appId: "1:142086858806:web:64c50f3a8d6250a2049097"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const rtdb = getDatabase(app);

  // UI
  const connDot = document.getElementById("connDot");
  const connText = document.getElementById("connText");
  const exitBtn = document.getElementById("exitBtn");

  const onlineList = document.getElementById("onlineList");
  const onlineCount = document.getElementById("onlineCount");
  const meBadge = document.getElementById("meBadge");
  const statusSelect = document.getElementById("statusSelect");
  const ignoreCount = document.getElementById("ignoreCount");

  const messagesDiv = document.getElementById("messages");
  const chatForm = document.getElementById("chatForm");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");

  const emojiBtn = document.getElementById("emojiBtn");
  const emojiPicker = document.getElementById("emojiPicker");
  const emojiGrid = document.getElementById("emojiGrid");

  const modal = document.getElementById("modal");
  const modalErr = document.getElementById("modalErr");
  const nameInput = document.getElementById("nameInput");
  const genderInput = document.getElementById("genderInput");
  const ageInput = document.getElementById("ageInput");
  const enterBtn = document.getElementById("enterBtn");

  // Audio (join/leave only)
  const toastSound = new Audio("toast.mp3");
  toastSound.preload = "auto";
  toastSound.volume = 1.0;

  // State
  let user = null;
  let profile = null;     // {name, gender, age}
  let joinAtMs = null;
  let initialLoaded = false;
  let lastSoundAt = 0;

  // Ignore list per user
  const ignoreKey = (uid) => `chatIgnore_${uid}`;
  const profKey = (uid) => `chatProfile_${uid}`;
  const statusKey = (uid) => `chatStatus_${uid}`;
  let ignoredUids = new Set();

  // Basic profanity list (Ø®ÙÙŠÙ ÙƒØ¨Ø¯Ø§ÙŠØ© â€” Ù†ÙˆØ³Ø¹Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§)
  const BAD_WORDS = [
    // English
    "fuck","shit","bitch","asshole","bastard","dick","pussy","nigger",
    // Arabic (Ø¹ÙŠÙ†Ø§Øª Ø´Ø§Ø¦Ø¹Ø©)
    "ÙƒØ³","Ø²Ø¨","Ø´Ø±Ù…ÙˆØ·","Ù‚Ø­Ø¨Ù‡","Ù…Ù†ÙŠÙƒ","Ø®ÙˆÙ„","Ù„Ø¹Ù†Ø©","Ø·ÙŠØ²"
  ];

  // Emojis (Ø®ÙÙŠÙØ©)
  const EMOJIS = "ğŸ˜€ğŸ˜…ğŸ˜‚ğŸ¤£ğŸ˜ŠğŸ˜ğŸ˜˜ğŸ˜ğŸ¤©ğŸ¥³ğŸ˜¡ğŸ˜­ğŸ˜±ğŸ‘ğŸ‘ğŸ‘ğŸ™ğŸ”¥ğŸ’›â­âš¡ğŸ®ğŸ’€".split("");

  function genderSymbol(g) {
    return g === "male" ? "â™‚" : g === "female" ? "â™€" : "";
  }

  function statusLabel(s) {
    switch (s) {
      case "busy": return "â›” Ù…Ø´ØºÙˆÙ„";
      case "work": return "ğŸ’¼ Ø¨Ø§Ù„Ø¹Ù…Ù„";
      case "car": return "ğŸš— Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø©";
      case "food": return "ğŸ” Ø·Ø¹Ø§Ù…";
      case "out": return "ğŸŒ™ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬";
      default: return "â›” Ù…Ø´ØºÙˆÙ„";
    }
  }

  function sanitizeName(raw) {
    // ÙŠØ³Ù…Ø­ Ø¹Ø±Ø¨ÙŠ + Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ + Ø£Ø±Ù‚Ø§Ù… + Ù…Ø³Ø§ÙØ©
    let n = String(raw || "");
    n = n.replace(/[^0-9A-Za-z\u0600-\u06FF ]+/g, "");
    n = n.replace(/\s+/g, " ").trim();
    return n;
  }

  function isProfane(text) {
    const t = String(text || "").toLowerCase();
    return BAD_WORDS.some(w => t.includes(w));
  }

  function formatTime(tsMs) {
    if (!tsMs || Number.isNaN(tsMs)) return "";
    const d = new Date(tsMs);
    let h = d.getHours();
    const m = String(d.getMinutes()).padStart(2, "0");
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if (h === 0) h = 12;
    return `${h}:${m} ${ampm}`;
  }

  function setModalError(msg) {
    modalErr.style.display = msg ? "block" : "none";
    modalErr.textContent = msg || "";
  }

  // Grid parallax (Ù†ÙØ³ index)
  const root = document.documentElement;
  document.addEventListener("mousemove", (e) => {
    const xRatio = e.clientX / window.innerWidth - 0.5;
    const yRatio = e.clientY / window.innerHeight - 0.5;
    const maxShift = 40;
    root.style.setProperty("--grid-x", (xRatio * maxShift).toFixed(1) + "px");
    root.style.setProperty("--grid-y", (yRatio * maxShift).toFixed(1) + "px");
  });

  // Emoji UI
  function buildEmojiGrid() {
    emojiGrid.innerHTML = "";
    EMOJIS.forEach(em => {
      const b = document.createElement("div");
      b.className = "emojiItem";
      b.textContent = em;
      b.addEventListener("click", () => {
        insertAtCursor(msgInput, em);
        hideEmoji();
      });
      emojiGrid.appendChild(b);
    });
  }
  buildEmojiGrid();

  function showEmoji() {
    emojiPicker.style.display = "block";
    emojiPicker.setAttribute("aria-hidden", "false");
  }
  function hideEmoji() {
    emojiPicker.style.display = "none";
    emojiPicker.setAttribute("aria-hidden", "true");
  }
  emojiBtn.addEventListener("click", () => {
    if (emojiPicker.style.display === "block") hideEmoji();
    else showEmoji();
  });
  document.addEventListener("click", (e) => {
    if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) hideEmoji();
  });

  function insertAtCursor(input, text) {
    const start = input.selectionStart ?? input.value.length;
    const end = input.selectionEnd ?? input.value.length;
    const before = input.value.slice(0, start);
    const after = input.value.slice(end);
    input.value = before + text + after;
    const pos = start + text.length;
    input.setSelectionRange(pos, pos);
    input.focus();
  }

  // Auth
  onAuthStateChanged(auth, async (u) => {
    if (!u) {
      // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹
      location.href = "login.html";
      return;
    }
    user = u;
    meBadge.textContent = "Ø£Ù†Øª";

    // load ignore set
    try {
      const raw = localStorage.getItem(ignoreKey(user.uid));
      ignoredUids = new Set(raw ? JSON.parse(raw) : []);
    } catch { ignoredUids = new Set(); }
    refreshIgnoreCount();

    watchConnection();

    // load profile if exists
    const savedProfile = localStorage.getItem(profKey(user.uid));
    if (savedProfile) {
      profile = JSON.parse(savedProfile);
      // load status
      const savedStatus = localStorage.getItem(statusKey(user.uid)) || "busy";
      statusSelect.value = savedStatus;
      await enterChat(savedStatus);
    } else {
      modal.style.display = "flex";
    }
  });

  // Exit button (Ù„Ø§ ÙŠØ¹Ù…Ù„ signOut)
  exitBtn.addEventListener("click", async () => {
    try {
      if (user && profile) {
        await writeSystem("leave");
        await remove(ref(rtdb, "onlineUsers/" + user.uid));
      }
    } catch {}
    location.href = "index.html";
  });

  // Modal enter
  enterBtn.addEventListener("click", async () => {
    setModalError("");

    const cleaned = sanitizeName(nameInput.value);
    const g = genderInput.value;
    const age = Number(ageInput.value);

    if (!cleaned || cleaned.length < 3) {
      setModalError("Ø§Ù„Ø§Ø³Ù… Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ²).");
      return;
    }
    if (!g) {
      setModalError("Ø§Ø®ØªØ§Ø± Ø§Ù„Ø¬Ù†Ø³.");
      return;
    }
    if (!Number.isFinite(age) || age < 10) {
      setModalError("Ø§Ù„Ø¹Ù…Ø± Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 10 Ø£Ùˆ Ø£ÙƒØ«Ø±.");
      return;
    }

    profile = { name: cleaned, gender: g, age };
    localStorage.setItem(profKey(user.uid), JSON.stringify(profile));

    const savedStatus = localStorage.getItem(statusKey(user.uid)) || "busy";
    statusSelect.value = savedStatus;

    await enterChat(savedStatus);
  });

  // Status change
  statusSelect.addEventListener("change", async () => {
    if (!user || !profile) return;
    const s = statusSelect.value || "busy";
    localStorage.setItem(statusKey(user.uid), s);
    await updatePresenceStatus(s);
  });

  async function enterChat(statusVal) {
    // unlock audio with user interaction best-effort
    toastSound.play().then(() => {
      toastSound.pause();
      toastSound.currentTime = 0;
    }).catch(() => {});

    // Enable input
    msgInput.disabled = false;
    sendBtn.disabled = false;

    // join time (no old messages)
    joinAtMs = Date.now();

    // presence (Realtime DB)
    await updatePresenceStatus(statusVal, true);

    // system join
    await writeSystem("join");

    // close modal
    modal.style.display = "none";

    // start listeners
    startOnlineListener();
    startMessagesListener();
  }

  async function updatePresenceStatus(statusVal, first = false) {
    const onlineRef = ref(rtdb, "onlineUsers/" + user.uid);
    const payload = {
      uid: user.uid,
      name: profile.name,
      gender: profile.gender,
      age: profile.age,
      status: statusVal || "busy",
      statusText: statusLabel(statusVal || "busy")
    };

    await set(onlineRef, payload);
    if (first) onDisconnect(onlineRef).remove();
  }

  // Firestore system messages (createdAtMs to filter)
  async function writeSystem(type) {
    const text =
      type === "join" ? `${profile.name} Ø¯Ø®Ù„ Ø§Ù„Ø´Ø§Øª` :
      type === "leave" ? `${profile.name} Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø´Ø§Øª` : "";

    return addDoc(collection(db, "globalMessages"), {
      system: true,
      type,
      text,
      actorUid: user.uid,
      actorName: profile.name,
      actorGender: profile.gender,
      createdAt: serverTimestamp(),
      createdAtMs: Date.now()
    });
  }

  // Messages listener (since joinAtMs only)
  function startMessagesListener() {
    initialLoaded = false;

    const q = query(
      collection(db, "globalMessages"),
      where("createdAtMs", ">=", joinAtMs),
      orderBy("createdAtMs", "asc")
    );

    onSnapshot(q, (snap) => {
      messagesDiv.innerHTML = "";
      const isFirst = !initialLoaded;

      snap.forEach((doc) => {
        const m = doc.data();

        // Ignore feature
        if (!m.system && m.uid && ignoredUids.has(m.uid)) return;

        if (m.system) {
          const div = document.createElement("div");
          div.className = "system";
          div.textContent = m.text || "";
          messagesDiv.appendChild(div);

          // ğŸ”Š Sound only for join/leave (not self), and not on initial load
          if (!isFirst && (m.type === "join" || m.type === "leave") && m.actorUid && m.actorUid !== user.uid) {
            const now = Date.now();
            if (now - lastSoundAt > 800) {
              lastSoundAt = now;
              toastSound.currentTime = 0;
              toastSound.play().catch(() => {});
            }
          }
        } else {
          const div = document.createElement("div");
          div.className = "msg" + (m.uid === user.uid ? " me" : "");

          const sym = genderSymbol(m.gender);
          const name = `${sym ? sym + " " : ""}${m.name || "Ù…Ø³ØªØ®Ø¯Ù…"}`;
          const time = formatTime(m.createdAtMs);

          div.innerHTML = `
            <div class="msgHead">
              <div class="nameTag">${escapeHtml(name)}</div>
              <div class="timeTag">${escapeHtml(time)}</div>
            </div>
            <div>${escapeHtml(m.text || "")}</div>
          `;

          messagesDiv.appendChild(div);
        }
      });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      initialLoaded = true;
    });
  }

  // Send message (no sound)
  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!user || !profile) return;

    const text = String(msgInput.value || "").trim();
    if (!text) return;

    // profanity filter
    if (isProfane(text)) {
      alert("âŒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø±ÙÙˆØ¶Ø© (ÙƒÙ„Ø§Ù… ØºÙŠØ± Ù„Ø§Ø¦Ù‚).");
      return;
    }

    msgInput.value = "";

    await addDoc(collection(db, "globalMessages"), {
      system: false,
      text,
      uid: user.uid,
      name: profile.name,
      gender: profile.gender,
      age: profile.age,
      createdAt: serverTimestamp(),
      createdAtMs: Date.now()
    });
  });

  // Online list + Ignore toggles
  function startOnlineListener() {
    const allOnlineRef = ref(rtdb, "onlineUsers");
    onValue(allOnlineRef, (snap) => {
      const users = snap.val() || {};
      const arr = Object.values(users);

      onlineCount.textContent = String(arr.length);
      onlineList.innerHTML = "";

      arr
        .sort((a, b) => (a.name || "").localeCompare(b.name || ""))
        .forEach((u) => {
          const row = document.createElement("div");
          row.className = "userRow";

          const isMe = u.uid === user.uid;
          const sym = genderSymbol(u.gender);
          const displayName = `${sym ? sym + " " : ""}${u.name || "Ù…Ø³ØªØ®Ø¯Ù…"}`;
          const st = u.statusText || statusLabel(u.status || "busy");

          const left = document.createElement("div");
          left.className = "userMeta";
          left.innerHTML = `
            <b>${escapeHtml(displayName)}</b>
            <span>
              <span class="miniPill">${escapeHtml(st)}</span>
              ${isMe ? '<span class="miniPill">Ø£Ù†Øª</span>' : ''}
            </span>
          `;

          row.appendChild(left);

          const btn = document.createElement("button");
          btn.className = "ignoreBtn";
          btn.type = "button";

          if (isMe) {
            btn.textContent = "â€”";
            btn.style.opacity = "0.6";
            btn.style.cursor = "default";
            btn.disabled = true;
          } else {
            const isIgnored = ignoredUids.has(u.uid);
            btn.textContent = "â›”";
            btn.classList.toggle("ignored", isIgnored);
            btn.title = isIgnored ? "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¬Ø§Ù‡Ù„" : "ØªØ¬Ø§Ù‡Ù„";
            btn.addEventListener("click", () => toggleIgnore(u.uid));
          }

          row.appendChild(btn);
          onlineList.appendChild(row);
        });
    });
  }

  function toggleIgnore(uid) {
    if (!uid) return;
    if (ignoredUids.has(uid)) ignoredUids.delete(uid);
    else ignoredUids.add(uid);

    localStorage.setItem(ignoreKey(user.uid), JSON.stringify(Array.from(ignoredUids)));
    refreshIgnoreCount();

    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙˆØ±Ø§Ù‹ (Ø¨Ø¨Ø³Ø§Ø·Ø©: trigger by rewriting snapshot happens on next update)
    // Ù„ÙƒÙ† Ù†Ù‚Ø¯Ø± Ù†Ø¹Ù…Ù„ â€œÙÙ„ØªØ±Ø© Ù…Ø­Ù„ÙŠØ©â€ Ø¨Ø³ÙŠØ·Ø© Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:
    // Ø£Ø³Ù‡Ù„: Ø®Ù„Ù‘ÙŠÙ‡ Ø·Ø¨ÙŠØ¹ÙŠ â€” Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø­Ø¯Ø« snapshot Ø±Ø§Ø­ ÙŠØ¹ÙŠØ¯ Ø±Ø³Ù….
    // ÙˆÙ…Ø¹ Ø°Ù„ÙƒØŒ Ù…Ù† Ø£Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©:
    messagesDiv.querySelectorAll(".msg").forEach(el => el.remove()); // ØªÙ†Ø¸ÙŠÙ Ø¨Ø³ÙŠØ·
    startMessagesListener(); // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ listener Ø¨Ù†ÙØ³ joinAtMs (Ù†ÙØ³ Ø§Ù„ØªÙ‚Ø³ÙŠÙ…Ø©)
  }

  function refreshIgnoreCount() {
    ignoreCount.textContent = `ØªØ¬Ø§Ù‡Ù„: ${ignoredUids.size}`;
  }

  // Connection indicator (RTDB)
  function watchConnection() {
    const connRef = ref(rtdb, ".info/connected");
    onValue(connRef, (snap) => {
      const connected = snap.val() === true;
      connDot.classList.toggle("on", connected);
      connText.textContent = connected ? "Ù…ØªØµÙ„" : "ØºÙŠØ± Ù…ØªØµÙ„";
    });
  }

  // Best-effort leave system message (may not always fire, presence is server-guaranteed)
  window.addEventListener("beforeunload", () => {
    try { if (user && profile) writeSystem("leave"); } catch {}
  });

  function escapeHtml(s = "") {
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;"
    }[m]));
  }
</script>
</body>
</html>
