<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Games - M L O 5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- âœ… Favicon -->
  <link rel="icon" href="./favicon.png?v=2" type="image/png" sizes="32x32" />
  <link rel="icon" href="./favicon.png?v=2" type="image/png" sizes="16x16" />
  <link rel="apple-touch-icon" href="./favicon.png?v=2" />
  <meta name="theme-color" content="#020202" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-dark:#020202;
      --yellow:#facc15;
      --white:#f9fafb;
      --muted:#9ca3af;
      --border-subtle: rgba(156,163,175,.35);
      --radius-lg:20px;
      --radius-full:999px;
      --grid-x: 0px;
      --grid-y: 0px;
    }
    *{ box-sizing:border-box; margin:0; padding:0; }

    body{
      font-family:"Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-dark);
      color: var(--white);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:stretch;
      position:relative;
      cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><polygon points='2,2 2,22 8,16 14,26 18,24 12,14 20,14' fill='%23facc15' stroke='%23000000' stroke-width='1.5'/></svg>") 0 0, auto;
    }

    .bg-grid{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      background-image: radial-gradient(circle, rgba(249,250,251,.55) 1px, transparent 1px);
      background-size: 30px 30px;
      background-position: calc(50% + var(--grid-x)) calc(50% + var(--grid-y));
      opacity:.25;
      mix-blend-mode: screen;
    }

    .page{
      width:100%;
      max-width:1100px;
      padding:32px 16px 40px;
      margin:auto;
      position:relative;
      z-index:1;
    }

    /* âœ… TOP BAR */
    .top-bar{
      display:flex;
      justify-content:flex-start;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
      direction:ltr;
      flex-wrap:wrap;
    }
    .top-bar-right{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      direction:ltr;
      flex-wrap:wrap;
    }

    .icon-btn{
      width: 40px; height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(250,204,21,.6);
      background: rgba(0,0,0,.7);
      color: var(--yellow);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      box-shadow: 0 10px 24px rgba(0,0,0,.9), 0 0 0 1px rgba(15,23,42,.9);
      transition: transform .15s ease, background .15s ease, box-shadow .15s ease, color .15s ease;
      flex: 0 0 auto;
      font-size: 1.1rem;
      user-select:none;
    }
    .icon-btn:hover{
      transform: translateY(-1px);
      background: rgba(250,204,21,.14);
      box-shadow: 0 14px 30px rgba(0,0,0,1), 0 0 0 1px rgba(250,204,21,.75);
    }

    .lang-toggle{
      width: 40px; height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.7);
      background: radial-gradient(circle at top, #111111, #020202);
      color: var(--yellow);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size: 1.05rem;
      box-shadow: 0 10px 24px rgba(0,0,0,.9), 0 0 0 1px rgba(15,23,42,.9);
      transition: background .15s ease, transform .15s ease, box-shadow .15s ease;
      flex: 0 0 auto;
    }
    .lang-toggle:hover{
      transform: translateY(-1px);
      background: radial-gradient(circle at top, #facc15, #fbbf24);
      color:#000;
      box-shadow: 0 14px 30px rgba(0,0,0,1), 0 0 0 1px rgba(250,204,21,.8);
    }

    /* Header */
    .hero-title{ text-align:center; margin-top: 6px; margin-bottom: 10px; }
    .hero-title h1{
      font-family:"Poppins", system-ui, sans-serif;
      font-weight:800;
      font-size: clamp(2.2rem, 5vw, 3.2rem);
      letter-spacing: .22em;
      text-transform: uppercase;
      color: var(--white);
      white-space: nowrap;
      direction:ltr;
      unicode-bidi:bidi-override;
    }
    .hero-sub{
      text-align:center;
      font-size: .92rem;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.6;
    }

    .divider{ width:100%; margin: 18px auto; position:relative; height:1px; }
    .divider-line{ height:1px; width:100%; background: linear-gradient(90deg, transparent, rgba(156,163,175,.4), transparent); }
    .divider-glow{
      position:absolute; inset:0; margin:auto;
      height:12px; width:40%;
      background: radial-gradient(circle, rgba(250,204,21,.5), transparent 70%);
      opacity:.7; filter: blur(3px); pointer-events:none;
    }

    .wrap{
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.22);
      background: linear-gradient(145deg, rgba(2,2,2,.9), rgba(5,5,5,.9));
      box-shadow: 0 12px 30px rgba(0,0,0,.85), 0 0 0 1px rgba(55,65,81,.55);
      padding: 14px;
    }

    .head-row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .title{
      font-size: 1rem;
      font-weight: 900;
      color: var(--yellow);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      color: rgba(156,163,175,.9);
      font-size: .85rem;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(156,163,175,.22);
      background: rgba(0,0,0,.25);
    }

    .section{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
    }

    .card{
      background: linear-gradient(145deg, #020202, #050505);
      border-radius: 18px;
      padding: 14px 14px 16px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 10px 28px rgba(0,0,0,.7), 0 0 0 1px rgba(55,65,81,.5);
      position: relative;
      overflow:hidden;
      min-height: 160px;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at top, rgba(250,204,21,.14), transparent 55%);
      opacity:0;
      transition: opacity .2s ease;
      pointer-events:none;
    }
    .card:hover{
      border-color: rgba(250,204,21,.85);
      box-shadow: 0 16px 40px rgba(0,0,0,.9), 0 0 0 1px rgba(250,204,21,.5);
    }
    .card:hover::before{ opacity:1; }

    .card h2{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin:0 0 8px;
      font-size: 1.05rem;
      font-weight: 900;
      color: var(--yellow);
    }
    .desc{
      color: rgba(249,250,251,.78);
      line-height: 1.7;
      font-size: .9rem;
      margin-bottom: 12px;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn{
      cursor:pointer;
      border:none;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      background: var(--yellow);
      color:#111827;
      box-shadow: 0 14px 30px rgba(250,204,21,.18);
      transition: transform .15s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }

    .btnGhost{
      background: transparent;
      color: rgba(249,250,251,.9);
      border: 1px solid rgba(156,163,175,.25);
      box-shadow:none;
    }

    .stat{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      color: rgba(249,250,251,.85);
      font-weight:800;
      font-size:.85rem;
    }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(156,163,175,.22);
      background: rgba(0,0,0,.25);
      white-space: nowrap;
    }

    /* ClickRush tap */
    .bigTap{
      margin-top:12px;
      border-radius: 18px;
      border:1px dashed rgba(250,204,21,.35);
      background: rgba(250,204,21,.06);
      min-height:150px;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      font-weight:900;
      user-select:none;
      cursor:pointer;
      padding: 10px;
    }

    /* Simon grid */
    .simon{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .sbtn{
      height:90px;
      border-radius:18px;
      border:1px solid rgba(156,163,175,.18);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .sbtn::after{
      content:"";
      position:absolute; inset:0;
      background: rgba(250,204,21,.22);
      opacity:0;
      transition: opacity .15s ease;
    }
    .sbtn.flash::after{ opacity:1; }

    /* Leaderboard */
    .lb-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 6px;
    }
    .lb-title{
      font-weight: 900;
      color: var(--yellow);
      font-size: 1rem;
    }
    .lb-note{
      color: rgba(156,163,175,.9);
      font-size: .8rem;
    }
    .lb-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top: 6px;
    }
    .lb-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(156,163,175,.22);
      background: rgba(0,0,0,.25);
    }
    .lb-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .lb-rank{
      width:30px;
      height:30px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:"Poppins",system-ui,sans-serif;
      font-weight:900;
      font-size:.85rem;
      border: 1px solid rgba(250,204,21,.35);
      background: rgba(250,204,21,.08);
      color: var(--yellow);
      flex: 0 0 auto;
    }
    .lb-name{
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 900;
      color: rgba(249,250,251,.92);
    }
    .lb-score{
      font-family:"Poppins",system-ui,sans-serif;
      font-weight: 900;
      color: var(--yellow);
      flex: 0 0 auto;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 10;
      padding: 16px;
    }
    .modal{
      width:100%;
      max-width: 420px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.22);
      background: linear-gradient(145deg, rgba(2,2,2,.95), rgba(5,5,5,.95));
      box-shadow: 0 18px 45px rgba(0,0,0,.95);
      padding: 14px;
    }
    .modal h3{
      margin: 0 0 8px;
      color: var(--yellow);
      font-weight: 900;
    }
    .modal p{
      color: rgba(249,250,251,.78);
      line-height: 1.7;
      font-size: .9rem;
      margin-bottom: 10px;
    }
    .inp{
      width:100%;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(156,163,175,.25);
      color: var(--white);
      border-radius: 14px;
      padding: 12px 12px;
      outline:none;
      font-family:inherit;
      font-weight: 800;
    }
    .err{
      margin-top: 8px;
      color: rgba(248,113,113,.95);
      font-size: .85rem;
      min-height: 18px;
    }

    .footer{
      margin-top: 26px;
      padding-top: 18px;
      border-top: 1px solid rgba(31,41,55,.9);
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .footer-bottom{
      text-align:center;
      font-size:.75rem;
      color: rgba(107,114,128,.9);
    }
    .footer-rights{
      text-align:center;
      font-size:.72rem;
      color: rgba(107,114,128,.9);
      margin-top: -6px;
      direction:ltr;
    }

    /* âœ… Entry modal (login/guest) - Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
    .entry-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .entry-actions .btn{ flex:1; min-width: 160px; }

    @media (max-width: 900px){
      .section{ grid-template-columns: 1fr; }
      .top-bar-right{ width: 100%; justify-content: flex-start; margin-left: 0; }
    }
  </style>
</head>

<body>
  <div class="bg-grid"></div>

  <!-- âœ… Entry modal: Login / Guest (Ù…Ø«Ù„ ÙÙƒØ±Ø© Ø§Ù„Ù…Ù†ØªØ¯Ù‰) -->
  <div id="entry-backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 id="eTitle">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø£Ù„Ø¹Ø§Ø¨</h3>
      <p id="eDesc">Ø§Ø®ØªØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„:</p>

      <div class="entry-actions">
        <button id="eLogin" class="btn btnGhost" type="button">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
        <button id="eGuest" class="btn" type="button">ğŸ‘¤ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ</button>
      </div>

      <div id="eErr" class="err"></div>
    </div>
  </div>

  <!-- Nickname modal -->
  <div id="modal-backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 id="mTitle">Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„Ù„ÙŠØ¯Ø± Ø¨ÙˆØ±Ø¯</h3>
      <p id="mDesc">Ø§ÙƒØªØ¨ Ø§Ø³Ù… (3-20 Ø­Ø±Ù/Ø±Ù‚Ù…) Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ ğŸ”¥</p>
      <input id="nick" class="inp" type="text" placeholder="Ù…Ø«Ø§Ù„: Mlo5" maxlength="20" />
      <div class="row" style="margin-top:10px">
        <button id="saveNick" class="btn">Ø­ÙØ¸</button>
        <button id="skipNick" class="btn btnGhost">ØªØ®Ø·ÙŠ</button>
      </div>
      <div id="mErr" class="err"></div>
    </div>
  </div>

  <main class="page">
    <div class="top-bar">
      <a class="icon-btn" href="index.html" aria-label="Back to Home" title="Home">ğŸ </a>
      <div class="top-bar-right">
        <button id="lang-toggle" class="lang-toggle" title="Toggle">ğŸŒ</button>
      </div>
    </div>

    <header class="hero-title">
      <h1 aria-label="M L O 5">MLO5</h1>
      <p id="hero-sub" class="hero-sub">Ø§Ù„Ø¹Ø¨ ÙˆØ®Ù„ÙŠ Ø§Ù„Ø´Ø¨Ø§Ø¨ ØªØ³ØªÙØ§Ø¯</p>
    </header>

    <div class="divider">
      <div class="divider-line"></div>
      <div class="divider-glow"></div>
    </div>

    <section class="wrap" aria-label="Games">
      <div class="head-row">
        <div class="title">ğŸ® Mini Games (Online)</div>
        <div class="pill">
          <span id="authState">Connecting...</span>
          <span style="opacity:.65">â€¢</span>
          <span id="playerName">Guest</span>
        </div>
      </div>

      <!-- GAME 1 -->
      <div class="section">
        <div class="card">
          <h2>
            <span>Click Rush âš¡</span>
            <span class="chip">ğŸ† Best: <span id="crBest">â€”</span></span>
          </h2>
          <p class="desc">Ø§Ø¶ØºØ· Ø¨Ø£Ø³Ø±Ø¹ Ù…Ø§ ÙŠÙ…ÙƒÙ† Ø®Ù„Ø§Ù„ 5 Ø«ÙˆØ§Ù†ÙŠ. Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ø¨ØªÙ†Ø­ÙØ¸ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙˆØªØ·Ù„Ø¹ Ø¨Ø§Ù„Ù„ÙŠØ¯Ø± Ø¨ÙˆØ±Ø¯.</p>

          <div class="row">
            <button class="btn" id="crStart">Ø§Ø¨Ø¯Ø£</button>
            <button class="btn btnGhost" id="crReplay">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ±ØªÙŠØ¨</button>
          </div>

          <div class="bigTap" id="crTap">Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£" Ø£ÙˆÙ„Ø§Ù‹</div>

          <div class="stat">
            <div class="chip">â±ï¸ Ø§Ù„ÙˆÙ‚Øª: <span id="crTime">5</span>s</div>
            <div class="chip">ğŸ–±ï¸ Ø§Ù„Ù†Ù‚Ø±Ø§Øª: <span id="crClicks">0</span></div>
          </div>
        </div>

        <div class="card">
          <div class="lb-head">
            <div class="lb-title">ğŸ† Click Rush Leaderboard</div>
            <div class="lb-note">Top 10 (Live)</div>
          </div>
          <div id="lb-cr" class="lb-list"></div>
        </div>
      </div>

      <!-- GAME 2 -->
      <div class="section">
        <div class="card">
          <h2>
            <span>ğŸ¯ Ø®Ù…Ù† Ø§Ù„Ø±Ù‚Ù…</span>
            <span class="chip">ğŸ† Best: <span id="gnBest">â€”</span></span>
          </h2>
          <p class="desc">Ø£Ù†Ø§ Ù…Ø®ØªØ§Ø± Ø±Ù‚Ù… Ø¨ÙŠÙ† 1 Ùˆ 50. ÙƒÙ„ Ù…Ø§ Ù‚Ù„Ù‘Øª Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒØŒ Ù†Ù‚Ø§Ø·Ùƒ Ø¨ØªÙƒÙˆÙ† Ø£Ø¹Ù„Ù‰.</p>

          <div class="row">
            <input id="gnInput" class="inp" style="max-width:260px" type="number" min="1" max="50" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… 1-50" />
            <button class="btn" id="gnTry">Ø¬Ø±Ù‘Ø¨</button>
            <button class="btn btnGhost" id="gnNew">Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn btnGhost" id="gnReplay">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ±ØªÙŠØ¨</button>
          </div>

          <div class="stat">
            <div class="chip">ğŸ” Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: <span id="gnTries">0</span></div>
            <div class="chip">ğŸ’¬ Ø§Ù„Ø­Ø§Ù„Ø©: <span id="gnMsg">Ø¬Ø§Ù‡Ø²</span></div>
            <div class="chip">â­ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬ÙˆÙ„Ø©: <span id="gnPoints">0</span></div>
          </div>

          <p class="desc" style="margin-top:10px; color: rgba(156,163,175,.9); font-size:.85rem;">
            Ø§Ù„Ù†Ù‚Ø§Ø· = 1000 - (Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ã— 10). (ÙƒÙ„ Ù…Ø§ Ø£Ø³Ø±Ø¹ Ø£ÙØ¶Ù„)
          </p>
        </div>

        <div class="card">
          <div class="lb-head">
            <div class="lb-title">ğŸ† Guess Leaderboard</div>
            <div class="lb-note">Top 10 (Live)</div>
          </div>
          <div id="lb-gn" class="lb-list"></div>
        </div>
      </div>

      <!-- GAME 3 -->
      <div class="section">
        <div class="card">
          <h2>
            <span>ğŸ§  Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Simon)</span>
            <span class="chip">ğŸ† Best: <span id="smBest">â€”</span></span>
          </h2>
          <p class="desc">ØªØ§Ø¨Ø¹ Ø§Ù„ØªØ³Ù„Ø³Ù„ ÙˆÙƒØ±Ù‘Ø±Ù‡. ÙƒÙ„ Ù…Ø±Ø© Ø¨ÙŠØ²ÙŠØ¯ Ù…Ø³ØªÙˆÙ‰. Ø¥Ø°Ø§ ØºÙ„Ø·Øª Ø¨Ù†Ø±Ø¬Ø¹.</p>

          <div class="row">
            <button class="btn" id="smStart">Ø§Ø¨Ø¯Ø£</button>
            <button class="btn btnGhost" id="smReset">Ø¥Ø¹Ø§Ø¯Ø©</button>
            <button class="btn btnGhost" id="smReplay">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ±ØªÙŠØ¨</button>
          </div>

          <div class="simon" id="simonGrid">
            <button class="sbtn" data-i="0" aria-label="simon 0"></button>
            <button class="sbtn" data-i="1" aria-label="simon 1"></button>
            <button class="sbtn" data-i="2" aria-label="simon 2"></button>
            <button class="sbtn" data-i="3" aria-label="simon 3"></button>
          </div>

          <div class="stat">
            <div class="chip">ğŸ“ˆ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="smLevel">0</span></div>
            <div class="chip">ğŸ’¬ Ø§Ù„Ø­Ø§Ù„Ø©: <span id="smMsg">Ø§Ø¶ØºØ· Ø§Ø¨Ø¯Ø£</span></div>
          </div>
        </div>

        <div class="card">
          <div class="lb-head">
            <div class="lb-title">ğŸ† Simon Leaderboard</div>
            <div class="lb-note">Top 10 (Live)</div>
          </div>
          <div id="lb-sm" class="lb-list"></div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="footer-bottom">Â© <span id="year-span">2025</span> Â· ØµÙ†Ø¹ Ø¨Ø­Ø¨ ğŸ’›.</div>
      <div class="footer-rights">All rights reserved MLO5 Â©</div>
    </footer>
  </main>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBnxruqFdBHEHTSVXl-QK848lsGvwBBH9U",
      authDomain: "mlo5-users.firebaseapp.com",
      databaseURL: "https://mlo5-users-default-rtdb.firebaseio.com",
      projectId: "mlo5-users",
      appId: "1:142086858806:web:64c50f3a8d6250a2049097"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp,
      collection, query, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    $("year-span").textContent = new Date().getFullYear();

    // BG grid move
    const root = document.documentElement;
    document.addEventListener("mousemove", (e) => {
      const xRatio = e.clientX / window.innerWidth - 0.5;
      const yRatio = e.clientY / window.innerHeight - 0.5;
      const maxShift = 40;
      root.style.setProperty("--grid-x", (xRatio * maxShift).toFixed(1) + "px");
      root.style.setProperty("--grid-y", (yRatio * maxShift).toFixed(1) + "px");
    });

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // âœ… Entry gate (Login / Guest)
    // =========================
    const entryBackdrop = $("entry-backdrop");
    const eErr = $("eErr");
    const eLogin = $("eLogin");
    const eGuest = $("eGuest");

    function showEntry(msg=""){
      eErr.textContent = msg || "";
      entryBackdrop.style.display = "flex";
    }
    function hideEntry(){
      entryBackdrop.style.display = "none";
      eErr.textContent = "";
    }

    eLogin.addEventListener("click", () => {
      // Ø²ÙŠ Ø§Ù„Ù…Ù†ØªØ¯Ù‰
      location.href = "login.html";
    });

    eGuest.addEventListener("click", async () => {
      eErr.textContent = "";
      try{
        $("authState").textContent = "Signing in...";
        await signInAnonymously(auth);
        hideEntry();
      }catch(e){
        console.error(e);
        eErr.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.";
        $("authState").textContent = "Auth error âŒ";
      }
    });

    // =========================
    // Nickname (NO localStorage)
    // =========================
    let uid = null;
    let nickname = "Guest";

    function cleanName(s){
      const v = (s || "").trim().replace(/\s+/g, " ");
      if(v.length < 3 || v.length > 20) return null;
      if(!/^[\p{L}\p{N}_ ]+$/u.test(v)) return null;
      return v;
    }

    function openModal(){
      $("modal-backdrop").style.display = "flex";
      $("mErr").textContent = "";
      $("nick").value = cleanName(nickname) ? nickname : "";
      $("nick").focus();
    }
    function closeModal(){ $("modal-backdrop").style.display = "none"; }

    $("saveNick").addEventListener("click", async () => {
      const v = cleanName($("nick").value);
      if(!v){ $("mErr").textContent = "Ø§Ù„Ø§Ø³Ù… Ù„Ø§Ø²Ù… 3-20 (Ø­Ø±ÙˆÙ/Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)."; return; }
      nickname = v;
      $("playerName").textContent = nickname;
      closeModal();

      if(!uid) return;
      const games = ["clickrush","guess","simon"];
      for(const g of games){
        const lbRef = doc(db, `leaderboards/${g}/top/${uid}`);
        const snap = await getDoc(lbRef);
        if(!snap.exists()){
          await setDoc(lbRef, { score: 0, name: nickname, updatedAt: serverTimestamp() });
        } else {
          await setDoc(lbRef, { name: nickname, updatedAt: serverTimestamp() }, { merge: true });
        }
      }
    });

    $("skipNick").addEventListener("click", closeModal);

    async function loadNameFromCloud(){
      if(!uid) return;
      for(const g of ["clickrush","guess","simon"]){
        const ref = doc(db, `leaderboards/${g}/top/${uid}`);
        const snap = await getDoc(ref);
        if(snap.exists() && snap.data()?.name){
          nickname = String(snap.data().name);
          $("playerName").textContent = nickname;
          return;
        }
      }
      openModal();
    }

    // =========================
    // Common score functions
    // =========================
    const TOP_N = 10;

    async function getMyBest(gameId){
      if(!uid) return 0;
      const ref = doc(db, `users/${uid}/scores/${gameId}`);
      const snap = await getDoc(ref);
      if(!snap.exists()) return 0;
      return Number(snap.data().best || 0);
    }

    async function submitBest(gameId, score){
      if(!uid) return;
      const nameToUse = cleanName(nickname) ? nickname : "Guest";
      const scoreInt = Math.max(0, Math.floor(Number(score || 0)));

      const userRef = doc(db, `users/${uid}/scores/${gameId}`);
      const prevBest = await getMyBest(gameId);
      if(scoreInt > prevBest){
        await setDoc(userRef, { best: scoreInt, name: nameToUse, updatedAt: serverTimestamp() }, { merge:true });
      }

      const lbRef = doc(db, `leaderboards/${gameId}/top/${uid}`);
      const lbSnap = await getDoc(lbRef);
      const prevLB = lbSnap.exists() ? Number(lbSnap.data().score || 0) : 0;

      if(scoreInt > prevLB){
        await setDoc(lbRef, { score: scoreInt, name: nameToUse, updatedAt: serverTimestamp() }, { merge:true });
      } else if(lbSnap.exists() && lbSnap.data().name !== nameToUse && cleanName(nameToUse)) {
        await setDoc(lbRef, { name: nameToUse, updatedAt: serverTimestamp() }, { merge:true });
      }
    }

    function startLeaderboard(gameId, mountElId){
      const mount = $(mountElId);
      const q = query(
        collection(db, `leaderboards/${gameId}/top`),
        orderBy("score", "desc"),
        limit(TOP_N)
      );

      const render = (rows) => {
        mount.innerHTML = "";
        if(!rows.length){
          mount.innerHTML = `
            <div class="lb-row">
              <div class="lb-left">
                <div class="lb-rank">â€”</div>
                <div class="lb-name">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯</div>
              </div>
              <div class="lb-score">0</div>
            </div>`;
          return;
        }
        rows.forEach((r, idx) => {
          const nm = (r.name || "Guest").toString();
          const sc = Number(r.score || 0);
          mount.insertAdjacentHTML("beforeend", `
            <div class="lb-row">
              <div class="lb-left">
                <div class="lb-rank">${idx+1}</div>
                <div class="lb-name" title="${nm}">${nm}</div>
              </div>
              <div class="lb-score">${sc}</div>
            </div>
          `);
        });
      };

      return onSnapshot(q, (snap) => {
        const rows = [];
        snap.forEach(d => rows.push(d.data()));
        render(rows);
      }, (err) => {
        console.error("LB error", gameId, err);
        render([]);
      });
    }

    // =========================
    // Game 1: Click Rush
    // =========================
    let crRunning=false, crClicks=0, crLeft=5, crTimer=null;

    function crSetUI(){
      $("crClicks").textContent = crClicks;
      $("crTime").textContent = crLeft;
      $("crTap").textContent = crRunning ? "Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ø¨Ø³Ø±Ø¹Ø©!" : "Ø§Ø¶ØºØ· \"Ø§Ø¨Ø¯Ø£\" Ø£ÙˆÙ„Ø§Ù‹";
    }

    $("crStart").addEventListener("click", () => {
      if(crRunning) return;
      crRunning = true;
      crClicks = 0;
      crLeft = 5;
      crSetUI();

      crTimer = setInterval(async () => {
        crLeft -= 1;
        crSetUI();
        if(crLeft <= 0){
          clearInterval(crTimer);
          crRunning = false;
          $("crTap").textContent = `Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ù†ØªÙŠØ¬ØªÙƒ: ${crClicks}`;
          try{
            await submitBest("clickrush", crClicks);
            const best = await getMyBest("clickrush");
            $("crBest").textContent = String(best);
          }catch(e){ console.error(e); }
        }
      }, 1000);
    });

    $("crTap").addEventListener("click", () => {
      if(!crRunning) return;
      crClicks += 1;
      crSetUI();
    });

    // =========================
    // Game 2: Guess Number
    // =========================
    let gnSecret = Math.floor(Math.random()*50) + 1;
    let gnTries = 0;

    function gnReset(){
      gnSecret = Math.floor(Math.random()*50) + 1;
      gnTries = 0;
      $("gnTries").textContent = "0";
      $("gnMsg").textContent = "Ø¬Ø§Ù‡Ø²";
      $("gnPoints").textContent = "0";
      $("gnInput").value = "";
    }

    function gnPoints(){
      return Math.max(0, 1000 - (gnTries * 10));
    }

    async function gnTry(){
      const v = Number($("gnInput").value);
      if(!v || v < 1 || v > 50){
        $("gnMsg").textContent = "Ø§ÙƒØªØ¨ Ø±Ù‚Ù… ØµØ­ÙŠØ­ (1-50)";
        return;
      }

      gnTries += 1;
      $("gnTries").textContent = String(gnTries);

      if(v === gnSecret){
        $("gnMsg").textContent = `ØµØ­! ğŸ‰ Ø§Ù„Ø±Ù‚Ù… Ù‡Ùˆ ${gnSecret}`;
        const pts = gnPoints();
        $("gnPoints").textContent = String(pts);

        try{
          await submitBest("guess", pts);
          const best = await getMyBest("guess");
          $("gnBest").textContent = String(best);
        }catch(e){ console.error(e); }
      } else if(v < gnSecret){
        $("gnMsg").textContent = "Ø£Ø¹Ù„Ù‰ â¬†ï¸";
      } else {
        $("gnMsg").textContent = "Ø£Ù‚Ù„ â¬‡ï¸";
      }

      $("gnPoints").textContent = String(gnPoints());
    }

    $("gnTry").addEventListener("click", gnTry);
    $("gnNew").addEventListener("click", gnReset);
    $("gnInput").addEventListener("keydown", (e) => { if(e.key === "Enter") gnTry(); });

    // =========================
    // Game 3: Simon
    // =========================
    const smButtons = Array.from(document.querySelectorAll(".sbtn"));
    let smSeq=[], smUser=[], smPlaying=false, smActive=false;

    function smFlash(i){
      const b = smButtons[i];
      b.classList.add("flash");
      setTimeout(() => b.classList.remove("flash"), 180);
    }

    async function smShowSeq(){
      smPlaying = true;
      smActive = false;
      $("smMsg").textContent = "Ø´Ø§Ù‡Ø¯ Ø§Ù„ØªØ³Ù„Ø³Ù„...";
      await sleep(250);
      for(const i of smSeq){
        smFlash(i);
        await sleep(330);
      }
      smPlaying = false;
      smActive = true;
      $("smMsg").textContent = "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†";
    }

    function smReset(){
      smSeq = [];
      smUser = [];
      smPlaying = false;
      smActive = false;
      $("smLevel").textContent = "0";
      $("smMsg").textContent = "Ø§Ø¶ØºØ· Ø§Ø¨Ø¯Ø£";
    }

    async function smNext(){
      smUser = [];
      smSeq.push(Math.floor(Math.random()*4));
      $("smLevel").textContent = String(smSeq.length);
      await smShowSeq();
    }

    $("smStart").addEventListener("click", async () => {
      if(smPlaying) return;
      if(smSeq.length === 0) await smNext();
      else await smShowSeq();
    });

    $("smReset").addEventListener("click", smReset);

    smButtons.forEach(btn => {
      btn.addEventListener("click", async () => {
        if(!smActive || smPlaying) return;
        const i = Number(btn.dataset.i);
        smFlash(i);
        smUser.push(i);

        for(let k=0;k<smUser.length;k++){
          if(smUser[k] !== smSeq[k]){
            $("smMsg").textContent = "ØºÙ„Ø· âŒ Ø±Ø¬Ø¹Ù†Ø§ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©";
            smActive = false;

            const achieved = Math.max(0, smSeq.length - 1);
            try{
              await submitBest("simon", achieved);
              const best = await getMyBest("simon");
              $("smBest").textContent = String(best);
            }catch(e){ console.error(e); }

            await sleep(550);
            smReset();
            return;
          }
        }

        if(smUser.length === smSeq.length){
          $("smMsg").textContent = "ØµØ­ âœ… Ù…Ø³ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯...";
          smActive = false;

          try{
            await submitBest("simon", smSeq.length);
            const best = await getMyBest("simon");
            $("smBest").textContent = String(best);
          }catch(e){ console.error(e); }

          await sleep(450);
          smNext();
        }
      });
    });

    // =========================
    // Boot
    // =========================
    let unsubCR=null, unsubGN=null, unsubSM=null;

    function startAllLeaderboards(){
      if(unsubCR) unsubCR();
      if(unsubGN) unsubGN();
      if(unsubSM) unsubSM();
      unsubCR = startLeaderboard("clickrush", "lb-cr");
      unsubGN = startLeaderboard("guess", "lb-gn");
      unsubSM = startLeaderboard("simon", "lb-sm");
    }

    $("crReplay").addEventListener("click", startAllLeaderboards);
    $("gnReplay").addEventListener("click", startAllLeaderboards);
    $("smReplay").addEventListener("click", startAllLeaderboards);

    // âœ… Ø§Ù‡Ù… ØªØºÙŠÙŠØ±: Ù…Ø§ Ø¨Ù†Ø¹Ù…Ù„ signInAnonymously ØªÙ„Ù‚Ø§Ø¦ÙŠ
    onAuthStateChanged(auth, async (user) => {
      if(user){
        uid = user.uid;
        $("authState").textContent = "Online âœ…";
        hideEntry();

        await loadNameFromCloud();

        try{ $("crBest").textContent = String(await getMyBest("clickrush")); }catch{ $("crBest").textContent="â€”"; }
        try{ $("gnBest").textContent = String(await getMyBest("guess")); }catch{ $("gnBest").textContent="â€”"; }
        try{ $("smBest").textContent = String(await getMyBest("simon")); }catch{ $("smBest").textContent="â€”"; }

        startAllLeaderboards();
      } else {
        uid = null;
        $("authState").textContent = "Offline";
        $("playerName").textContent = "Guest";
        // Ø§Ø¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„
        showEntry("");
      }
    });

    // init UIs
    crSetUI();
    gnReset();
    smReset();

    // âœ… Language toggle text fix (EN = Play now)
    let lang = "ar";
    $("lang-toggle").addEventListener("click", () => {
      lang = (lang === "ar") ? "en" : "ar";
      document.documentElement.lang = lang;
      document.documentElement.dir  = (lang === "en") ? "ltr" : "rtl";
      $("hero-sub").textContent = (lang === "en")
        ? "Play now"
        : "Ø§Ù„Ø¹Ø¨ ÙˆØ®Ù„ÙŠ Ø§Ù„Ø´Ø¨Ø§Ø¨ ØªØ³ØªÙØ§Ø¯";
    });

  </script>
</body>
</html>
