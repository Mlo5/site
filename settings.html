<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - M L O 5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-dark:#020202; --yellow:#facc15; --white:#f9fafb; --muted:#9ca3af;
      --border: rgba(250,204,21,.45);
      --card-border: rgba(156,163,175,.35);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Tajawal",system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg-dark); color:var(--white);
      min-height:100vh; padding:18px;
      display:flex; justify-content:center;
    }
    .wrap{width:100%; max-width:900px;}
    .top-bar{
      display:flex; gap:10px; align-items:center; justify-content:flex-start;
      direction:ltr; margin-bottom:14px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 14px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.55);
      color:var(--white); text-decoration:none;
      cursor:pointer; user-select:none;
      transition:transform .15s ease, background .15s ease;
      font-weight:800; font-size:.9rem;
    }
    .pill:hover{transform:translateY(-1px); background:rgba(250,204,21,.12)}
    .lang-toggle{
      width:40px;height:40px;border-radius:999px;border:1px solid rgba(148,163,184,.7);
      background:radial-gradient(circle at top,#111,#020202);
      color:var(--yellow); cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:1rem;
    }
    .card{
      border:1px solid var(--card-border);
      background:linear-gradient(145deg,#020202,#050505);
      border-radius:18px;
      padding:16px;
      box-shadow:0 12px 30px rgba(0,0,0,.85);
      margin-bottom:14px;
    }
    .h1{
      font-family:"Poppins",system-ui,sans-serif;
      font-weight:800;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:var(--yellow);
      font-size:1.05rem;
      margin-bottom:10px;
      direction:ltr;
    }

    /* âœ… Profile mini header */
    .profile-head{
      display:flex; gap:14px; align-items:center; flex-wrap:wrap;
    }
    .avatar{
      width:64px;height:64px;border-radius:50%;
      overflow:hidden; border:2px solid rgba(250,204,21,.9);
      background:#000; flex:0 0 auto;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .u-title{font-weight:900;color:var(--yellow);font-size:1rem}
    .u-sub{color:var(--muted);font-size:.86rem;margin-top:4px;line-height:1.35}

    .row{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:12px 0;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .row:first-of-type{border-top:none}
    .row-left{min-width:0}
    .row-title{font-weight:900; font-size:.95rem}
    .row-desc{color:var(--muted); font-size:.85rem; margin-top:4px; line-height:1.4}

    /* Toggle */
    .toggle{ position:relative; width:52px; height:30px; flex:0 0 auto; }
    .toggle input{opacity:0; width:0; height:0}
    .slider{
      position:absolute; inset:0;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      cursor:pointer;
      transition:.2s ease;
    }
    .slider:before{
      content:"";
      position:absolute;
      width:22px; height:22px;
      left:4px; top:50%;
      transform:translateY(-50%);
      background:#111;
      border:2px solid rgba(250,204,21,.8);
      border-radius:999px;
      transition:.2s ease;
      box-shadow:0 8px 18px rgba(0,0,0,.65);
    }
    .toggle input:checked + .slider{
      background:rgba(250,204,21,.22);
      border-color:rgba(250,204,21,.55);
    }
    .toggle input:checked + .slider:before{
      left:26px;
      background:var(--yellow);
      border-color:#000;
    }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
    }
    .btn{
      border:none; cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:.92rem;
    }
    .btn-primary{background:var(--yellow); color:#111;}
    .btn-ghost{
      background:rgba(0,0,0,.55);
      color:var(--white);
      border:1px solid rgba(250,204,21,.35);
    }
    .msg{margin-top:10px; min-height:1.2em; color:var(--muted); font-size:.9rem;}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top-bar">
      <a class="pill" id="back-home" href="index.html">â¬…ï¸ <span id="back-home-txt">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
      <button class="lang-toggle" id="lang-toggle" title="Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">ğŸŒ</button>
      <button class="pill" id="logout-btn" type="button">â‹ <span id="logout-txt">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span></button>
    </div>

    <!-- âœ… mini profile header (shows everywhere) -->
    <div class="card">
      <div class="profile-head">
        <div class="avatar"><img id="avatar-img" src="me.jpg" alt="avatar" /></div>
        <div>
          <div class="u-title" id="u-name">...</div>
          <div class="u-sub" id="u-email">...</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="h1" id="page-title">SETTINGS</div>

      <div class="row">
        <div class="row-left">
          <div class="row-title" id="t-toast">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Toast)</div>
          <div class="row-desc" id="d-toast">Ø¥Ø¸Ù‡Ø§Ø± / Ø¥Ø®ÙØ§Ø¡ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©.</div>
        </div>
        <label class="toggle" aria-label="toast enabled">
          <input id="toastEnabled" type="checkbox" />
          <span class="slider"></span>
        </label>
      </div>

      <div class="row">
        <div class="row-left">
          <div class="row-title" id="t-sound">ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</div>
          <div class="row-desc" id="d-sound">ØªØ´ØºÙŠÙ„ / Ø¥ÙŠÙ‚Ø§Ù ØµÙˆØª toast.mp3 Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡.</div>
        </div>
        <label class="toggle" aria-label="toast sound">
          <input id="toastSound" type="checkbox" />
          <span class="slider"></span>
        </label>
      </div>

      <div class="row">
        <div class="row-left">
          <div class="row-title" id="t-motion">ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©</div>
          <div class="row-desc" id="d-motion">ØªØ®ÙÙŠÙ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ÙˆØ§Ù„Ø­Ø±ÙƒØ§Øª Ù„ØªØ¬Ø±Ø¨Ø© Ø£Ù‡Ø¯Ø£ ÙˆØ£Ø®Ù.</div>
        </div>
        <label class="toggle" aria-label="reduce motion">
          <input id="reduceMotion" type="checkbox" />
          <span class="slider"></span>
        </label>
      </div>

      <div class="actions">
        <button class="btn btn-primary" id="save-btn" type="button">Ø­ÙØ¸</button>
        <a class="btn btn-ghost" id="go-profile" href="profile.html" style="text-decoration:none;display:inline-flex;align-items:center;">
          ğŸ‘¤ <span id="go-profile-txt" style="margin-inline-start:8px;">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
        </a>
      </div>

      <div class="msg" id="msg"></div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBnxruqFdBHEHTSVXl-QK848lsGvwBBH9U",
      authDomain: "mlo5-users.firebaseapp.com",
      projectId: "mlo5-users",
      appId: "1:142086858806:web:64c50f3a8d6250a2049097"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- L10N ----------
    const l10n = {
      ar: {
        title: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - M L O 5",
        home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
        logout: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",
        page: "SETTINGS",
        toastT: "Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Toast)",
        toastD: "Ø¥Ø¸Ù‡Ø§Ø± / Ø¥Ø®ÙØ§Ø¡ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©.",
        soundT: "ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡",
        soundD: "ØªØ´ØºÙŠÙ„ / Ø¥ÙŠÙ‚Ø§Ù ØµÙˆØª toast.mp3 Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡.",
        motionT: "ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©",
        motionD: "ØªØ®ÙÙŠÙ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ÙˆØ§Ù„Ø­Ø±ÙƒØ§Øª Ù„ØªØ¬Ø±Ø¨Ø© Ø£Ù‡Ø¯Ø£ ÙˆØ£Ø®Ù.",
        save: "Ø­ÙØ¸",
        profile: "Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",
        loading: "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦",
        saved: "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.",
        err: "âŒ ØµØ§Ø± Ø®Ø·Ø£. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.",
        notSigned: "Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§."
      },
      en: {
        title: "Settings - M L O 5",
        home: "Home",
        logout: "Logout",
        page: "SETTINGS",
        toastT: "Toast",
        toastD: "Show / hide the subscribe toast at the bottom.",
        soundT: "Toast Sound",
        soundD: "Enable / disable toast.mp3 sound when the toast appears.",
        motionT: "Reduce Motion",
        motionD: "Reduce animations for a calmer, lighter experience.",
        save: "Save",
        profile: "Profile",
        loading: "Loadingâ€¦",
        saved: "âœ… Settings saved.",
        err: "âŒ Something went wrong. Try again.",
        notSigned: "Please sign in first."
      }
    };

    let currentLang = "ar";
    function applyLang(lang){
      currentLang = (lang === "en") ? "en" : "ar";
      const s = l10n[currentLang];

      document.title = s.title;
      document.documentElement.lang = currentLang === "en" ? "en" : "ar";
      document.documentElement.dir  = currentLang === "en" ? "ltr" : "rtl";

      document.getElementById("back-home-txt").textContent = s.home;
      document.getElementById("logout-txt").textContent = s.logout;
      document.getElementById("page-title").textContent = s.page;

      document.getElementById("t-toast").textContent = s.toastT;
      document.getElementById("d-toast").textContent = s.toastD;
      document.getElementById("t-sound").textContent = s.soundT;
      document.getElementById("d-sound").textContent = s.soundD;
      document.getElementById("t-motion").textContent = s.motionT;
      document.getElementById("d-motion").textContent = s.motionD;

      document.getElementById("save-btn").textContent = s.save;
      document.getElementById("go-profile-txt").textContent = s.profile;

      document.getElementById("lang-toggle").title = (currentLang === "en") ? "English" : "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";
    }

    // ---------- Firestore helpers ----------
    async function getSettings(uid){
      const ref = doc(db, "users", uid, "settings", "main");
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    async function saveSettings(uid, data){
      const ref = doc(db, "users", uid, "settings", "main");
      await setDoc(ref, { ...data, updatedAt: serverTimestamp() }, { merge: true });
    }

    async function getProfile(uid){
      // âœ… Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù„ÙŠ Ø¨Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
      const ref = doc(db, "users", uid, "profile", "main");
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    // ---------- UI ----------
    const msg = document.getElementById("msg");
    const toastEnabled = document.getElementById("toastEnabled");
    const toastSound = document.getElementById("toastSound");
    const reduceMotion = document.getElementById("reduceMotion");

    const saveBtn = document.getElementById("save-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const langToggle = document.getElementById("lang-toggle");

    // mini profile header
    const avatarImg = document.getElementById("avatar-img");
    const uName = document.getElementById("u-name");
    const uEmail = document.getElementById("u-email");

    function setMsg(text, ok=false){
      msg.style.color = ok ? "#22c55e" : "#9ca3af";
      msg.textContent = text || "";
    }

    let currentUid = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        applyLang("ar");
        setMsg(l10n[currentLang].notSigned);
        setTimeout(() => window.location.href = "login.html", 700);
        return;
      }

      currentUid = user.uid;

      // âœ… Ø§Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© ÙÙˆØ±Ø§Ù‹ (Ø«Ù… Ù†Ø¨Ø¯Ù‘Ù„Ù‡Ø§ Ù„Ùˆ ÙÙŠ Firestore)
      uName.textContent = (user.displayName || user.email || "User");
      uEmail.textContent = user.email || "";
      avatarImg.src = user.photoURL || "me.jpg";

      try{
        setMsg(l10n[currentLang].loading);

        // 1) Settings
        const s = await getSettings(user.uid);
        applyLang(s?.lang || "ar");

        toastEnabled.checked = (s?.toastEnabled ?? true);
        toastSound.checked   = (s?.toastSound ?? true);
        reduceMotion.checked = (s?.reduceMotion ?? false);

        // Ù„Ùˆ Ø£ÙˆÙ„ Ù…Ø±Ø©: Ø«Ø¨Ù‘Øª defaults Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
        if (!s) {
          await saveSettings(user.uid, {
            lang: currentLang,
            toastEnabled: true,
            toastSound: true,
            reduceMotion: false
          });
        }

        // 2) Profile (username + photoURL)
        const p = await getProfile(user.uid);
        const display = (p?.username || "").trim() || (user.displayName || user.email || "User");
        uName.textContent = display;

        if (p?.photoURL) avatarImg.src = p.photoURL;

        setMsg("");
      }catch(e){
        console.error(e);
        applyLang("ar");
        setMsg(l10n[currentLang].err);
      }
    });

    // ğŸŒ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© + Ø­ÙØ¸ Firestore
    langToggle.addEventListener("click", async () => {
      const next = (currentLang === "ar") ? "en" : "ar";
      applyLang(next);
      if (!currentUid) return;

      try{
        await saveSettings(currentUid, { lang: next });
      }catch(e){
        console.error(e);
      }
    });

    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    saveBtn.addEventListener("click", async () => {
      if (!currentUid) return;
      try{
        setMsg(l10n[currentLang].loading);
        await saveSettings(currentUid, {
          lang: currentLang,
          toastEnabled: !!toastEnabled.checked,
          toastSound: !!toastSound.checked,
          reduceMotion: !!reduceMotion.checked
        });
        setMsg(l10n[currentLang].saved, true);
      }catch(e){
        console.error(e);
        setMsg(l10n[currentLang].err);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
